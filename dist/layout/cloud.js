"use strict";!function(t,n){if("function"==typeof define&&define.amd)define(["exports","../utils/dispatch"],n);else if("undefined"!=typeof exports)n(exports,require("../utils/dispatch"));else{var e={};n(e,t.dispatch),t.undefined=e}}(void 0,function(t,n){Object.defineProperty(t,"__esModule",{value:!0});var e,r=(e=n)&&e.__esModule?e:{default:e};var q=Math.PI/180,D=64,S=2048;function a(t){return t.text}function i(){return"serif"}function o(){return"normal"}function u(t){return Math.sqrt(t.value)}function f(){return 30*(~~(6*Math.random())-3)}function b(){return 1}function z(t,n,e,r){if(!n.sprite){var a=t.context,i=t.ratio;a.clearRect(0,0,(D<<5)/i,S/i);var o=0,u=0,f=0,l=e.length;for(--r;++r<l;){n=e[r],a.save(),a.font=n.style+" "+n.weight+" "+~~((n.size+1)/i)+"px "+n.font;var c=a.measureText(n.text+"m").width*i,s=n.size<<1;if(n.rotate){var h=Math.sin(n.rotate*q),x=Math.cos(n.rotate*q),y=c*x,d=c*h,v=s*x,g=s*h;c=Math.max(Math.abs(y+g),Math.abs(y-g))+31>>5<<5,s=~~Math.max(Math.abs(d+v),Math.abs(d-v))}else c=c+31>>5<<5;if(f<s&&(f=s),D<<5<=o+c&&(u+=f,f=o=0),S<=u+s)break;a.translate((o+(c>>1))/i,(u+(s>>1))/i),n.rotate&&a.rotate(n.rotate*q),a.fillText(n.text,0,0),n.padding&&(a.lineWidth=2*n.padding,a.strokeText(n.text,0,0)),a.restore(),n.width=c,n.height=s,n.xoff=o,n.yoff=u,n.x1=c>>1,n.y1=s>>1,n.x0=-n.x1,n.y0=-n.y1,n.hasText=!0,o+=c}for(var p=a.getImageData(0,0,(D<<5)/i,S/i).data,M=[];0<=--r;)if((n=e[r]).hasText){for(var m=(c=n.width)>>5,w=(s=n.y1-n.y0,0);w<s*m;w++)M[w]=0;if(null==(o=n.xoff))return;u=n.yoff;for(var b=0,z=-1,I=0;I<s;I++){for(w=0;w<c;w++){var k=m*I+(w>>5),T=p[(u+I)*(D<<5)+(o+w)<<2]?1<<31-w%32:0;M[k]|=T,b|=T}b?z=I:(n.y0++,s--,I--,u++)}n.y1=n.y0+z,n.sprite=M.slice(0,(n.y1-n.y0)*m)}}}function _(t,n,e){e>>=5;for(var r,a=t.sprite,i=t.width>>5,o=t.x-(i<<4),u=127&o,f=32-u,l=t.y1-t.y0,c=(t.y+t.y0)*e+(o>>5),s=0;s<l;s++){for(var h=r=0;h<=i;h++)if((r<<f|(h<i?(r=a[s*i+h])>>>u:0))&n[c+h])return!0;c+=e}return!1}function I(t,n){var e=t[0],r=t[1];n.x+n.x0<e.x&&(e.x=n.x+n.x0),n.y+n.y0<e.y&&(e.y=n.y+n.y0),n.x+n.x1>r.x&&(r.x=n.x+n.x1),n.y+n.y1>r.y&&(r.y=n.y+n.y1)}function C(t){var n=t[0]/t[1];return function(t){return[n*(t*=.1)*Math.cos(t),t*Math.sin(t)]}}function P(){return document.createElement("canvas")}function W(t){return"function"==typeof t?t:function(){return t}}var j={archimedean:C,rectangular:function(t){var e=4*t[0]/t[1],r=0,a=0;return function(t){var n=t<0?-1:1;switch(Math.sqrt(1+4*n*t)-n&3){case 0:r+=e;break;case 1:a+=4;break;case 2:r-=e;break;default:a-=4}return[r,a]}}};t.default=function(){var k=[256,256],l=a,c=i,s=u,h=o,x=o,y=f,d=b,T=C,n=[],v=1/0,g=(0,r.default)("word","end"),p=null,q=Math.random,M={},m=P;function w(t,n,e){k[0],k[1];for(var r,a,i,o,u,f=n.x,l=n.y,c=Math.sqrt(k[0]*k[0]+k[1]*k[1]),s=T(k),h=q()<.5?1:-1,x=-h;(r=s(x+=h))&&(a=~~r[0],i=~~r[1],!(Math.min(Math.abs(a),Math.abs(i))>=c));)if(n.x=f+a,n.y=l+i,!(n.x+n.x0<0||n.y+n.y0<0||n.x+n.x1>k[0]||n.y+n.y1>k[1]||e&&_(n,t,k[0])||e&&(u=e,!((o=n).x+o.x1>u[0].x&&o.x+o.x0<u[1].x&&o.y+o.y1>u[0].y&&o.y+o.y0<u[1].y)))){for(var y,d=n.sprite,v=n.width>>5,g=k[0]>>5,p=n.x-(v<<4),M=127&p,m=32-M,w=n.y1-n.y0,b=(n.y+n.y0)*g+(p>>5),z=0;z<w;z++){for(var I=y=0;I<=v;I++)t[b+I]|=y<<m|(I<v?(y=d[z*v+I])>>>M:0);b+=g}return delete n.sprite,!0}return!1}return M.canvas=function(t){return arguments.length?(m=W(t),M):m},M.start=function(){var e=function(t){t.width=t.height=1;var n=Math.sqrt(t.getContext("2d").getImageData(0,0,1,1).data.length>>2);t.width=(D<<5)/n,t.height=S/n;var e=t.getContext("2d");return e.fillStyle=e.strokeStyle="red",e.textAlign="center",{context:e,ratio:n}}(m()),r=function(t){var n=[],e=-1;for(;++e<t;)n[e]=0;return n}((k[0]>>5)*k[1]),a=null,i=n.length,o=-1,u=[],f=n.map(function(t,n){return t.text=l.call(this,t,n),t.font=c.call(this,t,n),t.style=h.call(this,t,n),t.weight=x.call(this,t,n),t.rotate=y.call(this,t,n),t.size=~~s.call(this,t,n),t.padding=d.call(this,t,n),t}).sort(function(t,n){return n.size-t.size});return p&&clearInterval(p),p=setInterval(t,0),t(),M;function t(){for(var t=Date.now();Date.now()-t<v&&++o<i&&p;){var n=f[o];n.x=k[0]*(q()+.5)>>1,n.y=k[1]*(q()+.5)>>1,z(e,n,f,o),n.hasText&&w(r,n,a)&&(u.push(n),g.call("word",M,n),a?I(a,n):a=[{x:n.x+n.x0,y:n.y+n.y0},{x:n.x+n.x1,y:n.y+n.y1}],n.x-=k[0]>>1,n.y-=k[1]>>1)}i<=o&&(M.stop(),g.call("end",M,u,a))}},M.stop=function(){return p&&(clearInterval(p),p=null),M},M.timeInterval=function(t){return arguments.length?(v=null==t?1/0:t,M):v},M.words=function(t){return arguments.length?(n=t,M):n},M.size=function(t){return arguments.length?(k=[+t[0],+t[1]],M):k},M.font=function(t){return arguments.length?(c=W(t),M):c},M.fontStyle=function(t){return arguments.length?(h=W(t),M):h},M.fontWeight=function(t){return arguments.length?(x=W(t),M):x},M.rotate=function(t){return arguments.length?(y=W(t),M):y},M.text=function(t){return arguments.length?(l=W(t),M):l},M.spiral=function(t){return arguments.length?(T=j[t]||t,M):T},M.fontSize=function(t){return arguments.length?(s=W(t),M):s},M.padding=function(t){return arguments.length?(d=W(t),M):d},M.random=function(t){return arguments.length?(q=t,M):q},M.on=function(){var t=g.on.apply(g,arguments);return t===g?M:t},M}});