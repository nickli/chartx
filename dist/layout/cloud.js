"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _dispatch=_interopRequireDefault(require("../utils/dispatch")),cloudRadians=Math.PI/180,cw=64,ch=2048,cloud=function(){var S=[256,256],c=cloudText,f=cloudFont,d=cloudFontSize,s=cloudFontNormal,h=cloudFontNormal,x=cloudRotate,y=cloudPadding,R=archimedeanSpiral,r=[],v=1/0,g=(0,_dispatch.default)("word","end"),p=null,z=Math.random,m={},w=cloudCanvas;function M(t,r,e){S[0],S[1];for(var n,a,o,u=r.x,i=r.y,l=Math.sqrt(S[0]*S[0]+S[1]*S[1]),c=R(S),f=z()<.5?1:-1,d=-f;(n=c(d+=f))&&(a=~~n[0],o=~~n[1],!(Math.min(Math.abs(a),Math.abs(o))>=l));)if(r.x=u+a,r.y=i+o,!(r.x+r.x0<0||r.y+r.y0<0||r.x+r.x1>S[0]||r.y+r.y1>S[1])&&(!e||!cloudCollide(r,t,S[0]))&&(!e||collideRects(r,e))){for(var s,h=r.sprite,x=r.width>>5,y=S[0]>>5,v=r.x-(x<<4),g=127&v,p=32-g,m=r.y1-r.y0,w=(r.y+r.y0)*y+(v>>5),M=0;M<m;M++){for(var b=s=0;b<=x;b++)t[w+b]|=s<<p|(b<x?(s=h[M*x+b])>>>g:0);w+=y}return delete r.sprite,!0}return!1}return m.canvas=function(t){return arguments.length?(w=functor(t),m):w},m.start=function(){var e=function(t){t.width=t.height=1;var r=Math.sqrt(t.getContext("2d").getImageData(0,0,1,1).data.length>>2);t.width=(cw<<5)/r,t.height=ch/r;var e=t.getContext("2d");return e.fillStyle=e.strokeStyle="red",e.textAlign="center",{context:e,ratio:r}}(w()),n=zeroArray((S[0]>>5)*S[1]),a=null,o=r.length,u=-1,i=[],l=r.map(function(t,r){return t.text=c.call(this,t,r),t.font=f.call(this,t,r),t.style=s.call(this,t,r),t.weight=h.call(this,t,r),t.rotate=x.call(this,t,r),t.size=~~d.call(this,t,r),t.padding=y.call(this,t,r),t}).sort(function(t,r){return r.size-t.size});return p&&clearInterval(p),p=setInterval(t,0),t(),m;function t(){for(var t=Date.now();Date.now()-t<v&&++u<o&&p;){var r=l[u];r.x=S[0]*(z()+.5)>>1,r.y=S[1]*(z()+.5)>>1,cloudSprite(e,r,l,u),r.hasText&&M(n,r,a)&&(i.push(r),g.call("word",m,r),a?cloudBounds(a,r):a=[{x:r.x+r.x0,y:r.y+r.y0},{x:r.x+r.x1,y:r.y+r.y1}],r.x-=S[0]>>1,r.y-=S[1]>>1)}o<=u&&(m.stop(),g.call("end",m,i,a))}},m.stop=function(){return p&&(clearInterval(p),p=null),m},m.timeInterval=function(t){return arguments.length?(v=null==t?1/0:t,m):v},m.words=function(t){return arguments.length?(r=t,m):r},m.size=function(t){return arguments.length?(S=[+t[0],+t[1]],m):S},m.font=function(t){return arguments.length?(f=functor(t),m):f},m.fontStyle=function(t){return arguments.length?(s=functor(t),m):s},m.fontWeight=function(t){return arguments.length?(h=functor(t),m):h},m.rotate=function(t){return arguments.length?(x=functor(t),m):x},m.text=function(t){return arguments.length?(c=functor(t),m):c},m.spiral=function(t){return arguments.length?(R=spirals[t]||t,m):R},m.fontSize=function(t){return arguments.length?(d=functor(t),m):d},m.padding=function(t){return arguments.length?(y=functor(t),m):y},m.random=function(t){return arguments.length?(z=t,m):z},m.on=function(){var t=g.on.apply(g,arguments);return t===g?m:t},m};function cloudText(t){return t.text}function cloudFont(){return"serif"}function cloudFontNormal(){return"normal"}function cloudFontSize(t){return Math.sqrt(t.value)}function cloudRotate(){return 30*(~~(6*Math.random())-3)}function cloudPadding(){return 1}function cloudSprite(t,r,e,n){if(!r.sprite){var a=t.context,o=t.ratio;a.clearRect(0,0,(cw<<5)/o,ch/o);var u=0,i=0,l=0,c=e.length;for(--n;++n<c;){r=e[n],a.save(),a.font=r.style+" "+r.weight+" "+~~((r.size+1)/o)+"px "+r.font;var f=a.measureText(r.text+"m").width*o,d=r.size<<1;if(r.rotate){var s=Math.sin(r.rotate*cloudRadians),h=Math.cos(r.rotate*cloudRadians),x=f*h,y=f*s,v=d*h,g=d*s;f=Math.max(Math.abs(x+g),Math.abs(x-g))+31>>5<<5,d=~~Math.max(Math.abs(y+v),Math.abs(y-v))}else f=f+31>>5<<5;if(l<d&&(l=d),cw<<5<=u+f&&(i+=l,l=u=0),ch<=i+d)break;a.translate((u+(f>>1))/o,(i+(d>>1))/o),r.rotate&&a.rotate(r.rotate*cloudRadians),a.fillText(r.text,0,0),r.padding&&(a.lineWidth=2*r.padding,a.strokeText(r.text,0,0)),a.restore(),r.width=f,r.height=d,r.xoff=u,r.yoff=i,r.x1=f>>1,r.y1=d>>1,r.x0=-r.x1,r.y0=-r.y1,r.hasText=!0,u+=f}for(var p=a.getImageData(0,0,(cw<<5)/o,ch/o).data,m=[];0<=--n;)if((r=e[n]).hasText){for(var w=(f=r.width)>>5,M=(d=r.y1-r.y0,0);M<d*w;M++)m[M]=0;if(null==(u=r.xoff))return;i=r.yoff;for(var b=0,S=-1,R=0;R<d;R++){for(M=0;M<f;M++){var z=w*R+(M>>5),q=p[(i+R)*(cw<<5)+(u+M)<<2]?1<<31-M%32:0;m[z]|=q,b|=q}b?S=R:(r.y0++,d--,R--,i++)}r.y1=r.y0+S,r.sprite=m.slice(0,(r.y1-r.y0)*w)}}}function cloudCollide(t,r,e){e>>=5;for(var n,a=t.sprite,o=t.width>>5,u=t.x-(o<<4),i=127&u,l=32-i,c=t.y1-t.y0,f=(t.y+t.y0)*e+(u>>5),d=0;d<c;d++){for(var s=n=0;s<=o;s++)if((n<<l|(s<o?(n=a[d*o+s])>>>i:0))&r[f+s])return!0;f+=e}return!1}function cloudBounds(t,r){var e=t[0],n=t[1];r.x+r.x0<e.x&&(e.x=r.x+r.x0),r.y+r.y0<e.y&&(e.y=r.y+r.y0),r.x+r.x1>n.x&&(n.x=r.x+r.x1),r.y+r.y1>n.y&&(n.y=r.y+r.y1)}function collideRects(t,r){return t.x+t.x1>r[0].x&&t.x+t.x0<r[1].x&&t.y+t.y1>r[0].y&&t.y+t.y0<r[1].y}function archimedeanSpiral(t){var r=t[0]/t[1];return function(t){return[r*(t*=.1)*Math.cos(t),t*Math.sin(t)]}}function rectangularSpiral(t){var e=4*t[0]/t[1],n=0,a=0;return function(t){var r=t<0?-1:1;switch(Math.sqrt(1+4*r*t)-r&3){case 0:n+=e;break;case 1:a+=4;break;case 2:n-=e;break;default:a-=4}return[n,a]}}function zeroArray(t){for(var r=[],e=-1;++e<t;)r[e]=0;return r}function cloudCanvas(){return document.createElement("canvas")}function functor(t){return"function"==typeof t?t:function(){return t}}var spirals={archimedean:archimedeanSpiral,rectangular:rectangularSpiral},_default=cloud;exports.default=_default;