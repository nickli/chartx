"use strict";!function(n,e){if("function"==typeof define&&define.amd)define(["exports","fmin","./circleintersection"],e);else if("undefined"!=typeof exports)e(exports,require("fmin"),require("./circleintersection"));else{var t={};e(t,n.fmin,n.circleintersection),n.undefined=t}}(void 0,function(n,d,S){Object.defineProperty(n,"__esModule",{value:!0}),n.venn=function(a,n){(n=n||{}).maxIterations=n.maxIterations||500;var e=n.initialLayout||f,i=n.lossFunction||D;a=function(n){n=n.slice();var e,t,r,a,i=[],s={};for(e=0;e<n.length;++e){var o=n[e];1==o.sets.length?i.push(o.sets[0]):2==o.sets.length&&(r=o.sets[0],a=o.sets[1],s[[r,a]]=!0,s[[a,r]]=!0)}for(i.sort(function(n,e){return e<n}),e=0;e<i.length;++e)for(r=i[e],t=e+1;t<i.length;++t)a=i[t],[r,a]in s||n.push({sets:[r,a],size:0});return n}(a);var t,s=e(a,n),r=[],o=[];for(t in s)s.hasOwnProperty(t)&&(r.push(s[t].x),r.push(s[t].y),o.push(t));for(var u=(0,d.nelderMead)(function(n){1;for(var e={},t=0;t<o.length;++t){var r=o[t];e[r]={x:n[2*t],y:n[2*t+1],radius:s[r].radius}}return i(e,a)},r,n).x,h=0;h<o.length;++h)t=o[h],s[t].x=u[2*h],s[t].y=u[2*h+1];return s},n.distanceFromIntersectArea=C,n.getDistanceMatrices=p,n.bestInitialLayout=f,n.constrainedMDSLayout=i,n.greedyLayout=s,n.lossFunction=D,n.disjointCluster=v,n.normalizeSolution=function(n,e,t){null===e&&(e=Math.PI/2);var r,a,u=[];for(a in n)if(n.hasOwnProperty(a)){var i=n[a];u.push({x:i.x,y:i.y,radius:i.radius,setid:a})}var s=v(u);for(r=0;r<s.length;++r){x(s[r],e,t);var o=z(s[r]);s[r].size=(o.xRange.max-o.xRange.min)*(o.yRange.max-o.yRange.min),s[r].bounds=o}s.sort(function(n,e){return e.size-n.size});var h=(u=s[0]).bounds,f=(h.xRange.max-h.xRange.min)/50;function l(n,e,t){if(n){var r,a,i,s=n.bounds;e?r=h.xRange.max-s.xRange.min+f:(r=h.xRange.max-s.xRange.max,(i=(s.xRange.max-s.xRange.min)/2-(h.xRange.max-h.xRange.min)/2)<0&&(r+=i)),t?a=h.yRange.max-s.yRange.min+f:(a=h.yRange.max-s.yRange.max,(i=(s.yRange.max-s.yRange.min)/2-(h.yRange.max-h.yRange.min)/2)<0&&(a+=i));for(var o=0;o<n.length;++o)n[o].x+=r,n[o].y+=a,u.push(n[o])}}var g=1;for(;g<s.length;)l(s[g],!0,!1),l(s[g+1],!1,!0),l(s[g+2],!0,!0),g+=3,h=z(u);var c={};for(r=0;r<u.length;++r)c[u[r].setid]=u[r];return c},n.scaleSolution=function(n,e,t,r){var a=[],i=[];for(var s in n)n.hasOwnProperty(s)&&(i.push(s),a.push(n[s]));e-=2*r,t-=2*r;var o=z(a),u=o.xRange,h=o.yRange;if(u.max==u.min||h.max==h.min)return console.log("not scaling solution: zero size detected"),n;for(var f=e/(u.max-u.min),l=t/(h.max-h.min),g=Math.min(l,f),c=(e-(u.max-u.min)*g)/2,x=(t-(h.max-h.min)*g)/2,v={},y=0;y<a.length;++y){var m=a[y];v[i[y]]={radius:g*m.radius,x:r+c+(m.x-u.min)*g,y:r+x+(m.y-h.min)*g}}return v};var A=1e-10;function C(e,t,r){return Math.min(e,t)*Math.min(e,t)*Math.PI<=r+A?Math.abs(e-t):(0,d.bisect)(function(n){return(0,S.circleOverlap)(e,t,n)-r},0,e+t)}function p(n,i,s){var o=(0,d.zerosM)(i.length,i.length),u=(0,d.zerosM)(i.length,i.length);return n.filter(function(n){return 2==n.sets.length}).map(function(n){var e=s[n.sets[0]],t=s[n.sets[1]],r=C(Math.sqrt(i[e].size/Math.PI),Math.sqrt(i[t].size/Math.PI),n.size);o[e][t]=o[t][e]=r;var a=0;n.size+1e-10>=Math.min(i[e].size,i[t].size)?a=1:n.size<=1e-10&&(a=-1),u[e][t]=u[t][e]=a}),{distances:o,constraints:u}}function f(n,e){var t=s(n,e),r=e.lossFunction||D;if(8<=n.length){var a=i(n,e);r(a,n)+1e-8<r(t,n)&&(t=a)}return t}function i(n,e){var t,r=(e=e||{}).restarts||10,a=[],i={};for(t=0;t<n.length;++t){var s=n[t];1==s.sets.length&&(i[s.sets[0]]=a.length,a.push(s))}var o=p(n,a,i),u=o.distances,h=o.constraints,f=(0,d.norm2)(u.map(d.norm2))/u.length;u=u.map(function(n){return n.map(function(n){return n/f})});function l(n,e){return function(n,e,t,r){var a,i=0;for(a=0;a<e.length;++a)e[a]=0;for(a=0;a<t.length;++a)for(var s=n[2*a],o=n[2*a+1],u=a+1;u<t.length;++u){var h=n[2*u],f=n[2*u+1],l=t[a][u],g=r[a][u],c=(h-s)*(h-s)+(f-o)*(f-o),x=Math.sqrt(c),v=c-l*l;0<g&&x<=l||g<0&&l<=x||(i+=2*v*v,e[2*a]+=4*v*(s-h),e[2*a+1]+=4*v*(o-f),e[2*u]+=4*v*(h-s),e[2*u+1]+=4*v*(f-o))}return i}(n,e,u,h)}var g,c;for(t=0;t<r;++t){var x=(0,d.zeros)(2*u.length).map(Math.random);c=(0,d.conjugateGradient)(l,x,e),(!g||c.fx<g.fx)&&(g=c)}var v=g.x,y={};for(t=0;t<a.length;++t){var m=a[t];y[m.sets[0]]={x:v[2*t]*f,y:v[2*t+1]*f,radius:Math.sqrt(m.size/Math.PI)}}if(e.history)for(t=0;t<e.history.length;++t)(0,d.scale)(e.history[t].x,f);return y}function s(n,e){for(var t,r=e&&e.lossFunction?e.lossFunction:D,a={},i={},s=0;s<n.length;++s){var o=n[s];1==o.sets.length&&(t=o.sets[0],a[t]={x:1e10,y:1e10,rowid:a.length,size:o.size,radius:Math.sqrt(o.size/Math.PI)},i[t]=[])}for(n=n.filter(function(n){return 2==n.sets.length}),s=0;s<n.length;++s){var u=n[s],h=u.hasOwnProperty("weight")?u.weight:1,f=u.sets[0],l=u.sets[1];u.size+A>=Math.min(a[f].size,a[l].size)&&(h=0),i[f].push({set:l,size:u.size,weight:h}),i[l].push({set:f,size:u.size,weight:h})}var g=[];for(t in i)if(i.hasOwnProperty(t)){var c=0;for(s=0;s<i[t].length;++s)c+=i[t][s].size*i[t][s].weight;g.push({set:t,size:c})}function x(n,e){return e.size-n.size}g.sort(x);var v={};function y(n){return n.set in v}function m(n,e){a[e].x=n.x,a[e].y=n.y,v[e]=!0}for(m({x:0,y:0},g[0].set),s=1;s<g.length;++s){var d=g[s].set,p=i[d].filter(y);if(t=a[d],p.sort(x),0===p.length)throw"ERROR: missing pairwise overlap information";for(var z=[],M=0;M<p.length;++M){var R=a[p[M].set],P=C(t.radius,R.radius,p[M].size);z.push({x:R.x+P,y:R.y}),z.push({x:R.x-P,y:R.y}),z.push({y:R.y+P,x:R.x}),z.push({y:R.y-P,x:R.x});for(var w=M+1;w<p.length;++w)for(var I=a[p[w].set],O=C(t.radius,I.radius,p[w].size),b=(0,S.circleCircleIntersection)({x:R.x,y:R.y,radius:P},{x:I.x,y:I.y,radius:O}),q=0;q<b.length;++q)z.push(b[q])}var F=1e50,L=z[0];for(M=0;M<z.length;++M){a[d].x=z[M].x,a[d].y=z[M].y;var j=r(a,n);j<F&&(F=j,L=z[M])}m(L,d)}return a}function D(e,n){var t=0;for(var r=0;r<n.length;++r){var a,i=n[r];if(1!=i.sets.length){if(2==i.sets.length){var s=e[i.sets[0]],o=e[i.sets[1]];a=(0,S.circleOverlap)(s.radius,o.radius,(0,S.distance)(s,o))}else a=(0,S.intersectionArea)(i.sets.map(function(n){return e[n]}));t+=(i.hasOwnProperty("weight")?i.weight:1)*(a-i.size)*(a-i.size)}}return t}function x(n,e,t){var r;if(null===t?n.sort(function(n,e){return e.radius-n.radius}):n.sort(t),0<n.length){var a=n[0].x,i=n[0].y;for(r=0;r<n.length;++r)n[r].x-=a,n[r].y-=i}2==n.length&&(0,S.distance)(n[0],n[1])<Math.abs(n[1].radius-n[0].radius)&&(n[1].x=n[0].x+n[0].radius-n[1].radius-1e-10,n[1].y=n[0].y);if(1<n.length){var s,o,u=Math.atan2(n[1].x,n[1].y)-e,h=Math.cos(u),f=Math.sin(u);for(r=0;r<n.length;++r)s=n[r].x,o=n[r].y,n[r].x=h*s-f*o,n[r].y=f*s+h*o}if(2<n.length){for(var l=Math.atan2(n[2].x,n[2].y)-e;l<0;)l+=2*Math.PI;for(;l>2*Math.PI;)l-=2*Math.PI;if(l>Math.PI){var g=n[1].y/(1e-10+n[1].x);for(r=0;r<n.length;++r){var c=(n[r].x+g*n[r].y)/(1+g*g);n[r].x=2*c-n[r].x,n[r].y=2*c*g-n[r].y}}}}function v(n){function e(n){return n.parent!==n&&(n.parent=e(n.parent)),n.parent}n.map(function(n){n.parent=n});for(var t=0;t<n.length;++t)for(var r=t+1;r<n.length;++r){var a=n[t].radius+n[r].radius;(0,S.distance)(n[t],n[r])+1e-10<a&&(i=n[r],s=n[t],o=void 0,o=e(i),u=e(s),o.parent=u)}var i,s,o,u,h,f={};for(t=0;t<n.length;++t)(h=e(n[t]).parent.setid)in f||(f[h]=[]),f[h].push(n[t]);n.map(function(n){delete n.parent});var l=[];for(h in f)f.hasOwnProperty(h)&&l.push(f[h]);return l}function z(n){function e(e){return{max:Math.max.apply(null,n.map(function(n){return n[e]+n.radius})),min:Math.min.apply(null,n.map(function(n){return n[e]-n.radius}))}}return{xRange:e("x"),yRange:e("y")}}});