"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_canvax=_interopRequireDefault(require("canvax")),_mmvis=require("mmvis"),_padding=20,Chart=function(t){function o(t,e,i,n){var a;return(0,_classCallCheck2.default)(this,o),(a=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(o).call(this))).componentModules=n,a._node=t,a._data=e,a._opt=i,a.dataFrame=a.initData(e,i),a.el=_mmvis.$.query(t),a.width=parseInt(a.el.offsetWidth),a.height=parseInt(a.el.offsetHeight),a.padding=null,a.canvax=new _canvax.default.App({el:a.el,webGL:!1}),a.canvax.registEvent(),a.id="chartx_"+a.canvax.id,a.el.setAttribute("chart_id",a.id),a.el.setAttribute("chartx_version","2.0"),a.stage=new _canvax.default.Display.Stage({id:"main-chart-stage"}),a.canvax.addChild(a.stage),a.setCoord_Graphs_Sp(),a.__highModules=["theme","coord","graphs"],a.components=[],a.inited=!1,a.init(),a}return(0,_inherits2.default)(o,t),(0,_createClass2.default)(o,[{key:"init",value:function(){var a=this,e=this._opt;for(var n in this.padding=this._getPadding(),_mmvis._.each(this.__highModules,function(n){if(e[n]){var t=_mmvis._.flatten([e[n]]);"theme"==n&&(t=[t]),_mmvis._.each(t,function(t){if(("coord"!=n||t.type)&&("graphs"!=n||t.field||t.keyField)){var e=a.componentModules.get(n,t.type);if(e){var i=new e(t,a);a.components.push(i)}}})}}),this._opt)if(-1==_mmvis._.indexOf(this.__highModules,n)){var t=this._opt[n];_mmvis._.isArray(t)||(t=[t]),_mmvis._.each(t,function(t){var e=a.componentModules.get(n,t.type);if(e){var i=new e(t,a);a.components.push(i)}})}}},{key:"draw",value:function(t){var i=this;t=t||{};var e=this.getComponent({name:"coord"});e&&e.horizontal&&this._drawBeginHorizontal();var n=this.width-this.padding.left-this.padding.right,a=this.height-this.padding.top-this.padding.bottom,o={x:this.padding.left,y:this.padding.top};if(e&&(e.draw(t),n=e.width,a=e.height,o=e.origin),0!=this.dataFrame.length){var s=this.getComponents({name:"graphs"}),r=s.length,h=0;t=_mmvis._.extend(t,{width:n,height:a,origin:o}),_mmvis._.each(s,function(e){e.on("complete",function(t){++h==r&&i.fire("complete"),e.inited=!0}),e.draw(t)});for(var d=0,l=this.components.length;d<l;d++){var p=this.components[d];-1==_mmvis._.indexOf(this.__highModules,p.name)&&p.draw(t)}this._bindEvent(),e&&e.horizontal&&this._drawEndHorizontal()}else i.fire("complete")}},{key:"_drawBeginHorizontal",value:function(){var t=this.padding,e=t.top;t.top=t.right,t.right=t.bottom,t.bottom=t.left,t.left=e}},{key:"_drawEndHorizontal",value:function(){var t=this.graphsSprite.context;t.x+=(this.width-this.height)/2,t.y+=(this.height-this.width)/2,t.rotation=90,t.rotateOrigin={x:this.height/2,y:this.width/2},this._horizontalGraphsText()}},{key:"_horizontalGraphsText",value:function(){_mmvis._.each(this.getComponents({name:"graphs"}),function(t){!function e(t){if(t.children&&_mmvis._.each(t.children,function(t){e(t)}),"text"==t.type&&!t.__horizontal){var i=t.context;i.width,i.height,i.rotation=i.rotation-90,t.__horizontal=!0}}(t.sprite)})}},{key:"_getPadding",value:function(){var t=_padding;this._opt.coord&&"padding"in this._opt.coord&&(_mmvis._.isObject(this._opt.coord.padding)||(t=this._opt.coord.padding));var e={top:t,right:t,bottom:t,left:t};return this._opt.coord&&"padding"in this._opt.coord&&_mmvis._.isObject(this._opt.coord.padding)&&(e=_mmvis._.extend(e,this._opt.coord.padding)),e}},{key:"getTheme",value:function(t){var e=_mmvis.global.getGlobalTheme(),i=this.getComponent({name:"theme"});return i&&(e=i.get()),null!=t?e[t%e.length]||"#ccc":e}},{key:"setCoord_Graphs_Sp",value:function(){this.coordSprite=new _canvax.default.Display.Sprite({id:"coordSprite"}),this.stage.addChild(this.coordSprite),this.graphsSprite=new _canvax.default.Display.Sprite({id:"graphsSprite"}),this.stage.addChild(this.graphsSprite)}},{key:"destroy",value:function(){this.clean(),this.el&&(this.el.removeAttribute("chart_id"),this.el.removeAttribute("chartx_version"),this.canvax.destroy(),this.el=null),this._destroy&&this._destroy(),this.fire("destroy")}},{key:"clean",value:function(){for(var t=0,e=this.canvax.children.length;t<e;t++)for(var i=this.canvax.getChildAt(t),n=0,a=i.children.length;n<a;n++)i.getChildAt(n).destroy(),n--,a--;this.setCoord_Graphs_Sp(),this.components=[],this.canvax.domView.innerHTML=""}},{key:"resize",value:function(){var t=parseInt(this.el.offsetWidth),e=parseInt(this.el.offsetHeight);t==this.width&&e==this.height||(this.width=t,this.height=e,this.canvax.resize(),this.inited=!1,this.clean(),this.init(),this.draw({resize:!0}),this.inited=!0)}},{key:"reset",value:function(t,e){t&&(this._opt=t),e&&(this._data=e),this.dataFrame=this.initData(this._data,t),this.clean(),this.init(),this.draw()}},{key:"resetData",value:function(t,e){var i=this;this._data=t;var n=this.dataFrame.org.length;if(this.dataFrame.resetData(t),!n)return this.clean(),this.init(),void this.draw(this._opt);var a=this.getComponent({name:"coord"});a&&a.resetData(this.dataFrame,e),_mmvis._.each(this.getComponents({name:"graphs"}),function(t){t.resetData(i.dataFrame,e)}),this.componentsReset(e),a&&a.horizontal&&this._horizontalGraphsText(),this.fire("resetData")}},{key:"initData",value:function(){return _mmvis.dataFrame.apply(this,arguments)}},{key:"componentsReset",value:function(i){var n=this;_mmvis._.each(this.components,function(t,e){-1==_mmvis._.indexOf(n.__highModules,t.name)&&(i&&i.comp&&i.comp.__cid==t.__cid||t.reset&&t.reset(n[t.type]||{},n.dataFrame))})}},{key:"getComponentById",value:function(e){var i;return _mmvis._.each(this.components,function(t){if(t.id&&t.id==e)return i=t,!1}),i}},{key:"getComponent",value:function(t){return this.getComponents(t)[0]}},{key:"getComponents",value:function(n,t){var a=[],o=0;for(var e in t=t||this.components,n)o++;return o?(_mmvis._.each(t,function(t){var e=0;for(var i in n)JSON.stringify(t[i])==JSON.stringify(n[i])&&e++;o==e&&a.push(t)}),a):t}},{key:"getGraph",value:function(t){return this.getGraphs(t)[0]}},{key:"getGraphs",value:function(t){return this.getComponents(t,this.getComponents({name:"graphs"}))}},{key:"getGraphById",value:function(e){var i;return _mmvis._.each(this.getComponents({name:"graphs"}),function(t){if(t.id==e)return i=t,!1}),i}},{key:"getCoord",value:function(t){return this.getComponent(_mmvis._.extend(!0,{name:"coord"},t))}},{key:"getLegendData",value:function(){var n=this,a=[];if(_mmvis._.each(this.getComponents({name:"graphs"}),function(t){_mmvis._.each(t.getLegendData(),function(e){if(!_mmvis._.find(a,function(t){return t.name==e.name})){var t=_mmvis._.extend(!0,{},e);t.color=e.fillStyle||e.color||e.style,a.push(t)}})}),a.length)return a;var t=n.getComponent({name:"coord"});return _mmvis._.each(_mmvis._.flatten(t.fieldsMap),function(e,t){var i=!1;_mmvis._.each(n._opt.graphs,function(t){if(-1<_mmvis._.indexOf(_mmvis._.flatten([t.field]),e.field))return!(i=!0)}),i&&a.push({enabled:e.enabled,name:e.field,field:e.field,ind:e.ind,color:e.color,yAxis:e.yAxis})}),a}},{key:"show",value:function(e,i){var t=this.getComponent({name:"coord"});t&&t.show(e,i),_mmvis._.each(this.getComponents({name:"graphs"}),function(t){t.show(e,i)}),this.componentsReset(i)}},{key:"hide",value:function(e,i){var t=this.getComponent({name:"coord"});t&&t.hide(e,i),_mmvis._.each(this.getComponents({name:"graphs"}),function(t){t.hide(e,i)}),this.componentsReset(i)}},{key:"_bindEvent",value:function(){var n=this;this.on(_mmvis.event.types.get(),function(e){e.eventInfo&&_mmvis._.each(this.getGraphs(),function(t){t.triggerEvent(e)});var t=n.getComponent({name:"tips"}),i=n.getComponent({name:"coord"});t&&(n._setGraphsTipsInfo.apply(n,[e]),"mouseover"!=e.type&&"mousedown"!=e.type||(t.show(e),n._tipsPointerAtAllGraphs(e)),"mousemove"==e.type&&(t.move(e),n._tipsPointerAtAllGraphs(e)),"mouseout"!=e.type||e.toTarget&&i&&i.induce&&i.induce.containsPoint(i.induce.globalToLocal(e.target.localToGlobal(e.point)))||(t.hide(e),n._tipsPointerHideAtAllGraphs(e)))})}},{key:"_setGraphsTipsInfo",value:function(e){e.eventInfo||(e.eventInfo={});var t=this.getComponent({name:"coord"});if(t&&(e.eventInfo=t.getTipsInfoHandler(e)),"tipsEnabled"in e.eventInfo||(e.eventInfo.tipsEnabled=!0),!e.eventInfo.nodes||!e.eventInfo.nodes.length){var i=[],n=e.eventInfo.iNode;_mmvis._.each(this.getComponents({name:"graphs"}),function(t){i=i.concat(t.getNodesAt(n,e))}),e.eventInfo.nodes=i}}},{key:"_tipsPointerAtAllGraphs",value:function(e){_mmvis._.each(this.getComponents({name:"graphs"}),function(t){t.tipsPointerOf(e)})}},{key:"_tipsPointerHideAtAllGraphs",value:function(e){_mmvis._.each(this.getComponents({name:"graphs"}),function(t){t.tipsPointerHideOf(e)})}}]),o}(_mmvis.event.Dispatcher);_mmvis.global.registerComponent(Chart,"chart");var _default=Chart;exports.default=_default;