"use strict";!function(t,e){if("function"==typeof define&&define.amd)define(["exports","canvax","mmvis"],e);else if("undefined"!=typeof exports)e(exports,require("canvax"),require("mmvis"));else{var n={};e(n,t.canvax,t.mmvis),t.undefined=n}}(void 0,function(t,e,l){Object.defineProperty(t,"__esModule",{value:!0});var n,a=(n=e)&&n.__esModule?n:{default:n};function i(t){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function o(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function r(t,e){return!e||"object"!==i(e)&&"function"!=typeof e?function(t){if(void 0!==t)return t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(t):e}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function h(t,e){return(h=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var d,c,p,u=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&h(t,e)}(f,l.event.Dispatcher),d=f,(c=[{key:"init",value:function(){var o=this,e=this._opt;for(var i in this.padding=this._getPadding(),l._.each(this.__highModules,function(i){if(e[i]){var t=l._.flatten([e[i]]);"theme"==i&&(t=[t]),l._.each(t,function(t){if(("coord"!=i||t.type)&&("graphs"!=i||t.field||t.keyField)){var e=o.componentModules.get(i,t.type);if(e){var n=new e(t,o);o.components.push(n)}}})}}),this._opt)if(-1==l._.indexOf(this.__highModules,i)){var t=this._opt[i];l._.isArray(t)||(t=[t]),l._.each(t,function(t){var e=o.componentModules.get(i,t.type);if(e){var n=new e(t,o);o.components.push(n)}})}}},{key:"draw",value:function(t){var n=this;t=t||{};var e=this.getComponent({name:"coord"});e&&e.horizontal&&this._drawBeginHorizontal();var i=this.width-this.padding.left-this.padding.right,o=this.height-this.padding.top-this.padding.bottom,a={x:this.padding.left,y:this.padding.top};if(e&&(e.draw(t),i=e.width,o=e.height,a=e.origin),0!=this.dataFrame.length){var r=this.getComponents({name:"graphs"}),s=r.length,h=0;t=l._.extend(t,{width:i,height:o,origin:a}),l._.each(r,function(e){e.on("complete",function(t){++h==s&&n.fire("complete"),e.inited=!0}),e.draw(t)});for(var d=0,c=this.components.length;d<c;d++){var p=this.components[d];-1==l._.indexOf(this.__highModules,p.name)&&p.draw(t)}this._bindEvent(),e&&e.horizontal&&this._drawEndHorizontal()}else n.fire("complete")}},{key:"_drawBeginHorizontal",value:function(){var t=this.padding,e=t.top;t.top=t.right,t.right=t.bottom,t.bottom=t.left,t.left=e}},{key:"_drawEndHorizontal",value:function(){var t=this.graphsSprite.context;t.x+=(this.width-this.height)/2,t.y+=(this.height-this.width)/2,t.rotation=90,t.rotateOrigin={x:this.height/2,y:this.width/2},this._horizontalGraphsText()}},{key:"_horizontalGraphsText",value:function(){l._.each(this.getComponents({name:"graphs"}),function(t){!function e(t){if(t.children&&l._.each(t.children,function(t){e(t)}),"text"==t.type&&!t.__horizontal){var n=t.context;n.width,n.height,n.rotation=n.rotation-90,t.__horizontal=!0}}(t.sprite)})}},{key:"_getPadding",value:function(){var t=20;this._opt.coord&&"padding"in this._opt.coord&&(l._.isObject(this._opt.coord.padding)||(t=this._opt.coord.padding));var e={top:t,right:t,bottom:t,left:t};return this._opt.coord&&"padding"in this._opt.coord&&l._.isObject(this._opt.coord.padding)&&(e=l._.extend(e,this._opt.coord.padding)),e}},{key:"getTheme",value:function(t){var e=l.global.getGlobalTheme(),n=this.getComponent({name:"theme"});return n&&(e=n.get()),null!=t?e[t%e.length]||"#ccc":e}},{key:"setCoord_Graphs_Sp",value:function(){this.coordSprite=new a.default.Display.Sprite({id:"coordSprite"}),this.stage.addChild(this.coordSprite),this.graphsSprite=new a.default.Display.Sprite({id:"graphsSprite"}),this.stage.addChild(this.graphsSprite)}},{key:"destroy",value:function(){this.clean(),this.el&&(this.el.removeAttribute("chart_id"),this.el.removeAttribute("chartx_version"),this.canvax.destroy(),this.el=null),this._destroy&&this._destroy(),this.fire("destroy")}},{key:"clean",value:function(){for(var t=0,e=this.canvax.children.length;t<e;t++)for(var n=this.canvax.getChildAt(t),i=0,o=n.children.length;i<o;i++)n.getChildAt(i).destroy(),i--,o--;this.setCoord_Graphs_Sp(),this.components=[],this.canvax.domView.innerHTML=""}},{key:"resize",value:function(){var t=parseInt(this.el.offsetWidth),e=parseInt(this.el.offsetHeight);t==this.width&&e==this.height||(this.width=t,this.height=e,this.canvax.resize(),this.inited=!1,this.clean(),this.init(),this.draw({resize:!0}),this.inited=!0)}},{key:"reset",value:function(t,e){t&&(this._opt=t),e&&(this._data=e),this.dataFrame=this.initData(this._data,t),this.clean(),this.init(),this.draw()}},{key:"resetData",value:function(t,e){var n=this;this._data=t;var i=this.dataFrame.org.length;if(this.dataFrame.resetData(t),!i)return this.clean(),this.init(),void this.draw(this._opt);var o=this.getComponent({name:"coord"});o&&o.resetData(this.dataFrame,e),l._.each(this.getComponents({name:"graphs"}),function(t){t.resetData(n.dataFrame,e)}),this.componentsReset(e),o&&o.horizontal&&this._horizontalGraphsText(),this.fire("resetData")}},{key:"initData",value:function(){return l.dataFrame.apply(this,arguments)}},{key:"componentsReset",value:function(n){var i=this;l._.each(this.components,function(t,e){-1==l._.indexOf(i.__highModules,t.name)&&(n&&n.comp&&n.comp.__cid==t.__cid||t.reset&&t.reset(i[t.type]||{},i.dataFrame))})}},{key:"getComponentById",value:function(e){var n;return l._.each(this.components,function(t){if(t.id&&t.id==e)return n=t,!1}),n}},{key:"getComponent",value:function(t){return this.getComponents(t)[0]}},{key:"getComponents",value:function(i,t){var o=[],a=0;for(var e in t=t||this.components,i)a++;return a?(l._.each(t,function(t){var e=0;for(var n in i)JSON.stringify(t[n])==JSON.stringify(i[n])&&e++;a==e&&o.push(t)}),o):t}},{key:"getGraph",value:function(t){return this.getGraphs(t)[0]}},{key:"getGraphs",value:function(t){return this.getComponents(t,this.getComponents({name:"graphs"}))}},{key:"getGraphById",value:function(e){var n;return l._.each(this.getComponents({name:"graphs"}),function(t){if(t.id==e)return n=t,!1}),n}},{key:"getCoord",value:function(t){return this.getComponent(l._.extend(!0,{name:"coord"},t))}},{key:"getLegendData",value:function(){var i=this,o=[];if(l._.each(this.getComponents({name:"graphs"}),function(t){l._.each(t.getLegendData(),function(e){if(!l._.find(o,function(t){return t.name==e.name})){var t=l._.extend(!0,{},e);t.color=e.fillStyle||e.color||e.style,o.push(t)}})}),o.length)return o;var t=i.getComponent({name:"coord"});return l._.each(l._.flatten(t.fieldsMap),function(e,t){var n=!1;l._.each(i._opt.graphs,function(t){if(-1<l._.indexOf(l._.flatten([t.field]),e.field))return!(n=!0)}),n&&o.push({enabled:e.enabled,name:e.field,field:e.field,ind:e.ind,color:e.color,yAxis:e.yAxis})}),o}},{key:"show",value:function(e,n){var t=this.getComponent({name:"coord"});t&&t.show(e,n),l._.each(this.getComponents({name:"graphs"}),function(t){t.show(e,n)}),this.componentsReset(n)}},{key:"hide",value:function(e,n){var t=this.getComponent({name:"coord"});t&&t.hide(e,n),l._.each(this.getComponents({name:"graphs"}),function(t){t.hide(e,n)}),this.componentsReset(n)}},{key:"_bindEvent",value:function(){var i=this;this.on(l.event.types.get(),function(e){e.eventInfo&&l._.each(this.getGraphs(),function(t){t.triggerEvent(e)});var t=i.getComponent({name:"tips"}),n=i.getComponent({name:"coord"});t&&(i._setGraphsTipsInfo.apply(i,[e]),"mouseover"!=e.type&&"mousedown"!=e.type||(t.show(e),i._tipsPointerAtAllGraphs(e)),"mousemove"==e.type&&(t.move(e),i._tipsPointerAtAllGraphs(e)),"mouseout"!=e.type||e.toTarget&&n&&n.induce&&n.induce.containsPoint(n.induce.globalToLocal(e.target.localToGlobal(e.point)))||(t.hide(e),i._tipsPointerHideAtAllGraphs(e)))})}},{key:"_setGraphsTipsInfo",value:function(e){e.eventInfo||(e.eventInfo={});var t=this.getComponent({name:"coord"});if(t&&(e.eventInfo=t.getTipsInfoHandler(e)),"tipsEnabled"in e.eventInfo||(e.eventInfo.tipsEnabled=!0),!e.eventInfo.nodes||!e.eventInfo.nodes.length){var n=[],i=e.eventInfo.iNode;l._.each(this.getComponents({name:"graphs"}),function(t){n=n.concat(t.getNodesAt(i,e))}),e.eventInfo.nodes=n}}},{key:"_tipsPointerAtAllGraphs",value:function(e){l._.each(this.getComponents({name:"graphs"}),function(t){t.tipsPointerOf(e)})}},{key:"_tipsPointerHideAtAllGraphs",value:function(e){l._.each(this.getComponents({name:"graphs"}),function(t){t.tipsPointerHideOf(e)})}}])&&o(d.prototype,c),void(p&&o(d,p)),f);function f(t,e,n,i){var o;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,f),(o=r(this,s(f).call(this))).componentModules=i,o._node=t,o._data=e,o._opt=n,o.dataFrame=o.initData(e,n),o.el=l.$.query(t),o.width=parseInt(o.el.offsetWidth),o.height=parseInt(o.el.offsetHeight),o.padding=null,o.canvax=new a.default.App({el:o.el,webGL:!1}),o.canvax.registEvent(),o.id="chartx_"+o.canvax.id,o.el.setAttribute("chart_id",o.id),o.el.setAttribute("chartx_version","2.0"),o.stage=new a.default.Display.Stage({id:"main-chart-stage"}),o.canvax.addChild(o.stage),o.setCoord_Graphs_Sp(),o.__highModules=["theme","coord","graphs"],o.components=[],o.inited=!1,o.init(),o}l.global.registerComponent(u,"chart"),t.default=u});