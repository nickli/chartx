"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_index=_interopRequireDefault(require("./index")),_canvax=_interopRequireDefault(require("canvax")),_xaxis=_interopRequireDefault(require("./xaxis")),_yaxis=_interopRequireDefault(require("./yaxis")),_grid=_interopRequireDefault(require("./grid")),_mmvis=require("mmvis"),Rect=function(i){function s(i,e){var t;return(0,_classCallCheck2.default)(this,s),t=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(s).call(this,i,e)),_mmvis._.extend(!0,(0,_assertThisInitialized2.default)(t),(0,_mmvis.getDefaultProps)(s.defaultProps()),t.setDefaultOpt(i,e)),t.type="rect",t._xAxis=null,t._yAxis=[],t._yAxisLeft=null,t._yAxisRight=null,t._grid=null,t.init(i),t}return(0,_inherits2.default)(s,i),(0,_createClass2.default)(s,null,[{key:"defaultProps",value:function(){return{horizontal:{detail:"横向翻转坐标系",documentation:"横向翻转坐标系",insertText:"horizontal: ",default:!1,values:[!0,!1]},_props:{xAxis:_xaxis.default,yAxis:_yaxis.default,grid:_grid.default}}}}]),(0,_createClass2.default)(s,[{key:"setDefaultOpt",value:function(i,e){var t={field:this.dataFrame.fields[0],xAxis:{layoutType:"rule",posParseToInt:!1},grid:{}};if(_mmvis._.extend(!0,t,i),t.yAxis){var s=[];_mmvis._.each(_mmvis._.flatten([t.yAxis]),function(i){s.push(_mmvis._.clone(i))}),t.yAxis=s}else t.yAxis=[];for(var a=_mmvis._.flatten([e._opt.graphs]),n=0;n<a.length;n++){var r=a[n];if("bar"==r.type&&(t.xAxis.layoutType="peak"),r.field){var h="left";"right"==r.yAxisAlign&&(h="right");var l=null;(l=_mmvis._.find(t.yAxis,function(i,e){return i.align==h||!i.align&&e==("left"==h?0:1)}))?l.align||(l.align=h):(l={align:h,field:[]},t.yAxis.push(l)),l.field?_mmvis._.isArray(l.field)||(l.field=[l.field]):l.field=[],_mmvis._.isArray(r.field)?l.field=l.field.concat(r.field):l.field.push(r.field)}}var x=[],o=[];return _mmvis._.each(t.yAxis,function(i,e){i.align||(i.align=e?"right":"left"),"left"==i.align?x.push(i):o.push(i)}),t.yAxis=x.concat(o),t.horizontal&&(t.xAxis.isH=!0,_mmvis._.each(t.yAxis,function(i){i.isH=!0})),"enabled"in t&&(_mmvis._.extend(!0,t.xAxis,{enabled:t.enabled}),_mmvis._.each(t.yAxis,function(i){_mmvis._.extend(!0,i,{enabled:t.enabled})}),t.grid.enabled=t.enabled),"animation"in t&&(_mmvis._.extend(!0,t.xAxis,{animation:t.animation}),_mmvis._.each(t.yAxis,function(i){_mmvis._.extend(!0,i,{animation:t.animation})}),t.grid.animation=t.animation),t}},{key:"init",value:function(){this._initModules(),this.fieldsMap=this.setFieldsMap({type:"yAxis"})}},{key:"resetData",value:function(i){var t=this;this.dataFrame=i;var e=this.getAxisDataFrame(this.xAxis.field);this._xAxis.resetData(e),_mmvis._.each(this._yAxis,function(i){var e=t.getAxisDataFrame(i.field);i.resetData(e)}),this._resetXY_axisLine_pos();this._yAxisLeft||this._yAxisRight;this._grid.reset({animation:!1})}},{key:"draw",value:function(i){i=i||{};var e=this.app.padding,t=i.height||this.app.height,s=i.width||this.app.width;if(this.horizontal){var a=s;s=t,t=a}var n=t-this._xAxis.height-e.bottom,r=0,h=0;this._yAxisLeft&&(this._yAxisLeft.draw({pos:{x:e.left,y:n},yMaxHeight:n-e.top,resize:i.resize}),r=this._yAxisLeft.width),this._yAxisRight&&(this._yAxisRight.draw({pos:{x:0,y:n},yMaxHeight:n-e.top,resize:i.resize}),h=this._yAxisRight.width),this._xAxis.draw({pos:{x:e.left+r,y:n},width:s-r-e.left-h-e.right,resize:i.resize}),this._yAxisRight&&this._yAxisRight.setX(r+e.left+this._xAxis.width),this._grid.draw({width:this._xAxis.width,height:this._yAxis[0].height,pos:{x:r+e.left,y:n},resize:i.resize}),this.width=this._xAxis.width,this.height=this._yAxis[0].height,this.origin.x=r+e.left,this.origin.y=n,this._initInduce(),this._resetXY_axisLine_pos(),this.horizontal&&this._horizontal({w:s,h:t})}},{key:"_resetXY_axisLine_pos",value:function(){var i,t=this;this._xAxis.enabled&&("center"==this._xAxis.axisLine.position&&(i=-this._yAxis[0].height/2),"center"==this._xAxis.axisLine.position&&(i=-this._yAxis[0].height/2),_mmvis._.isNumber(this._xAxis.axisLine.position)&&(i=-this._yAxis[0].getPosOfVal(this._xAxis.axisLine.position)),void 0!==i&&(this._xAxis._axisLine.context.y=i)),_mmvis._.each(this._yAxis,function(i){var e;i.enabled&&("center"==i.axisLine.position&&(e=t._xAxis.width/2),_mmvis._.isNumber(i.axisLine.position)&&(e=t._xAxis.getPosOfVal(i.axisLine.position)),void 0!==e&&(i._axisLine.context.x=e))})}},{key:"getSizeAndOrigin",value:function(){var i={width:this.width,height:this.height,origin:this.origin};if(this.horizontal){var e=this.app.padding,t=e.bottom,s=e.right;i={width:this._yAxis[0].height,height:this._xAxis.width,origin:{x:this._xAxis.height+t,y:this._yAxis[0].height+s}}}return i}},{key:"_initModules",value:function(){this._grid=new _grid.default(this.grid,this),this.sprite.addChild(this._grid.sprite);var i=this.getAxisDataFrame(this.xAxis.field);this._xAxis=new _xaxis.default(this.xAxis,i,this),this._axiss.push(this._xAxis),this.sprite.addChild(this._xAxis.sprite);var e,t,s,a,n=this.yAxis;_mmvis._.isArray(n)||(n=[n]),(e=_mmvis._.find(n,function(i){return"left"==i.align}))&&(s=this.getAxisDataFrame(e.field),this._yAxisLeft=new _yaxis.default(e,s,this),this._yAxisLeft.axis=e,this.sprite.addChild(this._yAxisLeft.sprite),this._yAxis.push(this._yAxisLeft),this._axiss.push(this._yAxisLeft)),(t=_mmvis._.find(n,function(i){return"right"==i.align}))&&(a=this.getAxisDataFrame(t.field),this._yAxisRight=new _yaxis.default(t,a,this),this._yAxisRight.axis=t,this.sprite.addChild(this._yAxisRight.sprite),this._yAxis.push(this._yAxisRight),this._axiss.push(this._yAxisRight))}},{key:"_horizontal",value:function(i){var t=i.h,s=i.w;_mmvis._.each([this.sprite.context],function(i){i.x+=(t-s)/2,i.y+=(s-t)/2;var e={x:s/2,y:t/2};i.rotation=90,i.rotateOrigin=e})}},{key:"changeFieldEnabled",value:function(i){this.setFieldEnabled(i);var e=this.getFieldMapOf(i),t=e.yAxis||e.rAxis,s=this.getEnabledFieldsOf(t);t.resetData(this.getAxisDataFrame(s)),this._resetXY_axisLine_pos(),this._grid.reset({animation:!1})}},{key:"_initInduce",value:function(){var e=this;e.induce=new _canvax.default.Shapes.Rect({id:"induce",context:{x:e.origin.x,y:e.origin.y-e.height,width:e.width,height:e.height,fillStyle:"#000000",globalAlpha:0,cursor:"pointer"}}),e.sprite.getChildById("induce")||e.sprite.addChild(e.induce),e.induce.on(_mmvis.event.types.get(),function(i){e.fire(i.type,i),e.app.fire(i.type,i)})}},{key:"getTipsInfoHandler",value:function(i){var e=i.point.x;i.target!==this.induce&&(e=this.induce.globalToLocal(i.target.localToGlobal(i.point)).x);var t=this._xAxis.getNodeInfoOfX(e),s={xAxis:t,dimension_1:t,title:t.text,iNode:t.ind,nodes:[]};return i.eventInfo&&(_mmvis._.extend(!0,s,i.eventInfo),s.xAxis&&(i.eventInfo.xAxis=t)),s}},{key:"getPoint",value:function(i){var e={x:0,y:void 0},t={type:"yAxis",field:i.field},s=this.getAxis({type:"xAxis"}),a=this.getAxis(t),n=i.iNode||0,r=i.value;"x"in r||(r.x=_mmvis._.flatten(s.dataOrg)[n]),e.x=s.getPosOf({ind:n,val:r.x});var h=r.y;return isNaN(h)||null==h||""===h?e.y=void 0:e.y=-a.getPosOfVal(h),{pos:e,value:r}}},{key:"getAxisOriginPoint",value:function(i){var e=this.getAxis(i);return{pos:-e.originPos,value:e.origin}}},{key:"getOriginPos",value:function(i){var e={type:"yAxis",field:i.field},t=this.getAxis({type:"xAxis"}),s=this.getAxis(e);return{x:t.originPos,y:-s.originPos}}}]),s}(_index.default);_mmvis.global.registerComponent(Rect,"coord","rect");var _default=Rect;exports.default=_default;