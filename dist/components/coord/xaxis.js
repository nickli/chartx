"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_canvax=_interopRequireDefault(require("canvax")),_tools=require("../../utils/tools"),_mmvis=require("mmvis"),_axis=_interopRequireDefault(require("./axis")),Line=_canvax.default.Shapes.Line,xAxis=function(t){function l(t,e,i){var a;return(0,_classCallCheck2.default)(this,l),(a=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(l).call(this,t,e.org))).type="xAxis",a._coord=i||{},a._title=null,a._axisLine=null,a._formatTextSection=[],a._textElements=[],a.pos={x:0,y:0},a.layoutData=[],a.sprite=null,a.isH=!1,_mmvis._.extend(!0,(0,_assertThisInitialized2.default)(a),(0,_mmvis.getDefaultProps)(l.defaultProps()),t),a.init(t),a}return(0,_inherits2.default)(l,t),(0,_createClass2.default)(l,null,[{key:"defaultProps",value:function(){return{}}}]),(0,_createClass2.default)(l,[{key:"init",value:function(t){this._setField(),this._initHandle(t),this.sprite=new _canvax.default.Display.Sprite({id:"xAxisSprite_"+(new Date).getTime()}),this.rulesSprite=new _canvax.default.Display.Sprite({id:"xRulesSprite_"+(new Date).getTime()}),this.sprite.addChild(this.rulesSprite)}},{key:"_initHandle",value:function(t){var a=this;t&&(!t.isH||t.label&&void 0!==t.label.rotaion||(this.label.rotation=90)),this.setDataSection(),a._formatTextSection=[],a._textElements=[],_mmvis._.each(a.dataSection,function(t,e){a._formatTextSection[e]=a._getFormatText(t,e);var i=new _canvax.default.Display.Text(a._formatTextSection[e],{context:{fontSize:a.label.fontSize}});a._textElements[e]=i}),0!=this.label.rotation&&(this.label.textAlign="right"),this._getTitle(),this._setXAxisHeight()}},{key:"_setField",value:function(t){t&&(this.field=t),this.field=_mmvis._.flatten([this.field])[0]}},{key:"draw",value:function(t){t&&_mmvis._.extend(!0,this,t),this.setAxisLength(this.width),this._trimXAxis(),this._widget(t),this.setX(this.pos.x),this.setY(this.pos.y)}},{key:"resetData",value:function(t){this._setField(t.field),this.resetDataOrg(t.org),this._initHandle(),this.draw()}},{key:"setX",value:function(t){this.sprite.context.x=t,this.pos.x=t}},{key:"setY",value:function(t){this.sprite.context.y=t,this.pos.y=t}},{key:"_getTitle",value:function(){this.title.text&&(this._title?this._title.resetText(this.title.text):this._title=new _canvax.default.Display.Text(this.title.text,{context:{fontSize:this.title.fontSize,textAlign:this.title.textAlign,textBaseline:this.title.textBaseline,fillStyle:this.title.fontColor,strokeStyle:this.title.strokeStyle,lineWidth:this.title.lineWidth,rotation:this.isH?-180:0}}))}},{key:"_setXAxisHeight",value:function(){var h=this;if(h.enabled){var o=0;this.label.enabled&&_mmvis._.each(h.dataSection,function(t,e){var i=h._textElements[e],a=i.getTextWidth(),l=i.getTextHeight(),s=l;if(h.label.rotation)if(90==h.label.rotation)s=a;else{var n=Math.sin(Math.abs(h.label.rotation)*Math.PI/180),r=Math.cos(Math.abs(h.label.rotation)*Math.PI/180);s=parseInt(n*a),parseInt(r*a)}o=Math.max(o,s)}),this.height=o+this.tickLine.lineLength+this.tickLine.distance+this.label.distance,this._title&&(this.height+=this._title.getTextHeight())}else h.height=0}},{key:"getNodeInfoOfX",value:function(t){var e=this.getIndexOfPos(t),i=this.getValOfInd(e),a=this.getPosOf({ind:e,val:i});return this._getNodeInfo(e,i,a)}},{key:"getNodeInfoOfVal",value:function(t){var e=this.getIndexOfVal(t),i=this.getPosOf({ind:e,val:t});return this._getNodeInfo(e,t,i)}},{key:"_getNodeInfo",value:function(t,e,i){return{ind:t,value:e,text:this._getFormatText(e,t),x:i,field:this.field,layoutType:this.layoutType}}},{key:"_trimXAxis",value:function(){for(var t=[],e=this.dataSection,i=0,a=e.length;i<a;i++){var l=this._formatTextSection[i],s=this._textElements[i],n={ind:i,value:e[i],text:l,x:this.getPosOf({val:e[i],ind:i}),textWidth:s.getTextWidth(),field:this.field,visible:null};t.push(n)}return this.layoutData=t,this._trimLayoutData(),t}},{key:"_getFormatText",value:function(t){var e=t;return _mmvis._.isFunction(this.label.format)&&(e=this.label.format.apply(this,arguments)),_mmvis._.isNumber(e)&&"proportion"==this.layoutType&&(e=(0,_tools.numAddSymbol)(e)),e}},{key:"_widget",value:function(t){var e=this;if(t=t||{},e.enabled){for(var i=e.layoutData,a=0,l=0,s=i.length;l<s;l++){_mmvis._.isFunction(e.filter)&&e.filter({layoutData:i,index:l});var n=i[l];if(n.visible){var r=n.x,h=e.tickLine.lineLength+e.tickLine.distance+e.label.distance,o=e.rulesSprite.getChildAt(a),u={x:n._text_x||n.x,y:h,fillStyle:this.label.fontColor,fontSize:this.label.fontSize,rotation:-Math.abs(this.label.rotation),textAlign:this.label.textAlign,lineHeight:this.label.lineHeight,textBaseline:this.label.rotation?"middle":"top",globalAlpha:1};this.label.rotation&&90!=this.label.rotation&&(u.x+=5,u.y+=3);var d={x:r,y:this.tickLine.distance,end:{x:0,y:this.tickLine.lineLength},lineWidth:this.tickLine.lineWidth,strokeStyle:this.tickLine.strokeStyle},x=300,_=a*Math.min(1e3/i.length,25);e.animation&&!t.resize||(_=x=0),o?(o._tickLine&&e.tickLine.enabled&&o._tickLine.animate(d,{duration:x,id:o._tickLine.id}),o._txt&&e.label.enabled&&(o._txt.animate(u,{duration:x,id:o._txt.id}),o._txt.resetText(n.text))):(o=new _canvax.default.Display.Sprite({id:"xNode"+a}),e.tickLine.enabled&&(o._tickLine=new Line({id:"xAxis_tickline_"+a,context:d}),o.addChild(o._tickLine)),e.label.enabled&&(o._txt=new _canvax.default.Display.Text(n.text,{id:"xAxis_txt_"+a,context:u}),o.addChild(o._txt),e.animation&&!t.resize&&(o._txt.context.y+=20,o._txt.context.globalAlpha=0,o._txt.animate({y:u.y,globalAlpha:1},{duration:500,delay:_,id:o._txt.id}))),e.rulesSprite.addChild(o)),a++}}if(this.rulesSprite.children.length>=a){s=a;for(var f=this.rulesSprite.children.length;s<f;s++)this.rulesSprite.getChildAt(s).remove(),s--,f--}if(this.axisLine.enabled){var c={start:{x:0,y:0},end:{x:this.width,y:0},lineWidth:this.axisLine.lineWidth,strokeStyle:this.axisLine.strokeStyle};if(this._axisLine)this._axisLine.animate(c);else{var v=new Line({context:c});this.sprite.addChild(v),this._axisLine=v}}this._title&&(this._title.context.y=this.height-this._title.getTextHeight()/2,this._title.context.x=this.width/2,this.sprite.addChild(this._title))}else e.height=0}},{key:"_trimLayoutData",value:function(){var t=this.layoutData.length;this.enabled&&t&&("proportion"==this.layoutType&&this._checkOver(),"peak"==this.layoutType&&this._checkOver(),"rule"==this.layoutType&&this._checkOver())}},{key:"_getRootPR",value:function(){var t=0;return this._coord.app&&(t=this._coord.app.padding.right),t}},{key:"_checkOver",value:function(){var o=this,u=o.layoutData,d=u.length,x=o.label.textAlign;if(this.label.evade&&!o.trimLayout)!function t(e){var i=u[e];if(void 0!==i){i.visible=!0;for(var a=e;a<d-1;a++){var l=u[a+1],s=l.textWidth,n=i.textWidth;o.label.rotation&&(s=Math.min(s,22),n=Math.min(n,22));var r=l.x,h=i.x+n;if("center"==x&&(r=l.x-s/2,h=i.x+n/2),"right"==x&&(r=l.x-s,h=i.x),a==d-2&&r+s>o.width+o._getRootPR()&&("center"==x&&l.x+s/2>o.width&&(r=o.width-s,l._text_x=o.width-s/2+o._getRootPR()),"left"==x&&l.x+s>o.width&&(r=o.width-s,l._text_x=o.width-s)),!(r-h<1)){t(a+1);break}if(a==d-2)return l.visible=!0,void(i.visible=!1);l.visible=!1}}}(0);else{var t;_mmvis._.each(u,function(t){t.visible=!0}),o.trimLayout&&o.trimLayout(u);for(var e=d-1;0<=e&&!t;e--)u[e].visible&&(t=u[e]);t&&("center"==x&&t.x+t.textWidth/2>o.width&&(t._text_x=o.width-t.textWidth/2+o._getRootPR()),"left"==x&&t.x+t.textWidth>o.width&&(t._text_x=o.width-t.textWidth))}}}]),l}(_axis.default);exports.default=xAxis;