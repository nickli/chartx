"use strict";!function(t,e){if("function"==typeof define&&define.amd)define(["exports","canvax","../../utils/tools","mmvis","./axis"],e);else if("undefined"!=typeof exports)e(exports,require("canvax"),require("../../utils/tools"),require("mmvis"),require("./axis"));else{var i={};e(i,t.canvax,t.tools,t.mmvis,t.axis),t.undefined=i}}(void 0,function(t,e,i,p,n){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var v=a(e),l=a(n);function a(t){return t&&t.__esModule?t:{default:t}}function o(t){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function r(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function h(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function u(t,e,i){return e&&h(t.prototype,e),i&&h(t,i),t}function d(t,e){return(d=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var b=v.default.Shapes.Line,f=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&d(t,e)}(x,l.default),u(x,null,[{key:"defaultProps",value:function(){return{}}}]),u(x,[{key:"init",value:function(t){this._setField(),this._initHandle(t),this.sprite=new v.default.Display.Sprite({id:"xAxisSprite_"+(new Date).getTime()}),this.rulesSprite=new v.default.Display.Sprite({id:"xRulesSprite_"+(new Date).getTime()}),this.sprite.addChild(this.rulesSprite)}},{key:"_initHandle",value:function(t){var n=this;t&&(!t.isH||t.label&&void 0!==t.label.rotaion||(this.label.rotation=90)),this.setDataSection(),n._formatTextSection=[],n._textElements=[],p._.each(n.dataSection,function(t,e){n._formatTextSection[e]=n._getFormatText(t,e);var i=new v.default.Display.Text(n._formatTextSection[e],{context:{fontSize:n.label.fontSize}});n._textElements[e]=i}),0!=this.label.rotation&&(this.label.textAlign="right"),this._getTitle(),this._setXAxisHeight()}},{key:"_setField",value:function(t){t&&(this.field=t),this.field=p._.flatten([this.field])[0]}},{key:"draw",value:function(t){t&&p._.extend(!0,this,t),this.setAxisLength(this.width),this._trimXAxis(),this._widget(t),this.setX(this.pos.x),this.setY(this.pos.y)}},{key:"resetData",value:function(t){this._setField(t.field),this.resetDataOrg(t.org),this._initHandle(),this.draw()}},{key:"setX",value:function(t){this.sprite.context.x=t,this.pos.x=t}},{key:"setY",value:function(t){this.sprite.context.y=t,this.pos.y=t}},{key:"_getTitle",value:function(){this.title.text&&(this._title?this._title.resetText(this.title.text):this._title=new v.default.Display.Text(this.title.text,{context:{fontSize:this.title.fontSize,textAlign:this.title.textAlign,textBaseline:this.title.textBaseline,fillStyle:this.title.fontColor,strokeStyle:this.title.strokeStyle,lineWidth:this.title.lineWidth,rotation:this.isH?-180:0}}))}},{key:"_setXAxisHeight",value:function(){var r=this;if(r.enabled){var h=0;this.label.enabled&&p._.each(r.dataSection,function(t,e){var i=r._textElements[e],n=i.getTextWidth(),l=i.getTextHeight(),a=l;if(r.label.rotation)if(90==r.label.rotation)a=n;else{var o=Math.sin(Math.abs(r.label.rotation)*Math.PI/180),s=Math.cos(Math.abs(r.label.rotation)*Math.PI/180);a=parseInt(o*n),parseInt(s*n)}h=Math.max(h,a)}),this.height=h+this.tickLine.lineLength+this.tickLine.distance+this.label.distance,this._title&&(this.height+=this._title.getTextHeight())}else r.height=0}},{key:"getNodeInfoOfX",value:function(t){var e=this.getIndexOfPos(t),i=this.getValOfInd(e),n=this.getPosOf({ind:e,val:i});return this._getNodeInfo(e,i,n)}},{key:"getNodeInfoOfVal",value:function(t){var e=this.getIndexOfVal(t),i=this.getPosOf({ind:e,val:t});return this._getNodeInfo(e,t,i)}},{key:"_getNodeInfo",value:function(t,e,i){return{ind:t,value:e,text:this._getFormatText(e,t),x:i,field:this.field,layoutType:this.layoutType}}},{key:"_trimXAxis",value:function(){for(var t=[],e=this.dataSection,i=0,n=e.length;i<n;i++){var l=this._formatTextSection[i],a=this._textElements[i],o={ind:i,value:e[i],text:l,x:this.getPosOf({val:e[i],ind:i}),textWidth:a.getTextWidth(),field:this.field,visible:null};t.push(o)}return this.layoutData=t,this._trimLayoutData(),t}},{key:"_getFormatText",value:function(t){var e=t;return p._.isFunction(this.label.format)&&(e=this.label.format.apply(this,arguments)),p._.isNumber(e)&&"proportion"==this.layoutType&&(e=(0,i.numAddSymbol)(e)),e}},{key:"_widget",value:function(t){var e=this;if(t=t||{},e.enabled){for(var i=e.layoutData,n=0,l=0,a=i.length;l<a;l++){p._.isFunction(e.filter)&&e.filter({layoutData:i,index:l});var o=i[l];if(o.visible){var s=o.x,r=e.tickLine.lineLength+e.tickLine.distance+e.label.distance,h=e.rulesSprite.getChildAt(n),u={x:o._text_x||o.x,y:r,fillStyle:this.label.fontColor,fontSize:this.label.fontSize,rotation:-Math.abs(this.label.rotation),textAlign:this.label.textAlign,lineHeight:this.label.lineHeight,textBaseline:this.label.rotation?"middle":"top",globalAlpha:1};this.label.rotation&&90!=this.label.rotation&&(u.x+=5,u.y+=3);var d={x:s,y:this.tickLine.distance,end:{x:0,y:this.tickLine.lineLength},lineWidth:this.tickLine.lineWidth,strokeStyle:this.tickLine.strokeStyle},f=300,x=n*Math.min(1e3/i.length,25);e.animation&&!t.resize||(x=f=0),h?(h._tickLine&&e.tickLine.enabled&&h._tickLine.animate(d,{duration:f,id:h._tickLine.id}),h._txt&&e.label.enabled&&(h._txt.animate(u,{duration:f,id:h._txt.id}),h._txt.resetText(o.text))):(h=new v.default.Display.Sprite({id:"xNode"+n}),e.tickLine.enabled&&(h._tickLine=new b({id:"xAxis_tickline_"+n,context:d}),h.addChild(h._tickLine)),e.label.enabled&&(h._txt=new v.default.Display.Text(o.text,{id:"xAxis_txt_"+n,context:u}),h.addChild(h._txt),e.animation&&!t.resize&&(h._txt.context.y+=20,h._txt.context.globalAlpha=0,h._txt.animate({y:u.y,globalAlpha:1},{duration:500,delay:x,id:h._txt.id}))),e.rulesSprite.addChild(h)),n++}}if(this.rulesSprite.children.length>=n){a=n;for(var c=this.rulesSprite.children.length;a<c;a++)this.rulesSprite.getChildAt(a).remove(),a--,c--}if(this.axisLine.enabled){var _={start:{x:0,y:0},end:{x:this.width,y:0},lineWidth:this.axisLine.lineWidth,strokeStyle:this.axisLine.strokeStyle};if(this._axisLine)this._axisLine.animate(_);else{var y=new b({context:_});this.sprite.addChild(y),this._axisLine=y}}this._title&&(this._title.context.y=this.height-this._title.getTextHeight()/2,this._title.context.x=this.width/2,this.sprite.addChild(this._title))}else e.height=0}},{key:"_trimLayoutData",value:function(){var t=this.layoutData.length;this.enabled&&t&&("proportion"==this.layoutType&&this._checkOver(),"peak"==this.layoutType&&this._checkOver(),"rule"==this.layoutType&&this._checkOver())}},{key:"_getRootPR",value:function(){var t=0;return this._coord.app&&(t=this._coord.app.padding.right),t}},{key:"_checkOver",value:function(){var h=this,u=h.layoutData,d=u.length,f=h.label.textAlign;if(this.label.evade&&!h.trimLayout)!function t(e){var i=u[e];if(void 0!==i){i.visible=!0;for(var n=e;n<d-1;n++){var l=u[n+1],a=l.textWidth,o=i.textWidth;h.label.rotation&&(a=Math.min(a,22),o=Math.min(o,22));var s=l.x,r=i.x+o;if("center"==f&&(s=l.x-a/2,r=i.x+o/2),"right"==f&&(s=l.x-a,r=i.x),n==d-2&&s+a>h.width+h._getRootPR()&&("center"==f&&l.x+a/2>h.width&&(s=h.width-a,l._text_x=h.width-a/2+h._getRootPR()),"left"==f&&l.x+a>h.width&&(s=h.width-a,l._text_x=h.width-a)),!(s-r<1)){t(n+1);break}if(n==d-2)return l.visible=!0,void(i.visible=!1);l.visible=!1}}}(0);else{var t;p._.each(u,function(t){t.visible=!0}),h.trimLayout&&h.trimLayout(u);for(var e=d-1;0<=e&&!t;e--)u[e].visible&&(t=u[e]);t&&("center"==f&&t.x+t.textWidth/2>h.width&&(t._text_x=h.width-t.textWidth/2+h._getRootPR()),"left"==f&&t.x+t.textWidth>h.width&&(t._text_x=h.width-t.textWidth))}}}]),x);function x(t,e,i){var n;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,x),(n=function(t,e){return!e||"object"!==o(e)&&"function"!=typeof e?r(t):e}(this,s(x).call(this,t,e.org))).type="xAxis",n._coord=i||{},n._title=null,n._axisLine=null,n._formatTextSection=[],n._textElements=[],n.pos={x:0,y:0},n.layoutData=[],n.sprite=null,n.isH=!1,p._.extend(!0,r(n),(0,p.getDefaultProps)(x.defaultProps()),t),n.init(t),n}t.default=f});