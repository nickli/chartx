"use strict";!function(t,i){if("function"==typeof define&&define.amd)define(["exports","./index","canvax","./polar/grid","mmvis"],i);else if("undefined"!=typeof exports)i(exports,require("./index"),require("canvax"),require("./polar/grid"),require("mmvis"));else{var e={};i(e,t.index,t.canvax,t.grid,t.mmvis),t.undefined=e}}(void 0,function(t,i,e,a,M){Object.defineProperty(t,"__esModule",{value:!0});var n=r(i),l=r(e),o=r(a);function r(t){return t&&t.__esModule?t:{default:t}}function s(t){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function h(t){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function d(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function u(t,i){for(var e=0;e<i.length;e++){var a=i[e];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function c(t,i,e){return i&&u(t.prototype,i),e&&u(t,e),t}function f(t,i){return(f=Object.setPrototypeOf||function(t,i){return t.__proto__=i,t})(t,i)}var p=(function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(i&&i.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),i&&f(t,i)}(g,n.default),c(g,null,[{key:"defaultProps",value:function(){return{allAngle:{detail:"坐标系总角度",documentation:"",default:360,values:[0,360]},startAngle:{detail:"坐标系起始角度",documentation:"",default:0,values:[0,360]},radius:{detail:"坐标系的最大半径",documentation:"默认自动计算view的高宽，如果squareRange==true，则会取Math.min(width,height)",default:"auto",values:null},aAxis:{detail:"角度轴",documentation:"类似直角坐标系中的x轴",propertys:{data:[],angleList:[],layoutData:[],field:{detail:"数据字段",documentation:"",default:""},layoutType:{detail:"布局类型",documentation:"",default:"proportion"},beginAngle:{detail:"起始角度",documentation:"",default:-90},enabled:{detail:"是否显示",documentation:"",default:!1},label:{detail:"文本配置",documentation:"",propertys:{enabled:{detail:"是否显示",documentation:"",default:!0},format:{detail:"label的格式化处理函数",documentation:"",default:null},fontColor:{detail:"label颜色",documentation:"",default:"#666"}}}}},rAxis:{detail:"半径维度轴",documentation:"类似直角坐标系中的y轴维度",propertys:{field:{detail:"数据字段",documentation:"",default:""},dataSection:{detail:"轴的显示数据",documentation:"默认根据源数据中自动计算，用户也可以手动指定",default:!1},enabled:{detail:"是否显示",documentation:"",default:!1}}}}}}]),c(g,[{key:"setDefaultOpt",value:function(t,i){var e={rAxis:{field:[]},aAxis:{},grid:{}};M._.extend(!0,e,t),M._.isArray(e.rAxis.field)||(e.rAxis.field=[e.rAxis.field]);var a=M._.flatten([i._opt.graphs]),n=[];return M._.each(a,function(t){if(t.field){var i=t.field;M._.isArray(i)||(i=[i]),n=n.concat(i)}}),e.rAxis.field=e.rAxis.field.concat(n),t.aAxis&&t.aAxis.field?e.aAxis.enabled=!0:e.grid.enabled=!1,e}},{key:"init",value:function(){this._initModules(),this.fieldsMap=this.setFieldsMap({type:"rAxis"})}},{key:"_initModules",value:function(){this.grid.enabled&&(this._grid=new o.default(this.grid,this),this.sprite.addChild(this._grid.sprite)),this.aAxis.enabled&&this.grid.enabled&&(this._aAxisScaleSp=new l.default.Display.Sprite({id:"aAxisScaleSp"}),this.sprite.addChild(this._aAxisScaleSp)),this._axiss.push({type:"rAxis",field:this.rAxis.field})}},{key:"draw",value:function(){this._computeAttr(),this.rAxis.dataSection=this._getRDataSection(),this.aAxis.data=this.app.dataFrame.getFieldData(this.aAxis.field),this._setAAxisAngleList(),this.grid.enabled&&(this._grid.draw({pos:this.origin,width:this.width,height:this.height,dataSection:this.rAxis.dataSection},this),this.aAxis.enabled&&this._drawAAxis(),this._initInduce())}},{key:"resetData",value:function(){}},{key:"changeFieldEnabled",value:function(t){this.setFieldEnabled(t),this.rAxis.dataSection=this._getRDataSection(),this.aAxis.data=this.app.dataFrame.getFieldData(this.aAxis.field),this.grid.enabled&&this._grid.reset({dataSection:this.rAxis.dataSection},this)}},{key:"_getRDataSection",value:function(){var i=this;if(this._opt.rAxis&&this._opt.rAxis.dataSection)return this._opt.rAxis.dataSection;var e=[];return M._.each(M._.flatten([i.rAxis.field]),function(t){e=e.concat(i.app.dataFrame.getFieldData(t))}),e.push(0),M.dataSection.section(e,3)}},{key:"_computeAttr",value:function(){var t,i,e=this.app.padding,a=this.app.width,n=this.app.height;"width"in this._opt||(this.width=a-e.left-e.right),"height"in this._opt||(this.height=n-e.top-e.bottom);for(var o=this.width,r=this.height,s=0,l=0,h=0,d=0,u=[this.startAngle],c=0,f=parseInt((this.startAngle+this.allAngle)/90)-parseInt(this.startAngle/90);c<=f;c++){var p=90*parseInt(this.startAngle/90)+90*c;-1==M._.indexOf(u,p)&&p>u.slice(-1)[0]&&u.push(p)}var g=this.startAngle+this.allAngle;-1==M._.indexOf(u,g)&&u.push(g),M._.each(u,function(t){t%=360;var i=Math.sin(t*Math.PI/180);180==t&&(i=0);var e=Math.cos(t*Math.PI/180);270!=t&&90!=t||(e=0),s=Math.min(s,i),l=Math.max(l,i),h=Math.min(h,e),d=Math.max(d,e)}),i=(Math.abs(h)+Math.abs(d))/(Math.abs(s)+Math.abs(l));var x=Math.min(o,r);if(1==i)o=r=x;else{var A=r*i;o<A?r=o/i:o=A}var y=e.left+(this.width-o)/2,v=e.top+(this.height-r)/2;this.origin={x:y+o*(h/(h-d)),y:v+r*(s/(s-l))};var _={top:this.origin.y-v,right:y+o-this.origin.x,bottom:v+r-this.origin.y,left:this.origin.x-y},b=[],m=[["right","bottom"],["bottom","left"],["left","top"],["top","right"]];M._.each(u,function(t){t%=360;var i=parseInt(t/90),e=m[i];t%90==0&&(e=[["right","bottom","left","top"][i]]);var a=Math.sin(t*Math.PI/180);180==t&&(a=0);var n=Math.cos(t*Math.PI/180);270!=t&&90!=t||(n=0),M._.each(e,function(t){var i;"top"!=t&&"bottom"!=t||a&&(i=Math.abs(_[t]/a)),"right"!=t&&"left"!=t||n&&(i=Math.abs(_[t]/n)),b.push(i)})}),t=M._.min(b),this.aAxis.label.enabled&&(t-=20),this.radius=t}},{key:"getMaxDisToViewOfOrigin",value:function(){var t=this.origin,i=this.app.padding,e=this.app.width,a=this.app.height,n=e-i.left-i.right,o=a-i.top-i.bottom,r=[t.x-i.left,n+i.left-t.x,t.y-i.top,o+i.top-t.y];return M._.max(r)}},{key:"getRadiansAtR",value:function(t,i,e){var n=this;null==i&&(i=this.width),null==e&&(e=this.height);var a,o,r=[],s=this.app.padding,l={x:this.origin.x-s.left-(this.width-i)/2,y:this.origin.y-s.top-(this.height-e)/2},h=l.y;h<t&&(a=Math.sqrt(Math.pow(t,2)-Math.pow(h,2)),r=r.concat(this._filterPointsInRect([{x:-a,y:-h},{x:a,y:-h}],l,i,e)));var d=i-l.x;d<t&&(o=Math.sqrt(Math.pow(t,2)-Math.pow(d,2)),r=r.concat(this._filterPointsInRect([{x:d,y:-o},{x:d,y:o}],l,i,e)));var u=e-l.y;u<t&&(a=Math.sqrt(Math.pow(t,2)-Math.pow(u,2)),r=r.concat(this._filterPointsInRect([{x:a,y:u},{x:-a,y:u}],l,i,e)));var c=l.x;c<t&&(o=Math.sqrt(Math.pow(t,2)-Math.pow(c,2)),r=r.concat(this._filterPointsInRect([{x:-c,y:o},{x:-c,y:-o}],l,i,e)));var f=[];0==r.length?f.push([{point:{x:t,y:0},radian:0},{point:{x:t,y:0},radian:2*Math.PI}]):M._.each(r,function(t,i){var e=i==r.length-1?0:i+1,a=r.slice(e,e+1)[0];f.push([{point:t,radian:n.getRadianInPoint(t)},{point:a,radian:n.getRadianInPoint(a)}])});for(var p=0,g=f.length;p<g;p++)this._checkArcInRect(f[p],t,l,i,e)||(f.splice(p,1),p--,g--);return f}},{key:"_filterPointsInRect",value:function(t,i,e,a){for(var n=0,o=t.length;n<o;n++)this._checkPointInRect(t[n],i,e,a)||(t.splice(n,1),n--,o--);return t}},{key:"_checkPointInRect",value:function(t,i,e,a){var n=t.x+i.x,o=t.y+i.y;return!(n<0||e<n||o<0||a<o)}},{key:"_checkArcInRect",value:function(t,i,e,a,n){var o=t[0],r=t[1],s=r.radian-o.radian;r.radian<o.radian&&(s=2*Math.PI+r.radian-o.radian);var l=(o.radian+s/2)%(2*Math.PI);return this._checkPointInRect(this.getPointInRadianOfR(l,i),e,a,n)}},{key:"getRadianInPoint",value:function(t){var i=2*Math.PI;return(Math.atan2(t.y,t.x)+i)%i}},{key:"getPointInRadianOfR",value:function(t,i){var e=Math.PI,a=Math.cos(t)*i;t!=e/2&&t!=3*e/2||(a=0);var n=Math.sin(t)*i;return t%e==0&&(n=0),{x:a,y:n}}},{key:"getROfNum",value:function(t){var i=M._.max(this.rAxis.dataSection);return this.radius*((t-0)/(i-0))}},{key:"getPointsOfR",value:function(a){var n=this,o=[];return M._.each(n.aAxis.angleList,function(t){var i=Math.PI*t/180,e=n.getPointInRadianOfR(i,a);o.push(e)}),o}},{key:"_setAAxisAngleList",value:function(){var e=this;e.aAxis.angleList=[];var t=this.aAxis.data;if("proportion"==this.aAxis.layoutType){t=[];for(var i=0,a=this.aAxis.data.length;i<a;i++)t.push(i)}var n=this.allAngle,o=M._.max(t);"proportion"==this.aAxis.layoutType&&o++,M._.each(t,function(t){var i=(n*((t-0)/(o-0))+e.aAxis.beginAngle+n)%n;e.aAxis.angleList.push(i)})}},{key:"_drawAAxis",value:function(){var r=this,t=r.getROfNum(M._.max(this.rAxis.dataSection)),s=r.getPointsOfR(t+3);r._aAxisScaleSp.context.x=this.origin.x,r._aAxisScaleSp.context.y=this.origin.y,M._.each(this.aAxis.data,function(t,i){var e=s[i],a=M._.isFunction(r.aAxis.label.format)?r.aAxis.label.format(t):t,n={value:t,text:a,iNode:i,field:r.aAxis.field};if(r._getProp(r.aAxis.label.enabled,n)){var o={x:e.x,y:e.y,fillStyle:r._getProp(r.aAxis.label.fontColor,n)};M._.extend(o,r._getTextAlignForPoint(Math.atan2(e.y,e.x))),r._aAxisScaleSp.addChild(new l.default.Display.Text(a,{context:o})),r.aAxis.layoutData.push(a)}})}},{key:"_getTextAlignForPoint",value:function(t){var i="center",e="bottom";return t>-Math.PI/2&&t<0&&(i="left",e="bottom"),0==t&&(i="left",e="middle"),0<t&&t<Math.PI/2&&(i="left",e="top"),t==Math.PI/2&&(i="center",e="top"),t>Math.PI/2&&t<Math.PI&&(i="right",e="top"),t!=Math.PI&&t!=-Math.PI||(i="right",e="middle"),t>-Math.PI&&t<-Math.PI/2&&(i="right",e="bottom"),{textAlign:i,textBaseline:e}}},{key:"getAxisNodeOf",value:function(t){var i=this.getAAxisIndOf(t);if(void 0!==i)return{ind:i,value:this.aAxis.data[i],text:this.aAxis.layoutData[i],angle:this.aAxis.angleList[i]}}},{key:"getAAxisIndOf",value:function(t){var n=this;if(void 0!==t.aAxisInd)return t.aAxisInd;if(n.aAxis.angleList.length){var i=t.point,o=(180*n.getRadianInPoint(i)/Math.PI-n.aAxis.beginAngle)%n.allAngle,r=(Math.sqrt(Math.pow(i.x,2)+Math.pow(i.y,2)),0),s=n.aAxis.angleList.length;return M._.each(n.aAxis.angleList,function(t,i){t=(t-n.aAxis.beginAngle)%n.allAngle;var e=i+1,a=(n.aAxis.angleList[e]-n.aAxis.beginAngle)%n.allAngle;if(i==s-1&&(e=0,a=n.allAngle),t<=o&&o<=a)return r=o-t<a-o?i:e,!1}),r}}},{key:"_initInduce",value:function(){var i=this;i.induce=this._grid.induce,i.induce&&i.induce.on(M.event.types.get(),function(t){i.fire(t.type,t),i.app.fire(t.type,t)})}},{key:"getTipsInfoHandler",value:function(t){var i=this.getAxisNodeOf(t),e={nodes:[]};return i&&(e.aAxis=i,e.title=i.text,e.iNode=i.ind),t.eventInfo&&(e=M._.extend(e,t.eventInfo)),e}},{key:"getPoint",value:function(){}},{key:"getSizeAndOrigin",value:function(){}},{key:"_getProp",value:function(t,i,e){var a=t;return M._.isFunction(t)&&(a=t.apply(this,[i])),!a&&e&&(a=e),a}}]),g);function g(t,i){var e;return function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,g),(e=function(t,i){return!i||"object"!==s(i)&&"function"!=typeof i?d(t):i}(this,h(g).call(this,t,i))).type="polar",M._.extend(!0,d(e),(0,M.getDefaultProps)(g.defaultProps()),e.setDefaultOpt(t,i)),e.init(t),e}M.global.registerComponent(p,"coord","polar"),t.default=p});