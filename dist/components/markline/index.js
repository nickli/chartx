"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_component=_interopRequireDefault(require("../component")),_canvax=_interopRequireDefault(require("canvax")),_mmvis=require("mmvis"),BrokenLine=_canvax.default.Shapes.BrokenLine,Sprite=_canvax.default.Display.Sprite,Text=_canvax.default.Display.Text,MarkLine=function(e){function l(e,t){var i;return(0,_classCallCheck2.default)(this,l),(i=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(l).call(this,e,t))).name="markLine",i._yAxis=null,i.line={y:0,list:[]},i._txt=null,i._line=null,i.sprite=new Sprite,i.app.graphsSprite.addChild(i.sprite),_mmvis._.extend(!0,(0,_assertThisInitialized2.default)(i),(0,_mmvis.getDefaultProps)(l.defaultProps()),e),i}return(0,_inherits2.default)(l,e),(0,_createClass2.default)(l,null,[{key:"defaultProps",value:function(){return{markTo:{detail:"标准哪个目标字段",default:null},yVal:{detail:"组件的值",default:0,documentation:"可能是个function，均值计算就是个function"},line:{detail:"线的配置",propertys:{strokeStyle:{detail:"线的颜色",default:"#999999"},lineWidth:{detail:"线宽",default:1},lineType:{detail:"线样式",default:"dashed"}}},label:{detail:"文本",propertys:{enabled:{detail:"是否开启",default:!1},fontColor:{detail:"文本字体颜色",default:"#999999"},fontSize:{detail:"文本字体大小",default:12},text:{detail:"文本内容",default:null},format:{detail:"文本格式化函数",default:null}}}}}}]),(0,_createClass2.default)(l,[{key:"draw",value:function(){this._calculateProps(),this.setPosition(),this.widget()}},{key:"_calculateProps",value:function(){var e=this._opt,l=e.markTo,t=this.app.getComponent({name:"coord"});if(!l||-1!=_mmvis._.indexOf(this.app.dataFrame.fields,l)){var i,a=t._yAxis[0];l&&_mmvis._.each(t._yAxis,function(e,t){var i=_mmvis._.flatten([e.field]);0<=_mmvis._.indexOf(i,l)&&(a=e)}),e.yAxisAlign&&(a=t._yAxis["left"==e.yAxisAlign?0:1]),i=void 0!==e.y&&null!==e.y?Number(e.y):function(){var e=this.app.dataFrame.getFieldData(l),t=0;return _mmvis._.each(e,function(e){Number(e)&&(t+=e)}),t/e.length},isNaN(i)||a.drawWaterLine(i);var n="#777",r=t.getFieldMapOf(l);r&&(n=r.color);var s=e.line&&e.line.strokeStyle||n,u=e.label&&e.label.fontColor||n;this._yAxis=a,this.width=t.width,this.height=t.height,this.yVal=i,this.pos={x:t.origin.x,y:t.origin.y},this.line.list=[[0,0],[this.width,0]],this.label.fontColor=u,s&&(this.line.strokeStyle=s)}}},{key:"widget",value:function(){var e=this,t=this._getYPos(),i=new BrokenLine({id:"line",context:{y:t,pointList:e.line.list,strokeStyle:e.line.strokeStyle,lineWidth:e.line.lineWidth,lineType:e.line.lineType}});if(e.sprite.addChild(i),e._line=i,e.label.enabled){var l=new Text(e._getLabel(),{context:e.label});this._txt=l,e.sprite.addChild(l),e._setTxtPos(t)}this.line.y=t}},{key:"reset",value:function(e){e&&_mmvis._.extend(!0,this,e);var t=this,i=this._getYPos();i!=this.line.y&&this._line.animate({y:i},{duration:300,onUpdate:function(e){t.label.enabled&&(t._txt.resetText(t._getLabel()),t._setTxtPos(e.y))}}),this._line.context.strokeStyle=this.line.strokeStyle,this.line.y=i}},{key:"_setTxtPos",value:function(e){var t=this,i=t._txt;"left"==this._yAxis.align?i.context.x=5:i.context.x=this.width-i.getTextWidth()-5,_mmvis._.isNumber(t.label.y)?i.context.y=t.label.y:i.context.y=e-i.getTextHeight()}},{key:"_getYVal",value:function(e){var t=e=e||this.yVal;return _mmvis._.isFunction(e)&&(t=e.apply(this)),t}},{key:"_getYPos",value:function(){return-this._yAxis.getPosOfVal(this._getYVal())}},{key:"_getLabel",value:function(){var e=this._getYVal();return _mmvis._.isFunction(this.label.format)?this.label.format(e,this):_mmvis._.isString(this.label.text)?this.label.text:e}}]),l}(_component.default);_mmvis.global.registerComponent(MarkLine,"markLine");var _default=MarkLine;exports.default=_default;