"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_component=_interopRequireDefault(require("../component")),_canvax=_interopRequireDefault(require("canvax")),_mmvis=require("mmvis"),_trigger=_interopRequireDefault(require("../trigger")),Line=_canvax.default.Shapes.Line,Rect=_canvax.default.Shapes.Rect,dataZoom=function(t){function n(t,e){var i;return(0,_classCallCheck2.default)(this,n),(i=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(n).call(this,t,e))).name="dataZoom",i._cloneChart=null,i.count=1,i.dataLen=1,i.axisLayoutType=null,i.dragIng=function(){},i.dragEnd=function(){},i.disPart={},i._btnLeft=null,i._btnRight=null,i._underline=null,i.sprite=new _canvax.default.Display.Sprite({id:"dataZoom",context:{x:i.pos.x,y:i.pos.y}}),i.sprite.noSkip=!0,i.dataZoomBg=new _canvax.default.Display.Sprite({id:"dataZoomBg"}),i.dataZoomBtns=new _canvax.default.Display.Sprite({id:"dataZoomBtns"}),i.sprite.addChild(i.dataZoomBg),i.sprite.addChild(i.dataZoomBtns),e.stage.addChild(i.sprite),_mmvis._.extend(!0,(0,_assertThisInitialized2.default)(i),(0,_mmvis.getDefaultProps)(n.defaultProps()),t),"margin"in t||("bottom"==i.position&&(i.margin.top=10),"top"==i.position&&(i.margin.bottom=10)),i.axis=null,i.layout(),i}return(0,_inherits2.default)(n,t),(0,_createClass2.default)(n,null,[{key:"defaultProps",value:function(){return{position:{detail:"位置",default:"bottom"},direction:{detail:"方向",default:"h"},height:{detail:"高",default:26},width:{detail:"宽",default:100},color:{detail:"颜色",default:"#008ae6"},range:{detail:"范围设置",propertys:{start:{detail:"开始位置",default:0},end:{detail:"结束位置，默认为null，表示到最后",default:null},max:{detail:"可以外围控制智能在哪个区间拖动",default:null},min:{detail:"最少至少选中了几个数据",default:1}}},left:{detail:"左边按钮",propertys:{eventEnabled:{detail:"是否响应事件",default:!0},fillStyle:{detail:"颜色，默认取组件.color",default:null}}},right:{detail:"右边按钮",propertys:{eventEnabled:{detail:"是否响应事件",default:!0},fillStyle:{detail:"颜色，默认取组件.color",default:null}}},center:{detail:"中间位置设置",propertys:{eventEnabled:{detail:"是否响应事件",default:!0},fillStyle:{detail:"填充色",default:"#000000"},alpha:{detail:"透明度",default:.015}}},bg:{detail:"背景设置",propertys:{enabled:{detail:"是否开启",default:!0},fillStyle:{detail:"填充色",default:""},strokeStyle:{detail:"边框色",default:"#e6e6e6"},lineWidth:{detail:"线宽",default:1}}},graphAlpha:{detail:"图形的透明度",default:.6},graphStyle:{detail:"图形的颜色",default:"#dddddd"},underline:{detail:"underline",propertys:{enabled:{detail:"是否开启",default:!0},strokeStyle:{detail:"线条色",default:null},lineWidth:{detail:"线宽",default:2}}},btnOut:{detail:"left,right按钮突出的大小",default:6},btnHeight:{detail:"left,right按钮高",default:20,documentation:"left,right按钮的高，不在left，right下面，统一在这个属性里， 以为要强制保持一致"},btnWidth:{detail:"left,right按钮的宽",default:8,documentation:"left,right按钮的宽，不在left，right下面，统一在这个属性里， 以为要强制保持一致"}}}}]),(0,_createClass2.default)(n,[{key:"layout",value:function(){var t=this.app;"bottom"==this.position&&(this.pos.y=t.height-(this.height+t.padding.bottom+this.margin.bottom),t.padding.bottom+=this.height+this.margin.top+this.margin.bottom),"top"==this.position&&(this.pos.y=t.padding.top+this.margin.top,t.padding.top+=this.height+this.margin.top+this.margin.bottom)}},{key:"_getCloneChart",value:function(){var d=this,r=this.app,s=r.getCoord(),t=r.constructor,e=r.el.cloneNode();e.innerHTML="",e.id=r.el.id+"_currclone",e.style.position="absolute",e.style.width=this.width+"px",e.style.height=this.btnHeight+"px",e.style.top="10000px",document.body.appendChild(e);var h=[];_mmvis._.each(r.getComponents({name:"graphs"}),function(t){var e=t.enabledField||t.field;if(_mmvis._.flatten([e]).length){var i=_mmvis._.extend(!0,{},t._opt);i.field=e;var n={};"bar"==t.type&&(n={node:{}},d.graphStyle&&(n.node.fillStyle=d.graphStyle)),"line"==t.type&&(n={line:{lineWidth:1},node:{enabled:!1},area:{}},d.graphStyle&&(n.line.strokeStyle=d.graphStyle,n.area.fillStyle=d.graphStyle));var a=s.height||r.el.offsetHeight,o=d.btnHeight/a||1;"scat"==t.type&&(n={node:{radiusScale:o}},d.graphStyle),h.push(_mmvis._.extend(!0,i,n,{label:{enabled:!1},animation:!1}))}});var i={coord:r._opt.coord,graphs:h};i.coord.horizontal&&delete i.coord.horizontal,i.coord.enabled=!1,i.coord.padding=0;var n=new t(e,r._data,i,r.componentModules);return n.draw(),{thumbChart:n,cloneEl:e}}},{key:"_setDataZoomOpt",value:function(){var e=this.app,t=e.getComponent({name:"coord"}).getSizeAndOrigin(),o=this;_mmvis._.extend(!0,this,{width:parseInt(t.width),pos:{x:t.origin.x},dragIng:function(a){var t;"proportion"==o.axisLayoutType?(t=new _trigger.default(o,{min:a.start,max:a.end}),e.dataFrame.filters.datazoom=function(t){var e=t[o.axis.field],i=o.axis.getValOfPos(a.start),n=o.axis.getValOfPos(a.end);return i<=e&&e<=n}):(t=new _trigger.default(o,{left:e.dataFrame.range.start-a.start,right:a.end-e.dataFrame.range.end}),_mmvis._.extend(e.dataFrame.range,a)),e.resetData(null,t),e.fire("dataZoomDragIng")},dragEnd:function(){e.updateChecked&&e.updateChecked(),e.fire("dataZoomDragEnd")}})}},{key:"draw",value:function(){this._setDataZoomOpt(),this._cloneChart=this._getCloneChart(),this.axis=this._cloneChart.thumbChart.getComponent({name:"coord"})._xAxis,this.axisLayoutType=this.axis.layoutType,this._computeAttrs(),this.widget(),this._setLines(),this.setZoomBg(),this.setPosition()}},{key:"destroy",value:function(){this.sprite.destroy()}},{key:"reset",value:function(t){t=t||{};var e=this.count,i=this.range.start,n=this.range.end;t&&_mmvis._.extend(!0,this,t),this._cloneChart=this._getCloneChart(),this._computeAttrs(t),e==this.count&&(!t.range||t.range.start==i&&t.range.end==n)||(this.widget(),this._setLines()),this.setZoomBg()}},{key:"_computeAttrs",value:function(){var t=this._cloneChart.thumbChart;switch(this.dataLen=t.dataFrame.length,this.axisLayoutType){case"rule":this.count=this.dataLen-1;break;case"peak":this.count=this.dataLen;break;case"proportion":this.count=this.width}(!this._opt.range||this._opt.range&&!this._opt.range.max||this.range.max>this.count)&&(this.range.max=this.count-1),(!this._opt.range||this._opt.range&&!this._opt.range.end||this.range.end>this.dataLen-1)&&(this.range.end=this.dataLen-1,"proportion"==this.axisLayoutType&&(this.range.end=this.count-1)),!this.direction&&this.position&&("left"==this.position||"right"==this.position?this.direction="v":this.direction="h"),this.disPart=this._getDisPart(),this.btnHeight=this.height-this.btnOut}},{key:"_getDisPart",value:function(){var t=this,e=Math.max(parseInt(t.range.min/2/t.count*t.width),23),i=parseInt((t.range.max+1)/t.count*t.width);return"peak"==this.axisLayoutType&&(e=Math.max(parseInt(t.range.min/t.count*t.width),23)),"proportion"==this.axisLayoutType&&(i=t.width),{min:e,max:i}}},{key:"_getRangeEnd",value:function(t){return void 0===t&&(t=this.range.end),"peak"==this.axisLayoutType&&(t+=1),"proportion"==this.axisLayoutType&&(t+=1),t}},{key:"widget",value:function(){function t(){e._setLines.apply(e,arguments)}var e=this;if(e.bg.enabled){var i={x:0,y:0,width:e.width,height:e.btnHeight,lineWidth:e.bg.lineWidth,strokeStyle:e.bg.strokeStyle,fillStyle:e.bg.fillStyle};e._bgRect?e._bgRect.animate(i,{onUpdate:t}):(e._bgRect=new Rect({context:i}),e.dataZoomBg.addChild(e._bgRect))}if(e.underline.enabled){var n={start:{x:e.range.start/e.count*e.width+e.btnWidth/2,y:e.btnHeight},end:{x:e._getRangeEnd()/e.count*e.width-e.btnWidth/2,y:e.btnHeight},lineWidth:e.underline.lineWidth,strokeStyle:e.underline.strokeStyle||e.color};e._underline?e._underline.animate(n,{onUpdate:t}):(e._underline=e._addLine(n),e.dataZoomBg.addChild(e._underline))}var a={x:e.range.start/e.count*e.width,y:-e.btnOut/2+1,width:e.btnWidth,height:e.btnHeight+e.btnOut,fillStyle:e.left.fillStyle||e.color,cursor:e.left.eventEnabled&&"move"};e._btnLeft?e._btnLeft.animate(a,{onUpdate:t}):(e._btnLeft=new Rect({id:"btnLeft",dragEnabled:e.left.eventEnabled,context:a}),e._btnLeft.on("draging",function(t){this.context.y=-e.btnOut/2+1,this.context.x<0&&(this.context.x=0),this.context.x>e._btnRight.context.x-e.btnWidth-2&&(this.context.x=e._btnRight.context.x-e.btnWidth-2),e._btnRight.context.x+e.btnWidth-this.context.x>=e.disPart.max&&(this.context.x=e._btnRight.context.x+e.btnWidth-e.disPart.max),e._btnRight.context.x+e.btnWidth-this.context.x<e.disPart.min&&(this.context.x=e._btnRight.context.x+e.btnWidth-e.disPart.min),e.rangeRect.context.width=e._btnRight.context.x-this.context.x-e.btnWidth,e.rangeRect.context.x=this.context.x+e.btnWidth,e._setRange()}),e._btnLeft.on("dragend",function(t){e.dragEnd(e.range)}),this.dataZoomBtns.addChild(this._btnLeft));var o={x:e._getRangeEnd()/e.count*e.width-e.btnWidth,y:-e.btnOut/2+1,width:e.btnWidth,height:e.btnHeight+e.btnOut,fillStyle:e.right.fillStyle||e.color,cursor:e.right.eventEnabled&&"move"};e._btnRight?e._btnRight.animate(o,{onUpdate:t}):(e._btnRight=new Rect({id:"btnRight",dragEnabled:e.right.eventEnabled,context:o}),e._btnRight.on("draging",function(t){this.context.y=-e.btnOut/2+1,this.context.x>e.width-e.btnWidth&&(this.context.x=e.width-e.btnWidth),this.context.x+e.btnWidth-e._btnLeft.context.x>=e.disPart.max&&(this.context.x=e.disPart.max-(e.btnWidth-e._btnLeft.context.x)),this.context.x+e.btnWidth-e._btnLeft.context.x<e.disPart.min&&(this.context.x=e.disPart.min-e.btnWidth+e._btnLeft.context.x),e.rangeRect.context.width=this.context.x-e._btnLeft.context.x-e.btnWidth,e._setRange()}),e._btnRight.on("dragend",function(t){e.dragEnd(e.range)}),this.dataZoomBtns.addChild(this._btnRight));var d={x:a.x+e.btnWidth,y:1,width:o.x-a.x-e.btnWidth,height:this.btnHeight-1,fillStyle:e.center.fillStyle,fillAlpha:e.center.alpha,cursor:"move"};this.rangeRect?this.rangeRect.animate(d,{onUpdate:t}):(this.rangeRect=new Rect({id:"btnCenter",dragEnabled:!0,context:d}),this.rangeRect.on("draging",function(t){this.context.y=1,this.context.x<e.btnWidth&&(this.context.x=e.btnWidth),this.context.x>e.width-this.context.width-e.btnWidth&&(this.context.x=e.width-this.context.width-e.btnWidth),e._btnLeft.context.x=this.context.x-e.btnWidth,e._btnRight.context.x=this.context.x+this.context.width,e._setRange("btnCenter")}),this.rangeRect.on("dragend",function(t){e.dragEnd(e.range)}),this.dataZoomBtns.addChild(this.rangeRect)),this.linesLeft||(this.linesLeft=new _canvax.default.Display.Sprite({id:"linesLeft"}),this.left.eventEnabled&&this._addLines({sprite:this.linesLeft}),this.dataZoomBtns.addChild(this.linesLeft)),this.linesRight||(this.linesRight=new _canvax.default.Display.Sprite({id:"linesRight"}),this.right.eventEnabled&&this._addLines({sprite:this.linesRight}),this.dataZoomBtns.addChild(this.linesRight)),this.linesCenter||(this.linesCenter=new _canvax.default.Display.Sprite({id:"linesCenter"}),this._addLines({count:3,sprite:this.linesCenter,strokeStyle:this.color}),this.dataZoomBtns.addChild(this.linesCenter))}},{key:"_setRange",value:function(t){var e=this,i=e._getRangeEnd(),n=i-e.range.start,a=e._btnLeft.context.x/e.width*e.count,o=(e._btnRight.context.x+e.btnWidth)/e.width*e.count;o="peak"==this.axisLayoutType?(a=Math.round(a),Math.round(o)):(this.axisLayoutType,a=parseInt(a),parseInt(o)),"btnCenter"==t&&o-a!=n&&(o=a+n),a==e.range.start&&o==i||(e.range.start=a,"peak"==e.axisLayoutType&&--o,e.range.end=o,e.dragIng(e.range)),e._setLines()}},{key:"_setLines",value:function(){var t=this,e=this.linesLeft,i=this.linesRight,n=this.linesCenter,a=this._btnLeft,o=this._btnRight,d=this.rangeRect;e.context.x=a.context.x+(a.context.width-e.context.width)/2,e.context.y=a.context.y+(a.context.height-e.context.height)/2,i.context.x=o.context.x+(o.context.width-i.context.width)/2,i.context.y=o.context.y+(o.context.height-i.context.height)/2,n.context.x=d.context.x+(d.context.width-n.context.width)/2,n.context.y=d.context.y+(d.context.height-n.context.height)/2,t.underline.enabled&&(t._underline.context.start.x=e.context.x+t.btnWidth/2,t._underline.context.end.x=i.context.x+t.btnWidth/2)}},{key:"_addLines",value:function(t){for(var e=t.count||2,i=t.sprite,n=t.dis||2,a=0,o=e;a<o;a++)i.addChild(this._addLine({x:a*n,strokeStyle:t.strokeStyle||""}));i.context.width=a*n-1,i.context.height=6}},{key:"_addLine",value:function(t){var e=t||{};return new Line({id:e.id||"",context:{x:e.x||0,y:e.y||0,start:{x:e.start?e.start.x:0,y:e.start?e.start.y:0},end:{x:e.end?e.end.x:0,y:e.end?e.end.y:6},lineWidth:e.lineWidth||1,strokeStyle:e.strokeStyle||"#ffffff"}})}},{key:"setZoomBg",value:function(){this.__graphssp&&this.__graphssp.destroy();var t=this._cloneChart.thumbChart.graphsSprite;t.setEventEnable(!1);var e=this._cloneChart.thumbChart.getComponent({name:"coord"});t.id=t.id+"_datazoomthumbChartbg",t.context.x=-e.origin.x,t.context.scaleY=this.btnHeight/e.height,t.context.scaleX=this.width/e.width,t.context.globalAlpha=this.graphAlpha,this.dataZoomBg.addChild(t,0),this.__graphssp=t,this._cloneChart.thumbChart.destroy(),this._cloneChart.cloneEl.parentNode.removeChild(this._cloneChart.cloneEl)}}]),n}(_component.default);_mmvis.global.registerComponent(dataZoom,"dataZoom");var _default=dataZoom;exports.default=_default;