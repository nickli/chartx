"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_component=_interopRequireDefault(require("../component")),_canvax=_interopRequireDefault(require("canvax")),_tools=require("../../utils/tools"),_mmvis=require("mmvis"),Rect=_canvax.default.Shapes.Rect,Line=_canvax.default.Shapes.Line,Tips=function(t){function o(t,e){var i;(0,_classCallCheck2.default)(this,o),(i=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(o).call(this,t,e))).name="tips",i.tipDomContainer=i.app.canvax.domView,i.cW=0,i.cH=0,i.dW=0,i.dH=0,i._tipDom=null,i._tipsPointer=null,i.eventInfo=null,i.sprite=null,i.sprite=new _canvax.default.Display.Sprite({id:"TipSprite"}),i.app.stage.addChild(i.sprite);var n=(0,_assertThisInitialized2.default)(i);return i.sprite.on("destroy",function(){n._tipDom=null}),_mmvis._.extend(!0,(0,_assertThisInitialized2.default)(i),(0,_mmvis.getDefaultProps)(o.defaultProps()),t),i}return(0,_inherits2.default)(o,t),(0,_createClass2.default)(o,null,[{key:"defaultProps",value:function(){return{enabled:{detail:"是否开启Tips",default:!0},content:{detail:"自定义tips的内容（html）",default:null},borderRadius:{detail:"tips的边框圆角半径",default:5},strokeStyle:{detail:"tips边框颜色",default:"#ccc"},fillStyle:{detail:"tips背景色",default:"rgba(255,255,255,0.95)"},fontColor:{detail:"tips文本颜色",default:"#999999"},positionOfPoint:{detail:"tips在触发点的位置，默认在右侧",default:"right"},offsetX:{detail:"tips内容到鼠标位置的偏移量x",default:10},offsetY:{detail:"tips内容到鼠标位置的偏移量y",default:10},positionInRange:{detail:"tip的浮层是否限定在画布区域",default:!0},pointer:{detail:"触发tips的时候的指针样式",default:"line",documentation:'tips的指针,默认为直线，可选为："line" | "region"(柱状图中一般用region)'},pointerAnim:{detail:"tips移动的时候，指针是否开启动画",default:!0}}}}]),(0,_createClass2.default)(o,[{key:"show",value:function(t){if(this.enabled){if(t.eventInfo){this.eventInfo=t.eventInfo;var e=t.target.getStage();e?(this.cW=e.context.width,this.cH=e.context.height):"canvax"==t.target.type&&(this.cW=t.target.width,this.cH=t.target.height),this._setContent(t)?(this._setPosition(t),this.sprite.toFront()):this.hide(t)}this._tipsPointerShow(t)}}},{key:"move",value:function(t){if(this.enabled){if(t.eventInfo)this.eventInfo=t.eventInfo,this._setContent(t)?this._setPosition(t):this._hideDialogTips();this._tipsPointerMove(t)}}},{key:"hide",value:function(t){this.enabled&&(this._hideDialogTips(t),this._tipsPointerHide(t))}},{key:"_hideDialogTips",value:function(){this.eventInfo&&(this.eventInfo=null,this.sprite.removeAllChildren(),this._removeContent())}},{key:"_setPosition",value:function(t){if(this.enabled&&this._tipDom){var e=t.pos||t.target.localToGlobal(t.point),i=this._checkX(e.x+this.offsetX),n=this._checkY(e.y+this.offsetY);this._tipDom.style.cssText+=";visibility:visible;left:"+i+"px;top:"+n+"px;-webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;","left"==this.positionOfPoint&&(this._tipDom.style.left=this._checkX(e.x-this.offsetX-this._tipDom.offsetWidth)+"px")}}},{key:"_creatTipDom",value:function(){this._tipDom=document.createElement("div"),this._tipDom.className="chart-tips",this._tipDom.style.cssText+="; border-radius:"+this.borderRadius+"px;background:"+this.fillStyle+";border:1px solid "+this.strokeStyle+";visibility:hidden;position:absolute;enabled:inline-block;*enabled:inline;*zoom:1;padding:6px;color:"+this.fontColor+";line-height:1.5",this._tipDom.style.cssText+="; box-shadow:1px 1px 3px "+this.strokeStyle+";",this._tipDom.style.cssText+="; border:none;white-space:nowrap;word-wrap:normal;",this._tipDom.style.cssText+="; text-align:left;",this.tipDomContainer.appendChild(this._tipDom)}},{key:"_removeContent",value:function(){this._tipDom&&(this.tipDomContainer.removeChild(this._tipDom),this._tipDom=null)}},{key:"_setContent",value:function(t){var e=this._getContent(t);if(e||0===e)return this._tipDom||this._creatTipDom(t),this._tipDom.innerHTML=e,this.dW=this._tipDom.offsetWidth,this.dH=this._tipDom.offsetHeight,e}},{key:"_getContent",value:function(t){return this.content?_mmvis._.isFunction(this.content)?this.content(t.eventInfo,t):this.content:this._getDefaultContent(t.eventInfo)}},{key:"_getDefaultContent",value:function(t){var r="";return t.nodes.length&&(void 0!==t.title&&null!==t.title&&""!==t.title&&(r+="<div style='font-size:14px;border-bottom:1px solid #f0f0f0;padding:4px;margin-bottom:6px;'>"+t.title+"</div>"),_mmvis._.each(t.nodes,function(t,e){var i=t.color||t.fillStyle||t.strokeStyle,n=t.name||t.field||t.content,o="object"==(0,_typeof2.default)(t.value)?JSON.stringify(t.value):(0,_tools.numAddSymbol)(t.value),s=t.value||0==t.value;r+="<div style='line-height:1.5;font-size:12px;padding:0 4px;'>",i&&(r+="<span style='background:"+i+";margin-right:8px;margin-top:7px;float:left;width:8px;height:8px;border-radius:4px;overflow:hidden;font-size:0;'></span>"),n&&(r+="<span style='margin-right:5px;'>"+n,s&&(r+="："),r+="</span>"),s&&(r+=o),r+="</div>"})),r}},{key:"_checkX",value:function(t){if(this.positionInRange){var e=this.dW+2;t<0&&(t=0),t+e>this.cW&&(t=this.cW-e)}return t}},{key:"_checkY",value:function(t){if(this.positionInRange){var e=this.dH+2;t<0&&(t=0),t+e>this.cH&&(t=this.cH-e)}return t}},{key:"_tipsPointerShow",value:function(t){if(t.eventInfo&&t.eventInfo.xAxis){var e=this.app.getComponent({name:"coord"});if(e&&"rect"==e.type&&this.pointer){var i=this._tipsPointer,n=e.origin.y-e.height,o=0;if("line"==this.pointer&&(o=e.origin.x+t.eventInfo.xAxis.x),"region"==this.pointer){var s=e._xAxis.getCellLengthOfPos(t.eventInfo.xAxis.x);o=e.origin.x+t.eventInfo.xAxis.x-s/2,t.eventInfo.xAxis.ind<0&&(o=e.origin.x)}if(i)this.pointerAnim&&"proportion"!=e._xAxis.layoutType?(i.__animation&&i.__animation.stop(),i.__animation=i.animate({x:o,y:n},{duration:200})):(i.context.x=o,i.context.y=n);else{if("line"==this.pointer&&(i=new Line({context:{x:o,y:n,start:{x:0,y:0},end:{x:0,y:e.height},lineWidth:1,strokeStyle:"#cccccc"}})),"region"==this.pointer){s=e._xAxis.getCellLengthOfPos(o);i=new Rect({context:{width:s,height:e.height,x:o,y:n,fillStyle:"#cccccc",globalAlpha:.3}})}this.app.graphsSprite.addChild(i,0),this._tipsPointer=i}}}}},{key:"_tipsPointerHide",value:function(t){if(t.eventInfo&&t.eventInfo.xAxis){var e=this.app.getComponent({name:"coord"});e&&"rect"==e.type&&this.pointer&&this._tipsPointer&&(this._tipsPointer.destroy(),this._tipsPointer=null)}}},{key:"_tipsPointerMove",value:function(t){if(t.eventInfo&&t.eventInfo.xAxis){var e=this.app.getComponent({name:"coord"});if(e&&"rect"==e.type&&this.pointer&&this._tipsPointer){var i=this._tipsPointer,n=e.origin.x+t.eventInfo.xAxis.x;if("region"==this.pointer){var o=e._xAxis.getCellLengthOfPos(t.eventInfo.xAxis.x);n=e.origin.x+t.eventInfo.xAxis.x-o/2,t.eventInfo.xAxis.ind<0&&(n=e.origin.x)}var s=e.origin.y-e.height;n!=i.__targetX&&(this.pointerAnim&&"proportion"!=e._xAxis.layoutType?(i.__animation&&i.__animation.stop(),i.__targetX=n,i.__animation=i.animate({x:n,y:s},{duration:200,onComplete:function(){delete i.__targetX,delete i.__animation}})):(i.context.x=n,i.context.y=s))}}}}]),o}(_component.default);_mmvis.global.registerComponent(Tips,"tips");var _default=Tips;exports.default=_default;