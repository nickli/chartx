"use strict";!function(e,t){if("function"==typeof define&&define.amd)define(["exports","canvax","../index","../../../layout/venn/layout","../../../layout/venn/circleintersection","fmin","mmvis"],t);else if("undefined"!=typeof exports)t(exports,require("canvax"),require("../index"),require("../../../layout/venn/layout"),require("../../../layout/venn/circleintersection"),require("fmin"),require("mmvis"));else{var n={};t(n,e.canvax,e.index,e.layout,e.circleintersection,e.fmin,e.mmvis),e.undefined=n}}(void 0,function(e,t,n,u,v,f,y){Object.defineProperty(e,"__esModule",{value:!0});var l=i(t),a=i(n);function i(e){return e&&e.__esModule?e:{default:e}}function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function d(e,t){for(var n=0;n<t.length;n++){var l=t[n];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(e,l.key,l)}}function h(e,t,n){return t&&d(e.prototype,t),n&&d(e,n),e}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var _=l.default.Display.Text,g=l.default.Shapes.Path,b=l.default.Shapes.Circle,p=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(x,a.default),h(x,null,[{key:"defaultProps",value:function(){return{keyField:{detail:"key字段",default:"name"},valueField:{detail:"value字段",default:"value"},node:{detail:"单个节点配置",propertys:{strokeStyle:{detail:"边框颜色",default:null},lineWidth:{detail:"边框大小",default:2},strokeAlpha:{detail:"边框透明度",default:0},fillStyle:{detail:"背景色",default:null},fillAlpha:{detail:"背景透明度",default:.25},focus:{detail:"hover设置",propertys:{enabled:{detail:"是否开启",default:!0},strokeAlpha:{detail:"边框透明度",default:.3}}},select:{detail:"选中设置",propertys:{enabled:{detail:"是否开启",default:!0},lineWidth:{detail:"描边宽度",default:2},strokeStyle:{detail:"描边颜色",default:"#666666"}}}}},label:{detail:"文本设置",propertys:{field:{detail:"获取文本的字段",default:null},fontSize:{detail:"字体大小",default:14},fontColor:{detail:"文本颜色",default:null},fontWeight:{detail:"fontWeight",default:"normal"},showInter:{detail:"是否显示相交部分的文本",default:!0}}}}}}]),h(x,[{key:"init",value:function(){this.venn_circles=new l.default.Display.Sprite({id:"venn_circles"}),this.sprite.addChild(this.venn_circles),this.venn_paths=new l.default.Display.Sprite({id:"venn_paths"}),this.sprite.addChild(this.venn_paths),this.venn_labels=new l.default.Display.Sprite({id:"venn_labels"}),this.sprite.addChild(this.venn_labels)}},{key:"draw",value:function(e){e=e||{},y._.extend(!0,this,e),this.data=this._trimGraphs(),this._widget(),this.sprite.context.x=this.app.padding.left,this.sprite.context.y=this.app.padding.top,this.fire("complete")}},{key:"resetData",value:function(e){this.dataFrame=e,this.data=this._trimGraphs(),this._widget()}},{key:"_trimGraphs",value:function(){var l=this,e=l._vennData(),t=u.venn,n=u.lossFunction,a=Math.PI/2,i={},r={};if(this._dataCircleLen=0,this._dataLabelLen=0,(this._dataPathLen=0)<e.length){var o=t(e,{lossFunction:n});o=(0,u.normalizeSolution)(o,a,null),i=(0,u.scaleSolution)(o,this.width,this.height,0),r=function(e,t){for(var n={},l=function(e){var t={},n=[];for(var l in e)n.push(l),t[l]=[];for(var a=0;a<n.length;a++)for(var i=e[n[a]],r=a+1;r<n.length;++r){var o=e[n[r]],s=(0,v.distance)(i,o);s+o.radius<=i.radius+1e-10?t[n[r]].push(n[a]):s+i.radius<=o.radius+1e-10&&t[n[a]].push(n[r])}return t}(e),a=0;a<t.length;++a){for(var i=t[a].sets,r={},o={},s=0;s<i.length;++s){r[i[s]]=!0;for(var d=l[i[s]],u=0;u<d.length;++u)o[d[u]]=!0}var h=[],f=[];for(var c in e)c in r?h.push(e[c]):c in o||f.push(e[c]);var p=k(h,f);(n[i]=p).disjoint&&0<t[a].size&&console.log("WARNING: area "+i+" not represented on screen")}return n}(i,e)}var s=0,d=0;return y._.each(e,function(e,t){if(e.label&&(1<e.sets.length&&!l.label.showInter||(e.labelPosition=r[e.nodeId],l._dataLabelLen++)),1<e.sets.length){var n=function(e){var t={};(0,v.intersectionArea)(e,t);var n=t.arcs;if(0===n.length)return"M 0 0";if(1==n.length){var l=n[0].circle;return function(e,t,n){var l=[];return l.push("\nM",e,t),l.push("\nm",-n,0),l.push("\na",n,n,0,1,0,2*n,0),l.push("\na",n,n,0,1,0,2*-n,0),l.join(" ")}(l.x,l.y,l.radius)}for(var a=["\nM",n[0].p2.x,n[0].p2.y],i=0;i<n.length;++i){var r=n[i],o=r.circle.radius,s=r.width>o;a.push("\nA",o,o,0,s?1:0,1,r.p1.x,r.p1.y)}return a.join(" ")+" z"}(e.sets.map(function(e){return i[e]}));e.shape={type:"path",path:n,pathInd:d++},l._dataPathLen++}else 1==e.sets.length&&(e.shape=y._.extend({type:"circle",circleInd:s++},i[e.nodeId]),l._dataCircleLen++)}),e}},{key:"_vennData",value:function(){for(var e=[],t=0,n=this.dataFrame.length;t<n;t++){var l=this.dataFrame.getRowDataAt(t),a={type:"venn",iNode:t,nodeId:null,rowData:l,sets:null,size:null,value:null,fillStyle:null,strokeStyle:null,label:null,labelPosition:null};for(var i in l){var r=l[i];i==this.keyField?(y._.isArray(r)||(r=r.split(/[,|]/)),a.sets=r,a.nodeId=r.join()):i==this.valueField?(a.size=r,a.value=r):i==this.label.field&&(a.label=r)}e.push(a)}return e}},{key:"_getStyle",value:function(e,t,n,l){var a;return y._.isString(e)&&(a=e),y._.isFunction(e)&&(a=e(n)),a||null==t||(a=this.app.getTheme(t)),a||null==l||(a=l),a}},{key:"_widget",value:function(){var f=this;if(f.venn_circles.children.length>f._dataCircleLen)for(var e=f._dataCircleLen;e<f.venn_circles.children.length;e++)f.venn_circles.getChildAt(e--).destroy();if(f.venn_paths.children.length>f._dataPathLen)for(e=f._dataPathLen;e<f.venn_paths.children.length;e++)f.venn_paths.getChildAt(e--).destroy();if(f.venn_labels.children.length>f._dataLabelLen)for(e=f._dataLabelLen;e<f.venn_labels.children.length;e++)f.venn_labels.getChildAt(e--).destroy();var c=0,p=0,v=0;y._.each(this.data,function(e,t){var n,l=e.shape,a=!0;if(l){var i;if("circle"==l.type){var r=f._getStyle(f.node.fillStyle,l.circleInd,e),o=f._getStyle(f.node.strokeStyle,l.circleInd,e);e.fillStyle=r,e.strokeStyle=o,i={x:l.x,y:l.y,r:l.radius,fillStyle:r,fillAlpha:f.node.fillAlpha,lineWidth:f.node.lineWidth,strokeStyle:o,strokeAlpha:f.node.strokeAlpha},(n=f.venn_circles.getChildAt(c++))?(a=!1,n.animate(i)):(n=new b({pointChkPriority:!1,hoverClone:!1,context:i}),f.venn_circles.addChild(n))}"path"==e.shape.type&&(i={path:l.path,fillStyle:"#ffffff",fillAlpha:0,lineWidth:f.node.lineWidth,strokeStyle:"#ffffff",strokeAlpha:0},(n=f.venn_paths.getChildAt(p++))?(a=!1,n.context.path=l.path):(n=new g({pointChkPriority:!1,context:i}),f.venn_paths.addChild(n))),(n.nodeData=e)._node=n,f.node.focus.enabled&&n.hover(function(e){f.focusAt(this.nodeData.iNode)},function(e){this.nodeData.selected||f.unfocusAt(this.nodeData.iNode)}),a&&n.on(y.event.types.get(),function(e){e.eventInfo={trigger:f.node,title:null,nodes:[this.nodeData]},f.app.fire(e.type,e)})}if(e.label&&f.label.enabled){var s=f._getStyle(f.label.fontColor,l.circleInd,e,"#999"),d=f.label.fontSize;if(1<e.sets.length&&(f.label.showInter?d-=2:d=0),d){var u={x:e.labelPosition.x,y:e.labelPosition.y,fontSize:d,textBaseline:"middle",textAlign:"center",fontWeight:f.label.fontWeight,fillStyle:s},h=f.venn_labels.getChildAt(v++);h?(h.resetText(e.label),h.animate(u)):(h=new _(e.label,{context:u}),f.venn_labels.addChild(h))}}})}},{key:"focusAt",value:function(e){var t=this.data[e];if(this.node.focus.enabled&&!t.focused){var n=t._node.context;1<t.sets.length?n.strokeAlpha=1:n.strokeAlpha=this.node.focus.strokeAlpha,t.focused=!0}}},{key:"unfocusAt",value:function(e){var t=this.data[e];this.node.focus.enabled&&t.focused&&(t._node.context.strokeAlpha=this.node.strokeAlpha,t.focused=!1)}},{key:"selectAt",value:function(e){var t=this.data[e];if(this.node.select.enabled&&!t.selected){var n=t._node.context;n.lineWidth=this.node.select.lineWidth,n.strokeAlpha=this.node.select.strokeAlpha,n.strokeStyle=this.node.select.strokeStyle,t.selected=!0}}},{key:"unselectAt",value:function(e){var t=this.data[e];this.node.select.enabled&&t.selected&&(t._node.context.strokeStyle=this.node.strokeStyle,t.selected=!1)}}]),x);function x(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,x),(n=function(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?s(e):t}(this,o(x).call(this,e,t))).type="venn",n.vennData=null,y._.extend(!0,s(n),(0,y.getDefaultProps)(x.defaultProps()),e),n._dataCircleLen=0,n._dataLabelLen=0,n._dataPathLen=0,n.init(),n}function k(t,n){var e,l=[];for(e=0;e<t.length;++e){var a=t[e];l.push({x:a.x,y:a.y}),l.push({x:a.x+a.radius/2,y:a.y}),l.push({x:a.x-a.radius/2,y:a.y}),l.push({x:a.x,y:a.y+a.radius/2}),l.push({x:a.x,y:a.y-a.radius/2})}var i=l[0],r=m(l[0],t,n);for(e=1;e<l.length;++e){var o=m(l[e],t,n);r<=o&&(i=l[e],r=o)}var s=(0,f.nelderMead)(function(e){return-1*m({x:e[0],y:e[1]},t,n)},[i.x,i.y],{maxIterations:500,minErrorDelta:1e-10}).x,d={x:s[0],y:s[1]},u=!0;for(e=0;e<t.length;++e)if((0,v.distance)(d,t[e])>t[e].radius){u=!1;break}for(e=0;e<n.length;++e)if((0,v.distance)(d,n[e])<n[e].radius){u=!1;break}if(!u)if(1==t.length)d={x:t[0].x,y:t[0].y};else{var h={};(0,v.intersectionArea)(t,h),d=0===h.arcs.length?{x:0,y:-1e3,disjoint:!0}:1==h.arcs.length?{x:h.arcs[0].circle.x,y:h.arcs[0].circle.y}:n.length?k(t,[]):(0,v.getCenter)(h.arcs.map(function(e){return e.p1}))}return d}function m(e,t,n){var l,a,i=t[0].radius-(0,v.distance)(t[0],e);for(l=1;l<t.length;++l)(a=t[l].radius-(0,v.distance)(t[l],e))<=i&&(i=a);for(l=0;l<n.length;++l)(a=(0,v.distance)(n[l],e)-n[l].radius)<=i&&(i=a);return i}y.global.registerComponent(p,"graphs","venn"),e.default=p});