"use strict";!function(t,e){if("function"==typeof define&&define.amd)define(["exports","canvax","../../../utils/tools","mmvis"],e);else if("undefined"!=typeof exports)e(exports,require("canvax"),require("../../../utils/tools"),require("mmvis"));else{var i={};e(i,t.canvax,t.tools,t.mmvis),t.undefined=i}}(void 0,function(t,e,o,y){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i,v=(i=e)&&i.__esModule?i:{default:i};function s(t){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function u(t){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function d(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function l(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}function r(t,e){return(r=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var a=v.default.AnimationFrame,f=v.default.Shapes.BrokenLine,g=v.default.Shapes.Circle,b=v.default.Shapes.Isogon,x=v.default.Shapes.Path,h=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&r(t,e)}(c,y.event.Dispatcher),l(c,null,[{key:"defaultProps",value:function(){return{line:{detail:"线配置",propertys:{enabled:{detail:"是否开启",default:!0},strokeStyle:{detail:"线的颜色",default:void 0},lineWidth:{detail:"线的宽度",default:2},lineType:{detail:"线的样式",default:"solid"},smooth:{detail:"是否平滑处理",default:!0}}},node:{detail:"单个数据节点配置，对应线上的小icon图形",propertys:{enabled:{detail:"是否开启",default:!0},shapeType:{detail:"节点icon的图形类型，默认circle",documentation:'可选有"isogon"(正多边形)，"path"（自定义path路径，待实现）',default:"circle"},isogonPointNum:{detail:'shapeType为"isogon"时有效，描述正多边形的边数',default:3},path:{detail:"shapeType为path的时候，描述图形的path路径",default:null},corner:{detail:"拐角才有节点",default:!1},radius:{detail:"节点半径",default:3},fillStyle:{detail:"节点图形的背景色",default:"#ffffff"},strokeStyle:{detail:"节点图形的描边色，默认和line.strokeStyle保持一致",default:null},lineWidth:{detail:"节点图形边宽大小",default:2},visible:{detail:"节点是否显示,支持函数",default:!0}}},label:{detail:"文本配置",propertys:{enabled:{detail:"是否开启",default:!1},fontColor:{detail:"文本颜色",default:null},strokeStyle:{detail:"文本描边色",default:null},fontSize:{detail:"文本字体大小",default:12},format:{detail:"文本格式化处理函数",default:null}}},area:{detail:"面积区域配置",propertys:{enabled:{detail:"是否开启",default:!0},fillStyle:{detail:"面积背景色",default:null},alpha:{detail:"面积透明度",default:.2}}}}}}]),l(c,[{key:"init",value:function(){this.sprite=new v.default.Display.Sprite}},{key:"draw",value:function(t,e){y._.extend(!0,this,t),this.data=e,this._widget(t)}},{key:"destroy",value:function(){var t=this;t.sprite.animate({globalAlpha:0},{duration:300,onComplete:function(){t.sprite.remove()}})}},{key:"_getColor",value:function(t,e){var i=this._getProp(t,e);return null==i&&(i=this._getLineStrokeStyle(),t&&t.lineargradient&&(i=t.lineargradient[parseInt(t.lineargradient.length/2)].color),i&&y._.isString(i)||(i=this.fieldMap.color)),i}},{key:"_getProp",value:function(t,e){if(y._.isArray(t))return t[this.iGroup];if(y._.isFunction(t)){var i=[];return null!=e&&i.push(this.data[e]),t.apply(this,i)}return t}},{key:"getNodeInfoAt",value:function(t,e){var i=this.data[t];if(e&&e.eventInfo&&e.eventInfo.dimension_1&&"proportion"==e.eventInfo.dimension_1.layoutType)for(var n,l=0,r=this.data.length;l<r;l++){var o=this.data[l],a=Math.abs(o.x-t);(null==n||a<n)&&(n=a,i=o)}return i}},{key:"resetData",value:function(t,e){var i=this;t&&(this.data=t),i._pointList=this._getPointList(this.data);var n={left:0,right:i._pointList.length-i._currPointList.length};e&&y._.extend(n,e.params),n.left&&(0<n.left&&(this._currPointList=this._pointList.slice(0,n.left).concat(this._currPointList)),n.left<0&&this._currPointList.splice(0,Math.abs(n.left))),n.right&&(0<n.right&&(this._currPointList=this._currPointList.concat(this._pointList.slice(-n.right))),n.right<0&&this._currPointList.splice(this._currPointList.length-Math.abs(n.right))),i._createNodes(),i._createTexts(),i._grow()}},{key:"_grow",value:function(t){var r=this;function l(t){r._bline.context.pointList=y._.clone(t),r._bline.context.strokeStyle=r._getLineStrokeStyle(t),r._area.context.path=r._fillLine(r._bline),r._area.context.fillStyle=r._getFillStyle();var l=0;y._.each(t,function(t,e){if(y._.isNumber(t[1])){if(r._nodes){var i=r._nodes.getChildAt(l);i&&(i.context.x=t[0],i.context.y=t[1])}if(r._labels){var n=r._labels.getChildAt(l);n&&(n.context.x=t[0],n.context.y=t[1]-3,r._checkTextPos(n,e))}l++}})}r.data.length?(this._growTween=a.registTween({from:r._getPointPosStr(r._currPointList),to:r._getPointPosStr(r._pointList),desc:r.field,onUpdate:function(t){for(var e in t){var i=parseInt(e.split("_")[2]),n=parseInt(e.split("_")[1]);r._currPointList[i]&&(r._currPointList[i][n]=t[e])}l(r._currPointList)},onComplete:function(){r.sprite._removeTween(r._growTween),r._growTween=null,l(r._pointList),t&&t(r)}}),this.sprite._tweens.push(this._growTween)):t&&t(r)}},{key:"_getPointPosStr",value:function(t){var i={};return y._.each(t,function(t,e){t&&(i["p_1_"+e]=t[1],i["p_0_"+e]=t[0])}),i}},{key:"_getPointList",value:function(t){for(var e=[],i=0,n=t.length;i<n;i++){var l=t[i];e.push([l.x,l.y])}return e}},{key:"_widget",value:function(t){var e=this;if(t=t||{},e._pointList=this._getPointList(e.data),0!=e._pointList.length){var i=[];if(t.animation)for(var n=this._getFirstNode(),l=n?n.y:void 0,r=0,o=e.data.length;r<o;r++){var a=e.data[r];i.push([a.x,y._.isNumber(a.y)?l:a.y])}else i=e._pointList;var s={pointList:e._currPointList=i,lineWidth:e.line.lineWidth,y:e.y,strokeStyle:e._getLineStrokeStyle(i),smooth:e.line.smooth,lineType:e._getProp(e.line.lineType),smoothFilter:function(t){0<t[1]?t[1]=0:Math.abs(t[1])>e.h&&(t[1]=-e.h)},lineCap:"round"},u=new f({context:s});u.on(y.event.types.get(),function(t){t.eventInfo={trigger:e.line,nodes:[]},e._graphs.app.fire(t.type,t)}),this.line.enabled||(u.context.visible=!1),e.sprite.addChild(u),e._bline=u;var d=new x({context:{path:e._fillLine(u),fillStyle:e._getFillStyle(),globalAlpha:y._.isArray(e.area.alpha)?1:e.area.alpha}});d.on(y.event.types.get(),function(t){t.eventInfo={trigger:e.area,nodes:[]},e._graphs.app.fire(t.type,t)}),this.area.enabled||(d.context.visible=!1),e.sprite.addChild(d),e._area=d,e._createNodes(),e._createTexts()}}},{key:"_getFirstNode",value:function(){for(var t=null,e=0,i=this.data.length;e<i;e++){var n=this.data[e];if(y._.isNumber(n.y)&&(null!==t&&"right"!=this._yAxis.align||(t=n),"right"!==this._yAxis.align&&null!==t))break}return t}},{key:"_getFillStyle",value:function(){var t=this,e=null,i=t._getProp(t.area.fillStyle)||t._getLineStrokeStyle(null,"fillStyle");if(y._.isArray(t.area.alpha)&&!(i instanceof CanvasGradient)){t.area.alpha.length=2,null==t.area.alpha[0]&&(t.area.alpha[0]=0),null==t.area.alpha[1]&&(t.area.alpha[1]=0);var n=y._.min(t._bline.context.pointList,function(t){return t[1]});if(void 0===n[0]||void 0===n[1])return null;e=t.ctx.createLinearGradient(n[0],n[1],n[0],0);var l=y.color.colorRgb(i),r=l.replace(")",", "+t._getProp(t.area.alpha[0])+")").replace("RGB","RGBA");e.addColorStop(0,r);var o=l.replace(")",", "+t.area.alpha[1]+")").replace("RGB","RGBA");e.addColorStop(1,o),i=e}return i}},{key:"_getLineStrokeStyle",value:function(t,e){var i;if(!this._opt.line||!this._opt.line.strokeStyle)return this.line.strokeStyle;if(this._opt.line.strokeStyle.lineargradient){t=t||this._bline.context.pointList;var n=y._.min(t,function(t){return t[1]}),l=y._.max(t,function(t){return t[1]});return"fillStyle"==e&&(l=[0,0]),void 0===n[0]||void 0===n[1]||void 0===l[1]?null:(i=this.ctx.createLinearGradient(n[0],n[1],n[0],l[1]),y._.each(this._opt.line.strokeStyle.lineargradient,function(t,e){i.addColorStop(t.position,t.color)}),i)}return i=this._getColor(this._opt.line.strokeStyle)}},{key:"_createNodes",value:function(){var t=this,e=t._currPointList;this._nodes||(this._nodes=new v.default.Display.Sprite({}),this.sprite.addChild(this._nodes));for(var i=0,n=0,l=e.length;n<l;n++){var r=t._getColor(t.node.strokeStyle||t.line.strokeStyle,n);if(t.data[n].color=r,t.node.enabled){var o=t._currPointList[n];if(o&&y._.isNumber(o[1])){var a={x:o[0],y:o[1],r:t._getProp(t.node.radius,n),lineWidth:t._getProp(t.node.lineWidth,n)||2,strokeStyle:r,fillStyle:t._getProp(t.node.fillStyle,n),visible:!!t._getProp(t.node.visible,n)},s=g,u=t._getProp(t.node.shapeType,n);"isogon"==u&&(s=b,a.n=t._getProp(t.node.isogonPointNum,n)),"path"==u&&(s=x,a.path=t._getProp(t.node.path,n));var d=t._nodes.children[i];if(d?d.type==u?y._.extend(d.context,a):(d.destroy(),d=new s({context:a}),t._nodes.addChildAt(d,i)):(d=new s({context:a}),t._nodes.addChild(d)),t.node.corner){var f=t._pointList[n][1],h=t._pointList[n-1],c=t._pointList[n+1];h&&c&&f==h[1]&&f==c[1]&&(d.context.visible=!1)}i++}}}if(t._nodes.children.length>i)for(var p=i,_=t._nodes.children.length;p<_;p++)t._nodes.children[p].destroy(),p--,_--}},{key:"_createTexts",value:function(){var t=this,e=t._currPointList;if(t.label.enabled){this._labels||(this._labels=new v.default.Display.Sprite({}),this.sprite.addChild(this._labels));for(var i=0,n=0,l=e.length;n<l;n++){var r=e[n];if(r&&y._.isNumber(r[1])){var o={x:r[0],y:r[1]-3,fontSize:this.label.fontSize,textAlign:"center",textBaseline:"bottom",fillStyle:t._getColor(t.label.fontColor,n),lineWidth:1,strokeStyle:"#ffffff"},a=t.data[n].value;if(y._.isFunction(t.label.format)&&(a=t.label.format(a,t.data[n])||a),null!=a&&null!=a){var s=this._labels.children[i];s?(s.resetText(a),y._.extend(s.context,o)):(s=new v.default.Display.Text(a,{context:o}),t._labels.addChild(s),t._checkTextPos(s,n)),i++}}}if(t._labels.children.length>i)for(var u=i,d=t._labels.children.length;u<d;u++)t._labels.children[u].destroy(),u--,d--}}},{key:"_checkTextPos",value:function(t,e){var i=this._currPointList,n=i[e-1],l=i[e+1];n&&l&&n[1]<t.context.y&&l[1]<t.context.y&&(t.context.y+=7,t.context.textBaseline="top")}},{key:"_fillLine",value:function(t){var i=y._.clone(t.context.pointList),e="",n=-this._yAxis.originPos,l=null;function r(){l.push([l[l.length-1][0],n],[l[0][0],n],[l[0][0],l[0][1]]),e+=(0,o.getPath)(l),l=null}return y._.each(i,function(t,e){y._.isNumber(t[1])?(null===l&&(l=[]),l.push(t)):l&&l.length&&r(),e==i.length-1&&y._.isNumber(t[1])&&r()}),e}},{key:"getNodeInfoOfX",value:function(l){for(var t=this,e=0,i=this.data.length;e<i;e++)if(null!==this.data[e].value&&Math.abs(this.data[e].x-l)<=1)return this.data[e];function r(t,e){var i={x:t,y:0};return i.y=e[0][1]+(e[1][1]-e[0][1])/(e[1][0]-e[0][0])*(t-e[0][0]),i}var o;return this._bline&&function t(e){if(!(l<e[0][0]||l>e.slice(-1)[0][0])){var i=parseInt(e.length/2);if(Math.abs(e[i][0]-l)<=1)o={x:e[i][0],y:e[i][1]};else{var n=[];if(l>e[i][0]){if(l<e[i+1][0])return void(o=r(l,[e[i],e[i+1]]));n=e.slice(i+1)}else{if(l>e[i-1][0])return void(o=r(l,[e[i-1],e[i]]));n=e.slice(0,i)}t(n)}}}(this._bline.context.pointList),o&&null!=o.y?{type:"line",iGroup:t.iGroup,iNode:-1,field:t.field,value:this._yAxis.getValOfPos(-o.y),x:o.x,y:o.y,rowData:null,color:t._getProp(t.node.strokeStyle)||t._getLineStrokeStyle()}:null}}]),c);function c(t,e,i,n,l,r,o){var a;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,c),(a=function(t,e){return!e||"object"!==s(e)&&"function"!=typeof e?d(t):e}(this,u(c).call(this)))._graphs=o,a._opt=i,a.fieldMap=t,a.field=null,a.iGroup=e,a._yAxis=t.yAxis,a.ctx=n,a.w=r,a.h=l,a.y=0,a.line={strokeStyle:t.color},a.data=[],a.sprite=null,a._pointList=[],a._currPointList=[],a._bline=null,y._.extend(!0,d(a),(0,y.getDefaultProps)(c.defaultProps()),i),a.field=t.field,a.init(i),a}t.default=h});