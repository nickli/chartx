"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_canvax=_interopRequireDefault(require("canvax")),_tools=require("../../../utils/tools"),_mmvis=require("mmvis"),AnimationFrame=_canvax.default.AnimationFrame,BrokenLine=_canvax.default.Shapes.BrokenLine,Circle=_canvax.default.Shapes.Circle,Isogon=_canvax.default.Shapes.Isogon,Path=_canvax.default.Shapes.Path,LineGraphsGroup=function(e){function s(e,t,i,l,n,a,r){var o;return(0,_classCallCheck2.default)(this,s),(o=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(s).call(this)))._graphs=r,o._opt=i,o.fieldMap=e,o.field=null,o.iGroup=t,o._yAxis=e.yAxis,o.ctx=l,o.w=a,o.h=n,o.y=0,o.line={strokeStyle:e.color},o.data=[],o.sprite=null,o._pointList=[],o._currPointList=[],o._bline=null,_mmvis._.extend(!0,(0,_assertThisInitialized2.default)(o),(0,_mmvis.getDefaultProps)(s.defaultProps()),i),o.field=e.field,o.init(i),o}return(0,_inherits2.default)(s,e),(0,_createClass2.default)(s,null,[{key:"defaultProps",value:function(){return{line:{detail:"线配置",propertys:{enabled:{detail:"是否开启",default:!0},strokeStyle:{detail:"线的颜色",default:void 0},lineWidth:{detail:"线的宽度",default:2},lineType:{detail:"线的样式",default:"solid"},smooth:{detail:"是否平滑处理",default:!0}}},node:{detail:"单个数据节点配置，对应线上的小icon图形",propertys:{enabled:{detail:"是否开启",default:!0},shapeType:{detail:"节点icon的图形类型，默认circle",documentation:'可选有"isogon"(正多边形)，"path"（自定义path路径，待实现）',default:"circle"},isogonPointNum:{detail:'shapeType为"isogon"时有效，描述正多边形的边数',default:3},path:{detail:"shapeType为path的时候，描述图形的path路径",default:null},corner:{detail:"拐角才有节点",default:!1},radius:{detail:"节点半径",default:3},fillStyle:{detail:"节点图形的背景色",default:"#ffffff"},strokeStyle:{detail:"节点图形的描边色，默认和line.strokeStyle保持一致",default:null},lineWidth:{detail:"节点图形边宽大小",default:2},visible:{detail:"节点是否显示,支持函数",default:!0}}},label:{detail:"文本配置",propertys:{enabled:{detail:"是否开启",default:!1},fontColor:{detail:"文本颜色",default:null},strokeStyle:{detail:"文本描边色",default:null},fontSize:{detail:"文本字体大小",default:12},format:{detail:"文本格式化处理函数",default:null}}},area:{detail:"面积区域配置",propertys:{enabled:{detail:"是否开启",default:!0},fillStyle:{detail:"面积背景色",default:null},alpha:{detail:"面积透明度",default:.2}}}}}}]),(0,_createClass2.default)(s,[{key:"init",value:function(){this.sprite=new _canvax.default.Display.Sprite}},{key:"draw",value:function(e,t){_mmvis._.extend(!0,this,e),this.data=t,this._widget(e)}},{key:"destroy",value:function(){var e=this;e.sprite.animate({globalAlpha:0},{duration:300,onComplete:function(){e.sprite.remove()}})}},{key:"_getColor",value:function(e,t){var i=this._getProp(e,t);return null==i&&(i=this._getLineStrokeStyle(),e&&e.lineargradient&&(i=e.lineargradient[parseInt(e.lineargradient.length/2)].color),i&&_mmvis._.isString(i)||(i=this.fieldMap.color)),i}},{key:"_getProp",value:function(e,t){if(_mmvis._.isArray(e))return e[this.iGroup];if(_mmvis._.isFunction(e)){var i=[];return null!=t&&i.push(this.data[t]),e.apply(this,i)}return e}},{key:"getNodeInfoAt",value:function(e,t){var i=this.data[e];if(t&&t.eventInfo&&t.eventInfo.dimension_1&&"proportion"==t.eventInfo.dimension_1.layoutType)for(var l,n=0,a=this.data.length;n<a;n++){var r=this.data[n],o=Math.abs(r.x-e);(null==l||o<l)&&(l=o,i=r)}return i}},{key:"resetData",value:function(e,t){var i=this;e&&(this.data=e),i._pointList=this._getPointList(this.data);var l={left:0,right:i._pointList.length-i._currPointList.length};t&&_mmvis._.extend(l,t.params),l.left&&(0<l.left&&(this._currPointList=this._pointList.slice(0,l.left).concat(this._currPointList)),l.left<0&&this._currPointList.splice(0,Math.abs(l.left))),l.right&&(0<l.right&&(this._currPointList=this._currPointList.concat(this._pointList.slice(-l.right))),l.right<0&&this._currPointList.splice(this._currPointList.length-Math.abs(l.right))),i._createNodes(),i._createTexts(),i._grow()}},{key:"_grow",value:function(e){var a=this;function n(e){a._bline.context.pointList=_mmvis._.clone(e),a._bline.context.strokeStyle=a._getLineStrokeStyle(e),a._area.context.path=a._fillLine(a._bline),a._area.context.fillStyle=a._getFillStyle();var n=0;_mmvis._.each(e,function(e,t){if(_mmvis._.isNumber(e[1])){if(a._nodes){var i=a._nodes.getChildAt(n);i&&(i.context.x=e[0],i.context.y=e[1])}if(a._labels){var l=a._labels.getChildAt(n);l&&(l.context.x=e[0],l.context.y=e[1]-3,a._checkTextPos(l,t))}n++}})}a.data.length?(this._growTween=AnimationFrame.registTween({from:a._getPointPosStr(a._currPointList),to:a._getPointPosStr(a._pointList),desc:a.field,onUpdate:function(e){for(var t in e){var i=parseInt(t.split("_")[2]),l=parseInt(t.split("_")[1]);a._currPointList[i]&&(a._currPointList[i][l]=e[t])}n(a._currPointList)},onComplete:function(){a.sprite._removeTween(a._growTween),a._growTween=null,n(a._pointList),e&&e(a)}}),this.sprite._tweens.push(this._growTween)):e&&e(a)}},{key:"_getPointPosStr",value:function(e){var i={};return _mmvis._.each(e,function(e,t){e&&(i["p_1_"+t]=e[1],i["p_0_"+t]=e[0])}),i}},{key:"_getPointList",value:function(e){for(var t=[],i=0,l=e.length;i<l;i++){var n=e[i];t.push([n.x,n.y])}return t}},{key:"_widget",value:function(e){var t=this;if(e=e||{},t._pointList=this._getPointList(t.data),0!=t._pointList.length){var i=[];if(e.animation)for(var l=this._getFirstNode(),n=l?l.y:void 0,a=0,r=t.data.length;a<r;a++){var o=t.data[a];i.push([o.x,_mmvis._.isNumber(o.y)?n:o.y])}else i=t._pointList;var s={pointList:t._currPointList=i,lineWidth:t.line.lineWidth,y:t.y,strokeStyle:t._getLineStrokeStyle(i),smooth:t.line.smooth,lineType:t._getProp(t.line.lineType),smoothFilter:function(e){0<e[1]?e[1]=0:Math.abs(e[1])>t.h&&(e[1]=-t.h)},lineCap:"round"},u=new BrokenLine({context:s});u.on(_mmvis.event.types.get(),function(e){e.eventInfo={trigger:t.line,nodes:[]},t._graphs.app.fire(e.type,e)}),this.line.enabled||(u.context.visible=!1),t.sprite.addChild(u),t._bline=u;var _=new Path({context:{path:t._fillLine(u),fillStyle:t._getFillStyle(),globalAlpha:_mmvis._.isArray(t.area.alpha)?1:t.area.alpha}});_.on(_mmvis.event.types.get(),function(e){e.eventInfo={trigger:t.area,nodes:[]},t._graphs.app.fire(e.type,e)}),this.area.enabled||(_.context.visible=!1),t.sprite.addChild(_),t._area=_,t._createNodes(),t._createTexts()}}},{key:"_getFirstNode",value:function(){for(var e=null,t=0,i=this.data.length;t<i;t++){var l=this.data[t];if(_mmvis._.isNumber(l.y)&&(null!==e&&"right"!=this._yAxis.align||(e=l),"right"!==this._yAxis.align&&null!==e))break}return e}},{key:"_getFillStyle",value:function(){var e=this,t=null,i=e._getProp(e.area.fillStyle)||e._getLineStrokeStyle(null,"fillStyle");if(_mmvis._.isArray(e.area.alpha)&&!(i instanceof CanvasGradient)){e.area.alpha.length=2,null==e.area.alpha[0]&&(e.area.alpha[0]=0),null==e.area.alpha[1]&&(e.area.alpha[1]=0);var l=_mmvis._.min(e._bline.context.pointList,function(e){return e[1]});if(void 0===l[0]||void 0===l[1])return null;t=e.ctx.createLinearGradient(l[0],l[1],l[0],0);var n=_mmvis.color.colorRgb(i),a=n.replace(")",", "+e._getProp(e.area.alpha[0])+")").replace("RGB","RGBA");t.addColorStop(0,a);var r=n.replace(")",", "+e.area.alpha[1]+")").replace("RGB","RGBA");t.addColorStop(1,r),i=t}return i}},{key:"_getLineStrokeStyle",value:function(e,t){var i;if(!this._opt.line||!this._opt.line.strokeStyle)return this.line.strokeStyle;if(this._opt.line.strokeStyle.lineargradient){e=e||this._bline.context.pointList;var l=_mmvis._.min(e,function(e){return e[1]}),n=_mmvis._.max(e,function(e){return e[1]});return"fillStyle"==t&&(n=[0,0]),void 0===l[0]||void 0===l[1]||void 0===n[1]?null:(i=this.ctx.createLinearGradient(l[0],l[1],l[0],n[1]),_mmvis._.each(this._opt.line.strokeStyle.lineargradient,function(e,t){i.addColorStop(e.position,e.color)}),i)}return i=this._getColor(this._opt.line.strokeStyle)}},{key:"_createNodes",value:function(){var e=this,t=e._currPointList;this._nodes||(this._nodes=new _canvax.default.Display.Sprite({}),this.sprite.addChild(this._nodes));for(var i=0,l=0,n=t.length;l<n;l++){var a=e._getColor(e.node.strokeStyle||e.line.strokeStyle,l);if(e.data[l].color=a,e.node.enabled){var r=e._currPointList[l];if(r&&_mmvis._.isNumber(r[1])){var o={x:r[0],y:r[1],r:e._getProp(e.node.radius,l),lineWidth:e._getProp(e.node.lineWidth,l)||2,strokeStyle:a,fillStyle:e._getProp(e.node.fillStyle,l),visible:!!e._getProp(e.node.visible,l)},s=Circle,u=e._getProp(e.node.shapeType,l);"isogon"==u&&(s=Isogon,o.n=e._getProp(e.node.isogonPointNum,l)),"path"==u&&(s=Path,o.path=e._getProp(e.node.path,l));var _=e._nodes.children[i];if(_?_.type==u?_mmvis._.extend(_.context,o):(_.destroy(),_=new s({context:o}),e._nodes.addChildAt(_,i)):(_=new s({context:o}),e._nodes.addChild(_)),e.node.corner){var d=e._pointList[l][1],h=e._pointList[l-1],f=e._pointList[l+1];h&&f&&d==h[1]&&d==f[1]&&(_.context.visible=!1)}i++}}}if(e._nodes.children.length>i)for(var p=i,c=e._nodes.children.length;p<c;p++)e._nodes.children[p].destroy(),p--,c--}},{key:"_createTexts",value:function(){var e=this,t=e._currPointList;if(e.label.enabled){this._labels||(this._labels=new _canvax.default.Display.Sprite({}),this.sprite.addChild(this._labels));for(var i=0,l=0,n=t.length;l<n;l++){var a=t[l];if(a&&_mmvis._.isNumber(a[1])){var r={x:a[0],y:a[1]-3,fontSize:this.label.fontSize,textAlign:"center",textBaseline:"bottom",fillStyle:e._getColor(e.label.fontColor,l),lineWidth:1,strokeStyle:"#ffffff"},o=e.data[l].value;if(_mmvis._.isFunction(e.label.format)&&(o=e.label.format(o,e.data[l])||o),null!=o&&null!=o){var s=this._labels.children[i];s?(s.resetText(o),_mmvis._.extend(s.context,r)):(s=new _canvax.default.Display.Text(o,{context:r}),e._labels.addChild(s),e._checkTextPos(s,l)),i++}}}if(e._labels.children.length>i)for(var u=i,_=e._labels.children.length;u<_;u++)e._labels.children[u].destroy(),u--,_--}}},{key:"_checkTextPos",value:function(e,t){var i=this._currPointList,l=i[t-1],n=i[t+1];l&&n&&l[1]<e.context.y&&n[1]<e.context.y&&(e.context.y+=7,e.context.textBaseline="top")}},{key:"_fillLine",value:function(e){var i=_mmvis._.clone(e.context.pointList),t="",l=-this._yAxis.originPos,n=null;function a(){n.push([n[n.length-1][0],l],[n[0][0],l],[n[0][0],n[0][1]]),t+=(0,_tools.getPath)(n),n=null}return _mmvis._.each(i,function(e,t){_mmvis._.isNumber(e[1])?(null===n&&(n=[]),n.push(e)):n&&n.length&&a(),t==i.length-1&&_mmvis._.isNumber(e[1])&&a()}),t}},{key:"getNodeInfoOfX",value:function(n){for(var e=this,t=0,i=this.data.length;t<i;t++)if(null!==this.data[t].value&&Math.abs(this.data[t].x-n)<=1)return this.data[t];function a(e,t){var i={x:e,y:0};return i.y=t[0][1]+(t[1][1]-t[0][1])/(t[1][0]-t[0][0])*(e-t[0][0]),i}var r;return this._bline&&function e(t){if(!(n<t[0][0]||n>t.slice(-1)[0][0])){var i=parseInt(t.length/2);if(Math.abs(t[i][0]-n)<=1)r={x:t[i][0],y:t[i][1]};else{var l=[];if(n>t[i][0]){if(n<t[i+1][0])return void(r=a(n,[t[i],t[i+1]]));l=t.slice(i+1)}else{if(n>t[i-1][0])return void(r=a(n,[t[i-1],t[i]]));l=t.slice(0,i)}e(l)}}}(this._bline.context.pointList),r&&null!=r.y?{type:"line",iGroup:e.iGroup,iNode:-1,field:e.field,value:this._yAxis.getValOfPos(-r.y),x:r.x,y:r.y,rowData:null,color:e._getProp(e.node.strokeStyle)||e._getLineStrokeStyle()}:null}}]),s}(_mmvis.event.Dispatcher);exports.default=LineGraphsGroup;