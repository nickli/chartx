"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_canvax=_interopRequireDefault(require("canvax")),_tools=require("../../../utils/tools"),_index2=_interopRequireDefault(require("../index")),_mmvis=require("mmvis"),AnimationFrame=_canvax.default.AnimationFrame,Rect=_canvax.default.Shapes.Rect,BarGraphs=function(e){function a(e,t){var i;return(0,_classCallCheck2.default)(this,a),(i=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(a).call(this,e,t))).type="bar",i.enabledField=null,i.node={_width:0,_count:0},i.select={_fillStyle:"#092848"},i._barsLen=0,i.txtsSp=null,_mmvis._.extend(!0,(0,_assertThisInitialized2.default)(i),(0,_mmvis.getDefaultProps)(a.defaultProps()),e),i.init(),i}return(0,_inherits2.default)(a,e),(0,_createClass2.default)(a,null,[{key:"defaultProps",value:function(){return{field:{detail:"字段设置",documentation:"支持二维数组格式的设置，一维方向就是横向分组，二维方向就是纵向的堆叠",default:null},yAxisAlign:{detail:"绘制在哪根y轴上面",default:"left"},absolute:{detail:"是否脱离graphs的位置计算",documentation:"                    trimGraphs的时候是否需要和其他的 bar graphs一起并排计算，                    true的话这个就会和别的重叠,                    和css中得absolute概念一致，脱离文档流的绝对定位",default:!1},proportion:{detail:"比例柱状图",default:!1},node:{detail:"单个数据对应的图形设置",propertys:{width:{detail:"bar的宽度",default:0},maxWidth:{detail:"最大width",default:50},minWidth:{detail:"最小width",default:1},minHeight:{detail:"最小height",default:0},radius:{detail:"叶子节点的圆角半径",default:3},fillStyle:{detail:"bar填充色",default:null},fillAlpha:{detail:"bar透明度",default:.95},xDis:{detail:"单分组内bar之间的间隔",default:null},filter:{detail:"bar过滤处理器",default:null}}},label:{detail:"文本设置",propertys:{enabled:{detail:"是否开启",default:!1},fontColor:{detail:"文本颜色",default:null,documentation:"如果有设置text.fontColor那么优先使用fontColor"},fontSize:{detail:"文本字体大小",default:12},format:{detail:"文本格式化处理函数",default:null},lineWidth:{detail:"文本描边线宽",default:0},strokeStyle:{detail:"文本描边颜色",default:null},rotation:{detail:"旋转角度",default:0},textAlign:{detail:"水平对齐方式",documentation:"left center right",default:"center"},verticalAlign:{detail:"垂直基线对齐方式",documentation:"top middle bottom",default:"bottom"},position:{detail:"文本布局位置",documentation:"top,topRight,right,rightBottom,bottom,bottomLeft,left,leftTop,center",default:"top"},offsetX:{detail:"x偏移量",default:0},offsetY:{detail:"y偏移量",default:0}}},select:{detail:"分组选中",documentation:"                    分组的选中，不是选中具体的某个node，这里的选中靠groupRegion来表现出来,                    目前只有在第一个graphs bar 上配置有效",propertys:{enabled:{detail:"是否开启",default:!1},inds:{detail:"选中的分组索引集合",documentation:"选中的列的索引集合,注意，这里的ind不是当前视图的ind，而是加上了dataFrame.range.start的全局ind",default:[]},width:{detail:"选中态背景宽度",default:1},alpha:{detail:"选中态背景透明度",default:.2},fillStyle:{detail:"选中态背景填充色",default:null},triggerEventType:{detail:"触发选中效果的事件",default:"click"}}}}}}]),(0,_createClass2.default)(a,[{key:"init",value:function(){this.barsSp=new _canvax.default.Display.Sprite({id:"barsSp"}),this.txtsSp=new _canvax.default.Display.Sprite({id:"txtsSp",context:{}})}},{key:"getNodesAt",value:function(a){var l=this.data,n=[];return _mmvis._.each(this.enabledField,function(e,t){if(_mmvis._.isArray(e))_mmvis._.each(e,function(e,t){var i=l[e]?l[e][a]:null;i&&n.push(i)});else{var i=l[e]?l[e][a]:null;i&&n.push(i)}}),n}},{key:"_getTargetField",value:function(e,t,i,a){if(_mmvis._.isString(a))return a;if(_mmvis._.isArray(a)){var l=a[e];if(_mmvis._.isString(l))return l;if(_mmvis._.isArray(l))return l[t]}}},{key:"_getColor",value:function(e,t){var i=t.field,a=_mmvis._.flatten([this.field]),l=this.app.getComponent({name:"coord"}).getFieldMapOf(i);if(_mmvis._.isFunction(e)&&(e=e.apply(this,[t])),_mmvis._.isString(e)&&(e=e),_mmvis._.isArray(e)&&(e=_mmvis._.flatten(e)[_mmvis._.indexOf(a,i)]),e&&e.lineargradient&&e.lineargradient.length)if(0!=t.rectHeight){var n=this.ctx.createLinearGradient(t.x,t.fromY+t.rectHeight,t.x,t.fromY);_mmvis._.each(e.lineargradient,function(e){n.addColorStop(e.position,e.color)}),e=n}else e=e.lineargradient[parseInt(e.lineargradient.length/2)].color;return null==e&&(e=l.color),e}},{key:"_getBarWidth",value:function(e,t){return this.node.width?_mmvis._.isFunction(this.node.width)?this.node._width=this.node.width(e):this.node._width=this.node.width:(this.node._width=t-Math.max(1,.2*t),1==this.node._width&&3<e&&(this.node._width=e-2)),this.node._width<1&&(this.node._width=1),this.node._width=parseInt(this.node._width),this.node._width>this.node.maxWidth&&(this.node._width=this.node.maxWidth),this.node._width}},{key:"show",value:function(){this.draw()}},{key:"hide",value:function(a){_mmvis._.each(this.barsSp.children,function(e,t){var i=e.getChildById("bar_"+t+"_"+a);i&&i.destroy()}),_mmvis._.each(this.txtsSp.children,function(e,t){var i=e.getChildById("text_"+t+"_"+a);i&&i.destroy()}),this.draw()}},{key:"resetData",value:function(e){this.dataFrame=e,this.draw()}},{key:"clean",value:function(){this.data={},this.barsSp.removeAllChildren(),this.label.enabled&&this.txtsSp.removeAllChildren()}},{key:"draw",value:function(e){e=e||{},_mmvis._.extend(!0,this,e);var A=this,k=A.animation&&!e.resize;if(this.data=this._trimGraphs(),0==this.enabledField.length||0==this._dataLen)return A._preDataLen=0,void this.clean();var F=A._preDataLen,D=this.enabledField.length,L=0,I=A.node._count=0,O=A.app.getComponents({name:"graphs",type:"bar"});_mmvis._.each(O,function(e,t){e==A&&(I=t)}),_mmvis._.each(this.enabledField,function(e,t){var i=(e=_mmvis._.flatten([e])).length;if(0!=i){L=A.width/A._dataLen,A._barsLen=A._dataLen*D;for(var a=0;a<A._dataLen;a++){var l=null;if(0==t){if(a<=F-1?l=A.barsSp.getChildById("barGroup_"+a):(l=new _canvax.default.Display.Sprite({id:"barGroup_"+a}),A.barsSp.addChild(l),l.iNode=a),!I){var n,r=L*A.select.width;1<A.select.width&&(r=A.select.width),a<=F-1?((n=l.getChildById("group_region_"+a)).context.width=r,n.context.x=L*a+(L-r)/2,n.context.globalAlpha=-1<_mmvis._.indexOf(A.select.inds,A.dataFrame.range.start+a)?A.select.alpha:0):(n=new Rect({id:"group_region_"+a,pointChkPriority:!1,hoverClone:!1,xyToInt:!1,context:{x:L*a+(L-r)/2,y:-A.height,width:r,height:A.height,fillStyle:A._getGroupRegionStyle(a),globalAlpha:-1<_mmvis._.indexOf(A.select.inds,A.dataFrame.range.start+a)?A.select.alpha:0}}),l.addChild(n),n.iNode=a,n.on(_mmvis.event.types.get(),function(e){e.eventInfo={iNode:this.iNode},C.bind(this)(e),A.app.fire(e.type,e)}))}}else l=A.barsSp.getChildById("barGroup_"+a);var d=null;0==t?a<=F-1?d=A.txtsSp.getChildById("txtGroup_"+a):(d=new _canvax.default.Display.Sprite({id:"txtGroup_"+a}),A.txtsSp.addChild(d),d.iGroup=t):d=A.txtsSp.getChildById("txtGroup_"+a);for(var s=0;s<i;s++){A.node._count++;var o=A.data[e[s]][a];o.iGroup=t,o.iNode=a,o.iLay=s;var h=o.y-o.fromY;isNaN(o.value)?h=0:Math.abs(h)<A.node.minHeight&&(h=A.node.minHeight),o.rectHeight=h;var u=A._getColor(A.node.fillStyle,o);if((o.color=u)instanceof CanvasGradient&&A.node.fillStyle.lineargradient){var f=A.node.fillStyle.lineargradient[parseInt(A.node.fillStyle.lineargradient.length/2)];f&&(o.color=f.color)}var c={x:Math.round(o.x),y:o.fromY,width:A.node._width,height:h,fillStyle:u,fillAlpha:A.node.fillAlpha,scaleY:-1};o.width=c.width;var _={x:c.x,y:o.yOriginPoint.pos,width:c.width,height:c.height,fillStyle:c.fillStyle,fillAlpha:A.node.fillAlpha,scaleY:0};if(A.node.radius&&o.isLeaf&&!A.proportion){var p=Math.min(A.node._width/2,Math.abs(h));p=Math.min(p,A.node.radius),_.radius=[p,p,0,0]}k||(delete _.scaleY,_.y=c.y);var m=null,v="bar_"+a+"_"+o.field;if(a<=F-1&&(m=l.getChildById(v)),m?m.context.fillStyle=u:((m=new Rect({id:v,context:_})).field=o.field,l.addChild(m),m.on(_mmvis.event.types.get(),function(e){e.eventInfo={trigger:A.node,nodes:[this.nodeData]},C.bind(this)(e),A.app.fire(e.type,e)})),m.finalPos=c,m.iGroup=t,m.iNode=a,m.iLay=s,(m.nodeData=o).nodeElement=m,A.node.filter&&A.node.filter.apply(m,[o,A]),A.label.enabled){var g=o.value;if(_mmvis._.isFunction(A.label.format)){var y=A.label.format(g,o);void 0===y&&null===y||(g=y)}if(null==g||""===g)continue;_mmvis._.isNumber(g)&&(g=(0,_tools.numAddSymbol)(g));var b={fillStyle:A.label.fontColor||c.fillStyle,fontSize:A.label.fontSize,lineWidth:A.label.lineWidth,strokeStyle:A.label.strokeStyle||c.fillStyle,textBaseline:A.label.verticalAlign,rotation:A.label.rotation},x=A._getTextPos(c,o);b.x=x.x,b.y=x.y,b.textAlign=A._getTextAlign(c,o);var w=null,S="text_"+a+"_"+o.field;a<=F-1&&(w=d.getChildById(S)),w?(w.resetText(g),w.context.x=b.x,w.context.y=b.y):((w=new _canvax.default.Display.Text(g,{id:S,context:b})).field=o.field,d.addChild(w))}}}}function C(e){if(A.select.enabled&&e.type==A.select.triggerEventType){var t=A.dataFrame.range.start+this.iNode;-1<_mmvis._.indexOf(A.select.inds,t)?_mmvis._.each(O,function(e){e.unselectAt(t)}):_mmvis._.each(O,function(e){e.selectAt(t)})}}}),this.sprite.addChild(this.barsSp),this.label.enabled&&this.sprite.addChild(this.txtsSp),this.sprite.context.x=this.origin.x,this.sprite.context.y=this.origin.y,this.grow(function(){A.fire("complete")},{delay:0,duration:300,animate:k}),A._preDataLen=A._dataLen}},{key:"setEnabledField",value:function(){this.enabledField=this.app.getComponent({name:"coord"}).filterEnabledFields(this.field)}},{key:"_getGroupRegionStyle",value:function(e){var t=this,i=t.select.fillStyle;return _mmvis._.isArray(t.select.fillStyle)&&(i=t.select.fillStyle[e]),_mmvis._.isFunction(t.select.fillStyle)&&(i=t.select.fillStyle.apply(this,[{iNode:e,rowData:t.dataFrame.getRowDataAt(e)}])),null==i?t.select._fillStyle:i}},{key:"_trimGraphs",value:function(){var p=this,m=this.app.getComponent({name:"coord"});this.setEnabledField(),this.data={};var t=[],i=0,a=0,l=!1;this.absolute?(t=[this],i=this.enabledField.length):_mmvis._.each(p.app.getComponents({name:"graphs",type:"bar"}),function(e){e.absolute||(e===p&&(l=!0),l?e.setEnabledField():a+=e.enabledField.length,i+=e.enabledField.length,t.push(e))});var v=m.getAxis({type:"xAxis"}).getCellLength(),e=v/(i+1),g=this._getBarWidth(v,e),y=e-g;null!=this.node.xDis&&(y=this.node.xDis);var b=(v-g*i-y*(i-1))/2;a&&(b+=(y+g)*a);var n=this.dataFrame.getDataOrg(this.enabledField),r=p.getGraphSelectOpt();return!p.select.inds.length&&r&&r.inds&&r.inds.length&&(p.select.inds=_mmvis._.clone(r.inds)),_mmvis._.each(n,function(f,c){var _=[];_mmvis._.each(f,function(e,u){_[u]=[],p._dataLen=e.length,_mmvis._.each(e,function(e,i){var a=e;p.proportion&&(a=0,_mmvis._.each(f,function(e,t){a+=e[i]}));var t=p._getTargetField(c,u,i,p.enabledField),l=m.getPoint({iNode:i,field:t,value:{y:e}}),n=l.pos.x,r=n-v/2+b+(g+y)*c,d=0;d=p.proportion?-e/a*m.height:l.pos.y,isNaN(d)&&(d=0);var h=m.getAxisOriginPoint({field:t});var s=function e(t,i,a,l,n){var r=t[i-1];if(!r)return h.pos;var d=r[a].y,s=r[a].value,o=h.value;return o<=l?o<=s?(r[a].isLeaf=!1,d):e(t,i-1,a,l,n):s<o?(r[a].isLeaf=!1,d):e(t,i-1,a,l,n)}(_,u,i,e,d);d+=s-h.pos;var o={type:"bar",value:e,vInd:u,vCount:a,field:t,fromX:r,fromY:s,x:r,y:d,width:g,yOriginPoint:h,isLeaf:!0,xAxis:m.getAxis({type:"xAxis"}).getNodeInfoOfX(n),iNode:i,rowData:p.dataFrame.getRowDataAt(i),color:null,selected:!1};p.data[o.field]||(p.data[o.field]=_[u]),-1<_mmvis._.indexOf(p.select.inds,i)&&(o.selected=!0),_[u].push(o)})})}),p.data}},{key:"_getTextAlign",value:function(e,t){var i=this.label.textAlign;return t.value<t.yOriginPoint.value&&("left"==i?i="right":"right"==i&&(i="left")),i}},{key:"_getTextPos",value:function(e,t){var i={x:0,y:0},a=e.x,l=e.y,n=!0;switch(e.y>=t.y&&(n=!1),this.label.position){case"top":a=e.x+e.width/2,l=e.y+e.height,n&&(l+=16);break;case"topRight":a=e.x+e.width,l=e.y+e.height,n&&(l+=16);break;case"right":a=e.x+e.width,l=e.y+e.height/2;break;case"rightBottom":a=e.x+e.width,l=e.y;break;case"bottom":a=e.x+e.width/2,l=e.y;break;case"bottomLeft":a=e.x,l=e.y;break;case"left":a=e.x,l=e.y+e.height/2;break;case"leftTop":a=e.x,l=e.y+e.height,n&&(l+=16);break;case"center":a=e.x+e.width/2,l=e.y+e.height/2}a-=this.label.offsetX;var r=1;return t.value<t.yOriginPoint.value&&(r=-1),l-=r*this.label.offsetY,i.x=a,i.y=l,i}},{key:"grow",value:function(d,e){var s=this;if(s._preDataLen>s._dataLen)for(var t=s._dataLen,i=s._preDataLen;t<i;t++)s.barsSp.getChildAt(t).destroy(),s.label.enabled&&s.txtsSp.getChildAt(t).destroy(),t--,i--;if(e.animate){var o=_mmvis._.extend({delay:Math.min(1e3/this._barsLen,80),easing:"Linear.None",duration:500},e),h=0;_mmvis._.each(s.enabledField,function(e,t){var i=(e=_mmvis._.flatten([e])).length;if(0!=i)for(var a=0;a<s._dataLen;a++)for(var l=0;l<i;l++){var n=s.data[e[l]][a],r=s.barsSp.getChildById("barGroup_"+a).getChildById("bar_"+a+"_"+n.field);0==o.duration?(r.context.scaleY=1,r.context.y=1*r.finalPos.y,r.context.x=r.finalPos.x,r.context.width=r.finalPos.width,r.context.height=r.finalPos.height):(r._tweenObj&&AnimationFrame.destroyTween(r._tweenObj),r._tweenObj=r.animate({scaleY:1,y:1*r.finalPos.y,x:r.finalPos.x,width:r.finalPos.width,height:r.finalPos.height},{duration:o.duration,easing:o.easing,delay:a*o.delay,onUpdate:function(){},onComplete:function(e){e.width<3&&this.context&&(this.context.radius=0),++h===s.node._count&&d&&d(s)},id:r.id}))}})}else d&&d(s)}},{key:"selectAt",value:function(e){var a=this;if(!(-1<_mmvis._.indexOf(this.select.inds,e))){this.select.inds.push(e);var l=e-this.dataFrame.range.start;_mmvis._.each(this.data,function(e,t){var i=e[l];i.selected=!0,a.setNodeElementStyle(i)});var t=this.barsSp.getChildById("barGroup_"+l);if(t){var i=t.getChildById("group_region_"+l);i&&(i.context.globalAlpha=this.select.alpha)}}}},{key:"unselectAt",value:function(e){var a=this;if(-1!=_mmvis._.indexOf(this.select.inds,e)){var t=_mmvis._.indexOf(this.select.inds,e);this.select.inds.splice(t,1);var l=e-this.dataFrame.range.start;_mmvis._.each(this.data,function(e,t){var i=e[l];i.selected=!1,a.setNodeElementStyle(i)});var i=this.barsSp.getChildById("barGroup_"+l);if(i){var n=i.getChildById("group_region_"+l);n&&(n.context.globalAlpha=0)}}}},{key:"getSelectedRowList",value:function(){var t=[],i=this;return _mmvis._.each(i.select.inds,function(e){t.push(i.dataFrame.jsonOrg[e])}),t}},{key:"setNodeElementStyle",value:function(e){var t=this._getColor(this.node.fillStyle,e);e.nodeElement.context.fillStyle=t}},{key:"getGraphSelectOpt",value:function(){var t=this._opt.select;if(!t){var e=this.app.getComponents({name:"graphs",type:"bar"});_mmvis._.each(e,function(e){if(t)return!1;!t&&e._opt.select&&(t=e.select)})}return t}}]),a}(_index2.default);_mmvis.global.registerComponent(BarGraphs,"graphs","bar");var _default=BarGraphs;exports.default=_default;