"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_canvax=_interopRequireDefault(require("canvax")),_index=_interopRequireDefault(require("../index")),_partition=_interopRequireDefault(require("../../../layout/partition")),_mmvis=require("mmvis"),Sector=_canvax.default.Shapes.Sector,sunburstGraphs=function(e){function i(e,t){var a;return(0,_classCallCheck2.default)(this,i),(a=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(i).call(this,e,t))).type="sunburst",_mmvis._.extend(!0,(0,_assertThisInitialized2.default)(a),(0,_mmvis.getDefaultProps)(i.defaultProps()),e),a.data=[],a.dataGroup=[],a.init(),a}return(0,_inherits2.default)(i,e),(0,_createClass2.default)(i,null,[{key:"defaultProps",value:function(){return{keyField:{detail:"key字段",default:"name"},valueField:{detail:"value字段",default:"value"},parentField:{detail:"parent字段",default:"parent"},node:{detail:"单个节点图形设置",propertys:{strokeStyle:{detail:"描边色",default:"#ffffff"},lineWidth:{detail:"描边线宽",default:1},strokeAlpha:{detail:"描边边框透明度",default:1},fillStyle:{detail:"背景色",default:null},fillAlpha:{detail:"背景透明度",default:1},blurAlpha:{detail:"非激活状态透明度",documentation:"比如选中其中一项，其他不先关的要降低透明度",default:.4}}}}}}]),(0,_createClass2.default)(i,[{key:"init",value:function(){}},{key:"draw",value:function(e){e=e||{},_mmvis._.extend(!0,this,e),this.data=this._trimGraphs(),this.dataGroup=this._getDataGroupOfDepth(),this._widget(),this.sprite.context.x=this.width/2+this.origin.x,this.sprite.context.y=this.height/2+this.origin.y,this.fire("complete")}},{key:"_trimGraphs",value:function(){var t=this,e=parseInt(Math.min(this.width,this.height)/2),a=(0,_partition.default)().sort(null).size([2*Math.PI,e*e]).value(function(e){return e[t.valueField]}),i=this._tansTreeData();return this.data=a(i,0),this.data}},{key:"_getDataGroupOfDepth",value:function(){var t={};_mmvis._.each(this.data,function(e){t[e.depth]=[]}),_mmvis._.each(this.data,function(e){t[e.depth].push(e)});var e=[];for(var a in t)e.push(t[a]);return e}},{key:"_tansTreeData",value:function(){var e=this.dataFrame,t={},s=e.getFieldData(this.keyField),o=e.getFieldData(this.valueField),h=e.getFieldData(this.parentField);return function i(r,e,t){for(var a=e?e.name:void 0,n=t||0;n<h.length;n++){var l=h[n];if(l||0===l||(l=void 0),a===l){r.name=s[n],r.iNode=n;var u=o[n];!u&&0!==u||(r.value=u),_mmvis._.each(h,function(e,t){if(e===r.name){r.children||(r.children=[]);var a={};i(a,r,t),r.children.push(a)}});break}}}(t),t}},{key:"_widget",value:function(){var u=this;_mmvis._.each(this.dataGroup,function(n,l){_mmvis._.each(n,function(t,e){if(t.depth){var a=Math.sqrt(t.y+t.dy),i={r0:Math.sqrt(t.y),r:Math.sqrt(t.y)+2,startAngle:180*t.x/Math.PI,endAngle:180*(t.x+t.dx)/Math.PI,fillStyle:t.color||u.app.getTheme(t.iNode),strokeStyle:u.node.strokeStyle,lineWidth:u.node.lineWidth,globalAlpha:0},r=new Sector({id:"sector_"+l+"_"+e,context:i});(r.layoutData=t).sector=r,t.group=n,u.sprite.addChild(r),r.hover(function(e){u._focus(t,n)},function(e){u._unfocus(t,n)}),r.on(_mmvis.event.types.get(),function(e){e.eventInfo={trigger:u.node,iNode:t.iNode},u.app.fire(e.type,e)}),l<=1?(r.context.r=a,r.context.globalAlpha=1):setTimeout(function(){r.context&&(r.context.globalAlpha=1,r.animate({r:a},{duration:350}))},350*(l-1))}})})}},{key:"getNodesAt",value:function(t){var e=[];if(void 0!==t){var a=_mmvis._.find(this.data,function(e){return e.iNode==t});a.type="sunburst",a&&e.push(a)}return e}},{key:"_focus",value:function(t,e){var a=this;_mmvis._.each(e,function(e){e!==t&&(e.sector.context.globalAlpha=a.node.blurAlpha,a._focusChildren(e,function(e){e.sector.context.globalAlpha=a.node.blurAlpha}))}),a._focusParent(t)}},{key:"_unfocus",value:function(){_mmvis._.each(this.data,function(e){e.sector&&(e.sector.context.globalAlpha=1)})}},{key:"_focusChildren",value:function(e,t){var a=this;e.children&&e.children.length&&_mmvis._.each(e.children,function(e){t(e),a._focusChildren(e,t)})}},{key:"_focusParent",value:function(t){var a=this;t.parent&&t.parent.sector&&t.parent.group&&_mmvis._.each(t.parent.group,function(e){e===t.parent?(e.sector.context.globalAlpha=1,a._focusParent(t.parent)):e.sector.context.globalAlpha=a.node.blurAlpha})}}]),i}(_index.default);_mmvis.global.registerComponent(sunburstGraphs,"graphs","sunburst");var _default=sunburstGraphs;exports.default=_default;