"use strict";var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard"),_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_canvax=_interopRequireDefault(require("canvax")),_index=_interopRequireDefault(require("../index")),_mmvis=require("mmvis"),force=_interopRequireWildcard(require("../../../layout/force/index")),Rect=_canvax.default.Shapes.Rect,Path=_canvax.default.Shapes.Path,Arrow=_canvax.default.Shapes.Arrow,Circle=_canvax.default.Shapes.Circle,Text=_canvax.default.Display.Text,Line=_canvax.default.Shapes.Line,Force=function(e){function i(e,t){var a;return(0,_classCallCheck2.default)(this,i),(a=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(i).call(this,e,t))).type="force",_mmvis._.extend(!0,(0,_assertThisInitialized2.default)(a),(0,_mmvis.getDefaultProps)(i.defaultProps()),e),a.domContainer=t.canvax.domView,a.init(),a}return(0,_inherits2.default)(i,e),(0,_createClass2.default)(i,null,[{key:"defaultProps",value:function(){return{keyField:{detail:"key字段",default:"key"},valueField:{detail:"value字段",default:"value"},node:{detail:"单个节点的配置",propertys:{shapeType:{detail:"节点图形",default:"circle"},maxWidth:{detail:"节点最大的width",default:200},width:{detail:"内容的width",default:null},height:{detail:"内容的height",default:null},radius:{detail:"圆角角度",default:6},fillStyle:{detail:"节点背景色",default:"#acdf7d"},strokeStyle:{detail:"描边颜色",default:"#e5e5e5"},padding:{detail:"node节点容器到内容的边距",default:10},content:{detail:"节点内容配置",propertys:{field:{detail:"内容字段",documentation:"默认content字段",default:"content"},fontColor:{detail:"内容文本颜色",default:"#666"},format:{detail:"内容格式化处理函数",default:null},textAlign:{detail:"textAlign",default:"center"},textBaseline:{detail:"textBaseline",default:"middle"}}}}},line:{detail:"两个节点连线配置",propertys:{lineWidth:{detail:"线宽",default:1},strokeStyle:{detail:"连线的颜色",default:"#e5e5e5"},lineType:{detail:"连线样式（虚线等）",default:"solid"},arrow:{detail:"是否有箭头",default:!0}}},status:{detail:"一些开关配置",propertys:{transform:{detail:"是否启动拖拽缩放整个画布",propertys:{fitView:{detail:"自动缩放",default:""},enabled:{detail:"是否开启",default:!0},scale:{detail:"缩放值",default:1},scaleOrigin:{detail:"缩放原点",default:{x:0,y:0}}}}}}}}}]),(0,_createClass2.default)(i,[{key:"init",value:function(){this.nodesSp=new _canvax.default.Display.Sprite({id:"nodesSp"}),this.edgesSp=new _canvax.default.Display.Sprite({id:"edgesSp"}),this.graphsSp=new _canvax.default.Display.Sprite({id:"graphsSp"}),this.graphsSp.addChild(this.edgesSp),this.graphsSp.addChild(this.nodesSp),this.sprite.addChild(this.graphsSp)}},{key:"draw",value:function(e){e=e||{},_mmvis._.extend(!0,this,e),this.data=e.data||this._initData(),this.widget()}},{key:"_initData",value:function(){for(var e={nodes:[],edges:[],size:{width:this.app.width,height:this.app.height}},a={},t=0;t<this.dataFrame.length;t++){var i=this.dataFrame.getRowDataAt(t),l=_mmvis._.flatten([(i[this.keyField]+"").split(",")]),r=this._getContent(i),n=1==l.length?l[0]:l,d=new _canvax.default.Display.Sprite({id:"nodeSp_"+n});this.graphsSp.addChild(d);var o={type:"force",iNode:t,rowData:i,key:n,content:r,ctype:this._checkHtml(r)?"html":"canvas",element:d,width:null,height:null,radius:1,x:null,y:null,shapeType:null,source:null,target:null};1==l.length?(o.shapeType=this.getProp(this.node.shapeType,o),e.nodes.push(o),a[o.key]=o):(o.shapeType="line",e.edges.push(o))}return _mmvis._.each(e.edges,function(e){var t=e.key;e.source=a[t[0]],e.target=a[t[1]]}),e}},{key:"widget",value:function(){var l=this,r=this,t=this.keyField,a=this.valueField,e=this.data.edges.map(function(e){return{source:e.source[t],target:e.target[t],value:e.rowData[a],nodeData:e}}),i=this.data.nodes.map(function(e){var t=Object.create(e);return t.id=e.key,t.nodeData=e,t}),n=this.data.size,d=n.width,o=n.height,s=force.forceSimulation(i).force("link",force.forceLink(e).id(function(e){return e.id})).force("charge",force.forceManyBody()).force("center",force.forceCenter(d/2,o/2)).force("x",force.forceX(d/2).strength(.045)).force("y",force.forceY(o/2).strength(.045));i.forEach(function(e){var t=r.getProp(r.node.fillStyle,e.nodeData),a=r.getProp(r.node.strokeStyle,e.nodeData),i=new Circle({context:{r:8,fillStyle:t,strokeStyle:a}});e.nodeData.element.addChild(i);var l=new Text(e.nodeData.rowData.label,{context:{fontSize:11,fillStyle:"#bfa08b",textBaseline:"middle",textAlign:"center",globalAlpha:.7}});e.nodeData.element.addChild(l)}),e.forEach(function(e){var t=r.getProp(r.line.lineWidth,e.nodeData),a=r.getProp(r.line.strokeStyle,e.nodeData),i=new Line({context:{lineWidth:t,strokeStyle:a,start:{x:0,y:0},end:{x:0,y:0},globalAlpha:.4}});l.edgesSp.addChild(i),e.line=i}),s.on("tick",function(){s.alpha()<=.05?s.stop():(i.forEach(function(e){var t=e.nodeData.element.context;t&&(t.x=e.x,t.y=e.y)}),e.forEach(function(e){var t=e.line.context;t&&(t.start.x=e.source.x,t.start.y=e.source.y,t.end.x=e.target.x,t.end.y=e.target.y)}))})}},{key:"_checkHtml",value:function(e){return/<[^>]+>/g.test(e)}},{key:"_getContent",value:function(e){var t;return this._isField(this.node.content.field)&&(t=e[this.node.content.field]),this.node.content.format&&_mmvis._.isFunction(this.node.content.format)&&(t=this.node.content.format.apply(this,[t,e])),t}},{key:"_isField",value:function(e){return~this.dataFrame.fields.indexOf(e)}},{key:"getNodesAt",value:function(){}},{key:"getProp",value:function(e,t){var a=e;return this._isField(e)&&t.rowData?a=t.rowData[e]:(_mmvis._.isArray(e)&&(a=e[t.iNode]),_mmvis._.isFunction(e)&&(a=e.apply(this,[t]))),a}}]),i}(_index.default);_mmvis.global.registerComponent(Force,"graphs","force");var _default=Force;exports.default=_default;