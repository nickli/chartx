"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_canvax=_interopRequireDefault(require("canvax")),_mmvis=require("mmvis"),Sector=_canvax.default.Shapes.Sector,Path=_canvax.default.Shapes.Path,AnimationFrame=_canvax.default.AnimationFrame,Pie=function(e){function s(e,t){var n;return(0,_classCallCheck2.default)(this,s),(n=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(s).call(this))).width=0,n.height=0,n.origin={x:0,y:0},n._graphs=e,n.domContainer=e.app.canvax.domView,n.data=t,n.sprite=null,n.textSp=null,n.sectorsSp=null,n.selectedSp=null,n.init(),n.sectors=[],n.textMaxCount=15,n.textList=[],n.completed=!1,n}return(0,_inherits2.default)(s,e),(0,_createClass2.default)(s,[{key:"init",value:function(){this.sprite=new _canvax.default.Display.Sprite,this.sectorsSp=new _canvax.default.Display.Sprite,this.sprite.addChild(this.sectorsSp),this.selectedSp=new _canvax.default.Display.Sprite,this.sprite.addChild(this.selectedSp),this._graphs.label.enabled&&(this.textSp=new _canvax.default.Display.Sprite)}},{key:"draw",value:function(e){var t=this;_mmvis._.extend(!0,this,e),this.sprite.context.x=t.origin.x,this.sprite.context.y=t.origin.y,t._widget()}},{key:"resetData",value:function(e){var t=this;this.data=e,t.destroyLabel();for(var n=0,s=0;s<t.sectors.length;s++){var a=t.sectors[s],i=this.data.list[s];a.animate({r:i.outRadius,startAngle:i.startAngle,endAngle:i.endAngle},{duration:280,onComplete:function(){++n==t.sectors.length&&t._graphs.label.enabled&&t._startWidgetLabel()}})}}},{key:"_widget",value:function(){var t=this,e=t.data.list,n=t.data.total;if(0<e.length&&0<n){t.textSp&&t.sprite.addChild(t.textSp);for(var s=0;s<e.length;s++){var a=e[s],i=new Sector({hoverClone:!1,xyToInt:!1,context:{x:a.focused?a.outOffsetx:0,y:a.focused?a.outOffsety:0,r0:a.innerRadius,r:a.outRadius,startAngle:a.startAngle,endAngle:a.endAngle,fillStyle:a.fillStyle,cursor:"pointer"},id:"sector"+s});(i.nodeData=a).focusEnabled&&i.hover(function(e){t.focusOf(this.nodeData)},function(e){this.nodeData.selected||t.unfocusOf(this.nodeData)}),i.on(_mmvis.event.types.get(),function(e){e.eventInfo={trigger:t._graphs.node,nodes:[this.nodeData]},t._graphs.app.fire(e.type,e)}),t.sectorsSp.addChildAt(i,0),t.sectors.push(i)}t._graphs.label.enabled&&t._startWidgetLabel()}}},{key:"focusOf",value:function(e,t){if(!e.focused){this.sectors[e.iNode].animate({x:e.outOffsetx,y:e.outOffsety},{duration:100,onComplete:function(){t&&t()}}),e.focused=!0}}},{key:"unfocusOf",value:function(e,t){if(e.focused){this.sectors[e.iNode].animate({x:0,y:0},{duration:100,onComplete:function(){t&&t()}}),e.focused=!1}}},{key:"selectOf",value:function(e){var t=this;if(this.sectors.length&&e.selectEnabled){var n=this.sectors[e.iNode];e.selected||(e.focused?this.addCheckedSec(n):(e._focusTigger="select",this.focusOf(e,function(){t.addCheckedSec(n)})),e.selected=!0)}}},{key:"unselectOf",value:function(e){var t=this.sectors[e.iNode];if(e.selected&&e.selectEnabled){var n=this;n.cancelCheckedSec(t,function(){"select"==e._focusTigger&&n.unfocusOf(e)}),e.selected=!1}}},{key:"addCheckedSec",value:function(e,t){var n=e.context,s=e.nodeData;if(n){var a=new Sector({xyToInt:!1,context:{x:n.x,y:n.y,r0:n.r-1,r:n.r+s.selectedR,startAngle:n.startAngle,endAngle:n.startAngle,fillStyle:n.fillStyle,globalAlpha:s.selectedAlpha},id:"selected_"+e.id});e._selectedSec=a,this.selectedSp.addChild(a),this.completed?a.animate({endAngle:n.endAngle},{duration:this._getAngleTime(n),onComplete:function(){t&&t()}}):a.context.endAngle=n.endAngle}}},{key:"cancelCheckedSec",value:function(e,t){var n=e._selectedSec;n.animate({startAngle:n.context.endAngle-.5},{duration:this._getAngleTime(e.context),onComplete:function(){delete e._selectedSec,n.destroy(),t&&t()}})}},{key:"_getAngleTime",value:function(e){return Math.abs(e.startAngle-e.endAngle)/360*500}},{key:"grow",value:function(e){var d=this;_mmvis._.each(d.sectors,function(e,t){e.context&&(e.context.r0=0,e.context.r=0,e.context.startAngle=d._graphs.startAngle,e.context.endAngle=d._graphs.startAngle)}),d._hideGrowLabel();var t=AnimationFrame.registTween({from:{process:0},to:{process:1},duration:500,onUpdate:function(e){for(var t=0;t<d.sectors.length;t++){var n=d.sectors[t],s=n.nodeData,a=n.context,i=s.startAngle,r=s.endAngle,l=s.outRadius,o=s.innerRadius;if(a){if(a.r=l*e.process,a.r0=o*e.process,0==t)a.startAngle=i,a.endAngle=i+(r-i)*e.process;else{var c=function(e){var t=e-1,n=d.sectors[t].context;return 0==t?n?n.endAngle:0:n?n.endAngle:arguments.callee(t)}(t);a.startAngle=c,a.endAngle=a.startAngle+(r-i)*e.process}n._selectedSec&&(n._selectedSec.context.r0=a.r-1,n._selectedSec.context.r=a.r+s.selectedR,n._selectedSec.context.startAngle=a.startAngle,n._selectedSec.context.endAngle=a.endAngle)}}},onComplete:function(){d.sprite._removeTween(t),d._showGrowLabel(),d.completed=!0,e&&e()}});d.sprite._tweens.push(t)}},{key:"_widgetLabel",value:function(e,t,n,s,a,i){var r,l,o,c,d,u,h,f,p,g,x,v,_=this,y=0,m=_.data.list,b=2==e||3==e,S=3==e||4==e,A=b?n:s;0<t.length&&t.sort(function(e,t){return S?m[e].edgey-m[t].edgey:m[t].edgey-m[e].edgey});for(var C=0;C<t.length;C++){r=t[C];var w=m[r],k=w.outRadius+w.moveDis;if(!(!w.enabled||w.y<A||y>=_.textMaxCount)){y++,o=w.edgey,c=Math.abs(w.edgex),d=o-l,0!=C&&(Math.abs(d)<15||S&&d<0||!S&&0<d)&&(o=S?l+15:l-15,0<k-Math.abs(o)&&(c=Math.sqrt(Math.pow(k,2)-Math.pow(o,2))),(b&&-c>w.edgex||!b&&c<w.edgex)&&(c=Math.abs(w.edgex))),a&&(g=b?i.left:i.right,x=t.length-C,v=S?g-15*x:g+15*x,(S&&v<o||!S&&o<v)&&(o=v)),l=o,a||(b?i.left=l:i.right=l);var D=b?-c-5:c+5,R=D+_.origin.x,q=o+_.origin.y;if(R>_._graphs.app.width||q<0||q>_._graphs.app.height)return;var L="M"+w.centerx+","+w.centery;L+="Q"+w.outx+","+w.outy+","+D+","+o;var M=new Path({context:{lineType:"solid",path:L,lineWidth:1,strokeStyle:w.fillStyle}}),Q=w.labelText,O=document.createElement("div");switch(O.style.cssText=" ;position:absolute;left:-1000px;top:-1000px;color:"+w.fillStyle,O.innerHTML=Q,_.domContainer.appendChild(O),u=O.offsetWidth,h=O.offsetHeight,f=b?-c:c,p=o,e){case 1:f+=5,p-=h/2;break;case 2:case 3:f-=u+5,p-=h/2;break;case 4:f+=5,p-=h/2}O.style.left=f+_.origin.x+"px",O.style.top=p+_.origin.y+"px",_.textSp.addChild(M),_.textList.push({width:u,height:h,x:f+_.origin.x,y:p+_.origin.y,data:w,textTxt:Q,textEle:O})}}}},{key:"_startWidgetLabel",value:function(){for(var e,t,n=this,s=n.data.list,a=0,i=0,r=[],l=[{indexs:[],count:0},{indexs:[],count:0},{indexs:[],count:0},{indexs:[],count:0}],o={right:{startQuadrant:4,endQuadrant:1,clockwise:!0,indexs:[]},left:{startQuadrant:3,endQuadrant:2,clockwise:!1,indexs:[]}},c=0;c<s.length;c++){var d=s[c].quadrant;l[d-1].indexs.push(c),l[d-1].count++}1<l[0].count&&l[0].indexs.reverse(),1<l[2].count&&l[2].indexs.reverse(),l[0].count>l[3].count&&(o.right.startQuadrant=1,o.right.endQuadrant=4,o.right.clockwise=!1),l[1].count>l[2].count&&(o.left.startQuadrant=2,o.left.endQuadrant=3,o.left.clockwise=!0),o.right.indexs=l[o.right.startQuadrant-1].indexs.concat(l[o.right.endQuadrant-1].indexs),o.left.indexs=l[o.left.startQuadrant-1].indexs.concat(l[o.left.endQuadrant-1].indexs),o.right.indexs.length>n.textMaxCount&&((t=o.right.indexs.slice(0)).sort(function(e,t){return s[t].y-s[e].y}),e=t.slice(n.textMaxCount),s[e[0]].percentage,a=s[e[0]].y),o.left.indexs.length>n.textMaxCount&&((t=o.left.indexs.slice(0)).sort(function(e,t){return s[t].y-s[e].y}),e=t.slice(n.textMaxCount),s[e[0]].percentage,i=s[e[0]].y),r.push(o.right.startQuadrant),r.push(o.right.endQuadrant),r.push(o.left.startQuadrant),r.push(o.left.endQuadrant);var u={};for(c=0;c<r.length;c++){var h=1==c||3==c;n._widgetLabel(r[c],l[r[c]-1].indexs,i,a,h,u)}}},{key:"destroyLabel",value:function(){var t=this;this.textSp&&this.textSp.removeAllChildren(),_mmvis._.each(this.textList,function(e){t.domContainer.removeChild(e.textEle)}),this.textList=[]}},{key:"_showGrowLabel",value:function(){this.textSp&&this.textSp.context&&(this.textSp.context.globalAlpha=1,_mmvis._.each(this.textList,function(e){e.textEle.style.visibility="visible"}))}},{key:"_hideGrowLabel",value:function(){this.textSp&&this.textSp.context&&(this.textSp.context.globalAlpha=0,_mmvis._.each(this.textList,function(e){e.textEle.style.visibility="hidden"}))}}]),s}(_mmvis.event.Dispatcher);exports.default=Pie;