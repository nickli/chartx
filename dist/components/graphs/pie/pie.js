"use strict";!function(e,t){if("function"==typeof define&&define.amd)define(["exports","canvax","mmvis"],t);else if("undefined"!=typeof exports)t(exports,require("canvax"),require("mmvis"));else{var n={};t(n,e.canvax,e.mmvis),e.undefined=n}}(void 0,function(e,t,a){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n,i=(n=t)&&n.__esModule?n:{default:n};function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var d,u,f,h=i.default.Shapes.Sector,R=i.default.Shapes.Path,p=i.default.AnimationFrame,g=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(x,a.event.Dispatcher),d=x,(u=[{key:"init",value:function(){this.sprite=new i.default.Display.Sprite,this.sectorsSp=new i.default.Display.Sprite,this.sprite.addChild(this.sectorsSp),this.selectedSp=new i.default.Display.Sprite,this.sprite.addChild(this.selectedSp),this._graphs.label.enabled&&(this.textSp=new i.default.Display.Sprite)}},{key:"draw",value:function(e){a._.extend(!0,this,e),this.sprite.context.x=this.origin.x,this.sprite.context.y=this.origin.y,this._widget()}},{key:"resetData",value:function(e){var t=this;this.data=e,t.destroyLabel();for(var n=0,i=0;i<t.sectors.length;i++){var s=t.sectors[i],o=this.data.list[i];s.animate({r:o.outRadius,startAngle:o.startAngle,endAngle:o.endAngle},{duration:280,onComplete:function(){++n==t.sectors.length&&t._graphs.label.enabled&&t._startWidgetLabel()}})}}},{key:"_widget",value:function(){var t=this,e=t.data.list,n=t.data.total;if(0<e.length&&0<n){t.textSp&&t.sprite.addChild(t.textSp);for(var i=0;i<e.length;i++){var s=e[i],o=new h({hoverClone:!1,xyToInt:!1,context:{x:s.focused?s.outOffsetx:0,y:s.focused?s.outOffsety:0,r0:s.innerRadius,r:s.outRadius,startAngle:s.startAngle,endAngle:s.endAngle,fillStyle:s.fillStyle,cursor:"pointer"},id:"sector"+i});(o.nodeData=s).focusEnabled&&o.hover(function(e){t.focusOf(this.nodeData)},function(e){this.nodeData.selected||t.unfocusOf(this.nodeData)}),o.on(a.event.types.get(),function(e){e.eventInfo={trigger:t._graphs.node,nodes:[this.nodeData]},t._graphs.app.fire(e.type,e)}),t.sectorsSp.addChildAt(o,0),t.sectors.push(o)}t._graphs.label.enabled&&t._startWidgetLabel()}}},{key:"focusOf",value:function(e,t){e.focused||(this.sectors[e.iNode].animate({x:e.outOffsetx,y:e.outOffsety},{duration:100,onComplete:function(){t&&t()}}),e.focused=!0)}},{key:"unfocusOf",value:function(e,t){e.focused&&(this.sectors[e.iNode].animate({x:0,y:0},{duration:100,onComplete:function(){t&&t()}}),e.focused=!1)}},{key:"selectOf",value:function(e){var t=this;if(this.sectors.length&&e.selectEnabled){var n=this.sectors[e.iNode];e.selected||(e.focused?this.addCheckedSec(n):(e._focusTigger="select",this.focusOf(e,function(){t.addCheckedSec(n)})),e.selected=!0)}}},{key:"unselectOf",value:function(e){var t=this.sectors[e.iNode];if(e.selected&&e.selectEnabled){var n=this;n.cancelCheckedSec(t,function(){"select"==e._focusTigger&&n.unfocusOf(e)}),e.selected=!1}}},{key:"addCheckedSec",value:function(e,t){var n=e.context,i=e.nodeData;if(n){var s=new h({xyToInt:!1,context:{x:n.x,y:n.y,r0:n.r-1,r:n.r+i.selectedR,startAngle:n.startAngle,endAngle:n.startAngle,fillStyle:n.fillStyle,globalAlpha:i.selectedAlpha},id:"selected_"+e.id});e._selectedSec=s,this.selectedSp.addChild(s),this.completed?s.animate({endAngle:n.endAngle},{duration:this._getAngleTime(n),onComplete:function(){t&&t()}}):s.context.endAngle=n.endAngle}}},{key:"cancelCheckedSec",value:function(e,t){var n=e._selectedSec;n.animate({startAngle:n.context.endAngle-.5},{duration:this._getAngleTime(e.context),onComplete:function(){delete e._selectedSec,n.destroy(),t&&t()}})}},{key:"_getAngleTime",value:function(e){return Math.abs(e.startAngle-e.endAngle)/360*500}},{key:"grow",value:function(e){var d=this;a._.each(d.sectors,function(e,t){e.context&&(e.context.r0=0,e.context.r=0,e.context.startAngle=d._graphs.startAngle,e.context.endAngle=d._graphs.startAngle)}),d._hideGrowLabel();var t=p.registTween({from:{process:0},to:{process:1},duration:500,onUpdate:function(e){for(var t=0;t<d.sectors.length;t++){var n=d.sectors[t],i=n.nodeData,s=n.context,o=i.startAngle,a=i.endAngle,r=i.outRadius,l=i.innerRadius;if(s){if(s.r=r*e.process,s.r0=l*e.process,0==t)s.startAngle=o,s.endAngle=o+(a-o)*e.process;else{var c=function(e){var t=e-1,n=d.sectors[t].context;return 0==t?n?n.endAngle:0:n?n.endAngle:arguments.callee(t)}(t);s.startAngle=c,s.endAngle=s.startAngle+(a-o)*e.process}n._selectedSec&&(n._selectedSec.context.r0=s.r-1,n._selectedSec.context.r=s.r+i.selectedR,n._selectedSec.context.startAngle=s.startAngle,n._selectedSec.context.endAngle=s.endAngle)}}},onComplete:function(){d.sprite._removeTween(t),d._showGrowLabel(),d.completed=!0,e&&e()}});d.sprite._tweens.push(t)}},{key:"_widgetLabel",value:function(e,t,n,i,s,o){var a,r,l,c,d,u,f,h,p,g,x,y,v=this,b=0,S=v.data.list,_=2==e||3==e,m=3==e||4==e,A=_?n:i;0<t.length&&t.sort(function(e,t){return m?S[e].edgey-S[t].edgey:S[t].edgey-S[e].edgey});for(var w=0;w<t.length;w++){a=t[w];var C=S[a],k=C.outRadius+C.moveDis;if(!(!C.enabled||C.y<A||b>=v.textMaxCount)){b++,l=C.edgey,c=Math.abs(C.edgex),d=l-r,0!=w&&(Math.abs(d)<15||m&&d<0||!m&&0<d)&&(l=m?r+15:r-15,0<k-Math.abs(l)&&(c=Math.sqrt(Math.pow(k,2)-Math.pow(l,2))),(_&&-c>C.edgex||!_&&c<C.edgex)&&(c=Math.abs(C.edgex))),s&&(g=_?o.left:o.right,x=t.length-w,y=m?g-15*x:g+15*x,(m&&y<l||!m&&l<y)&&(l=y)),r=l,s||(_?o.left=r:o.right=r);var O=_?-c-5:c+5,L=O+v.origin.x,M=l+v.origin.y;if(L>v._graphs.app.width||M<0||M>v._graphs.app.height)return;var Q="M"+C.centerx+","+C.centery;Q+="Q"+C.outx+","+C.outy+","+O+","+l;var T=new R({context:{lineType:"solid",path:Q,lineWidth:1,strokeStyle:C.fillStyle}}),D=C.labelText,E=document.createElement("div");switch(E.style.cssText=" ;position:absolute;left:-1000px;top:-1000px;color:"+C.fillStyle,E.innerHTML=D,v.domContainer.appendChild(E),u=E.offsetWidth,f=E.offsetHeight,h=_?-c:c,p=l,e){case 1:h+=5,p-=f/2;break;case 2:case 3:h-=u+5,p-=f/2;break;case 4:h+=5,p-=f/2}E.style.left=h+v.origin.x+"px",E.style.top=p+v.origin.y+"px",v.textSp.addChild(T),v.textList.push({width:u,height:f,x:h+v.origin.x,y:p+v.origin.y,data:C,textTxt:D,textEle:E})}}}},{key:"_startWidgetLabel",value:function(){for(var e,t,n=this,i=n.data.list,s=0,o=0,a=[],r=[{indexs:[],count:0},{indexs:[],count:0},{indexs:[],count:0},{indexs:[],count:0}],l={right:{startQuadrant:4,endQuadrant:1,clockwise:!0,indexs:[]},left:{startQuadrant:3,endQuadrant:2,clockwise:!1,indexs:[]}},c=0;c<i.length;c++){var d=i[c].quadrant;r[d-1].indexs.push(c),r[d-1].count++}1<r[0].count&&r[0].indexs.reverse(),1<r[2].count&&r[2].indexs.reverse(),r[0].count>r[3].count&&(l.right.startQuadrant=1,l.right.endQuadrant=4,l.right.clockwise=!1),r[1].count>r[2].count&&(l.left.startQuadrant=2,l.left.endQuadrant=3,l.left.clockwise=!0),l.right.indexs=r[l.right.startQuadrant-1].indexs.concat(r[l.right.endQuadrant-1].indexs),l.left.indexs=r[l.left.startQuadrant-1].indexs.concat(r[l.left.endQuadrant-1].indexs),l.right.indexs.length>n.textMaxCount&&((t=l.right.indexs.slice(0)).sort(function(e,t){return i[t].y-i[e].y}),e=t.slice(n.textMaxCount),i[e[0]].percentage,s=i[e[0]].y),l.left.indexs.length>n.textMaxCount&&((t=l.left.indexs.slice(0)).sort(function(e,t){return i[t].y-i[e].y}),e=t.slice(n.textMaxCount),i[e[0]].percentage,o=i[e[0]].y),a.push(l.right.startQuadrant),a.push(l.right.endQuadrant),a.push(l.left.startQuadrant),a.push(l.left.endQuadrant);var u={};for(c=0;c<a.length;c++){var f=1==c||3==c;n._widgetLabel(a[c],r[a[c]-1].indexs,o,s,f,u)}}},{key:"destroyLabel",value:function(){var t=this;this.textSp&&this.textSp.removeAllChildren(),a._.each(this.textList,function(e){t.domContainer.removeChild(e.textEle)}),this.textList=[]}},{key:"_showGrowLabel",value:function(){this.textSp&&this.textSp.context&&(this.textSp.context.globalAlpha=1,a._.each(this.textList,function(e){e.textEle.style.visibility="visible"}))}},{key:"_hideGrowLabel",value:function(){this.textSp&&this.textSp.context&&(this.textSp.context.globalAlpha=0,a._.each(this.textList,function(e){e.textEle.style.visibility="hidden"}))}}])&&o(d.prototype,u),void(f&&o(d,f)),x);function x(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,x),(n=r(this,l(x).call(this))).width=0,n.height=0,n.origin={x:0,y:0},n._graphs=e,n.domContainer=e.app.canvax.domView,n.data=t,n.sprite=null,n.textSp=null,n.sectorsSp=null,n.selectedSp=null,n.init(),n.sectors=[],n.textMaxCount=15,n.textList=[],n.completed=!1,n}e.default=g});