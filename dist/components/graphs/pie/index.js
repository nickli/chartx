"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_pie=_interopRequireDefault(require("./pie")),_index=_interopRequireDefault(require("../index")),_mmvis=require("mmvis"),PieGraphs=function(e){function a(e,t){var i;return(0,_classCallCheck2.default)(this,a),(i=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(a).call(this,e,t))).type="pie",_mmvis._.extend(!0,(0,_assertThisInitialized2.default)(i),(0,_mmvis.getDefaultProps)(a.defaultProps()),e),i.init(),i}return(0,_inherits2.default)(a,e),(0,_createClass2.default)(a,null,[{key:"defaultProps",value:function(){return{field:{detail:"字段配置",default:null},groupField:{detail:"分组字段",default:null,documentation:"groupField主要是给legend用的， 所有在legend中需要显示的分组数据，都用groupField"},sort:{detail:"排序，默认不排序，可以配置为asc,desc",default:null},startAngle:{detail:"起始角度",default:-90},allAngle:{detail:"全部角度",default:360},node:{detail:"单个节点（扇形）配置",propertys:{radius:{detail:"半径",default:null,documentation:"每个扇形单元的半径，也可以配置一个字段，就成了丁格尔玫瑰图"},innerRadius:{detail:"内径",default:0},outRadius:{detail:"外径",default:null},minRadius:{detail:"最小的半径厚度",default:10,documentation:"outRadius - innerRadius ， 也就是radius的最小值"},moveDis:{detail:"hover偏移量",default:15,documentation:"要预留moveDis位置来hover sector 的时候外扩"},fillStyle:{detail:"单个图形背景色",default:null},focus:{detail:"图形的hover设置",propertys:{enabled:{detail:"是否开启",default:!0}}},select:{detail:"图形的选中效果",propertys:{enabled:{detail:"是否开启",default:!0},radius:{detail:"选中效果图形的半径厚度",default:5},alpha:{detail:"选中效果图形的透明度",default:.7}}}}},label:{detail:"label",propertys:{field:{detail:"获取label的字段",default:null},enabled:{detail:"是否开启",default:!1},format:{detail:"label的格式化函数，支持html",default:null}}}}}}]),(0,_createClass2.default)(a,[{key:"init",value:function(){this.data=this._dataHandle()}},{key:"_computerProps",value:function(){var e=this.width,t=this.height;if(!this.node.outRadius){var i=Math.min(e,t)/2;this.label.enabled&&(i-=this.node.moveDis),this.node.outRadius=parseInt(i)}null!==this.node.radius&&_mmvis._.isNumber(this.node.radius)&&(this.node.radius=Math.max(this.node.radius,this.node.minRadius),this.node.innerRadius=this.node.outRadius-this.node.radius),this.node.outRadius-this.node.innerRadius<this.node.minRadius&&(this.node.innerRadius=this.node.outRadius-this.node.minRadius),this.node.innerRadius<0&&(this.node.innerRadius=0)}},{key:"draw",value:function(e){e=e||{},_mmvis._.extend(!0,this,e),this._computerProps(),this._pie=new _pie.default(this,this._trimGraphs(this.data)),this._pie.draw(e);var t=this;this.animation&&!e.resize?this._pie.grow(function(){t.fire("complete")}):this.fire("complete"),this.sprite.addChild(this._pie.sprite)}},{key:"show",value:function(e){this._setEnabled(e,!0)}},{key:"hide",value:function(e){this._setEnabled(e,!1)}},{key:"_setEnabled",value:function(t,i){var e=this;_mmvis._.each(this.data,function(e){if(e.label===t)return e.enabled=i,!1}),e._pie.resetData(e._trimGraphs(e.data))}},{key:"_dataHandle",value:function(){for(var i=this,e=[],t=i.dataFrame,a=0,l=t.length;a<l;a++){var n=t.getRowDataAt(a),r={type:"pie",rowData:n,focused:!1,focusEnabled:i.node.focus.enabled,selected:!1,selectEnabled:i.node.select.enabled,selectedR:i.node.select.radius,selectedAlpha:i.node.select.alpha,enabled:!0,fillStyle:null,color:null,value:n[i.field],label:n[i.groupField||i.label.field||i.field],labelText:null,iNode:a},s=i._getColor(i.node.fillStyle,r);r.fillStyle=r.color=s,e.push(r)}return e.length&&i.sort&&(e.sort(function(e,t){return"asc"==i.sort?e.value-t.value:t.value-e.value}),_mmvis._.each(e,function(e,t){e.iNode=t})),e}},{key:"_trimGraphs",value:function(e){var i=this,t=0;i.currentAngle=0+i.startAngle%360;var a=i.allAngle+i.startAngle%i.allAngle,l=0,n=0;if(e.length){for(var r=0;r<e.length;r++)if(e[r].enabled&&(t+=e[r].value,i.node.radius&&_mmvis._.isString(i.node.radius)&&i.node.radius in e[r].rowData)){var s=Number(e[r].rowData[i.node.radius]);l=Math.max(l,s),n=Math.min(n,s)}if(0<t)for(var u=0;u<e.length;u++){var d=e[u].value/t;e[u].enabled||(d=0);var o=+(100*d).toFixed(2),f=i.allAngle*d,h=i.currentAngle+f>a?a:i.currentAngle+f,c=Math.cos((i.currentAngle+f/2)/180*Math.PI),p=Math.sin((i.currentAngle+f/2)/180*Math.PI),_=i.currentAngle+f/2;c=c.toFixed(5),p=p.toFixed(5);var v=function(e){a<=e&&(e=a),e%=i.allAngle;var t=parseInt(e/90);if(0<=e)switch(t){case 0:return 1;case 1:return 2;case 2:return 3;case 3:case 4:return 4}else if(e<0)switch(t){case 0:return 4;case-1:return 3;case-2:return 2;case-3:case-4:return 1}}(_),m=i.node.outRadius;if(i.node.radius&&_mmvis._.isString(i.node.radius)&&i.node.radius in e[u].rowData){var b=Number(e[u].rowData[i.node.radius]);m=parseInt((i.node.outRadius-i.node.innerRadius)*((b-n)/(l-n))+i.node.innerRadius)}var g=i.node.moveDis;_mmvis._.extend(e[u],{outRadius:m,innerRadius:i.node.innerRadius,startAngle:i.currentAngle,endAngle:h,midAngle:_,moveDis:g,outOffsetx:.7*g*c,outOffsety:.7*g*p,centerx:m*c,centery:m*p,outx:(m+g)*c,outy:(m+g)*p,edgex:(m+g)*c,edgey:(m+g)*p,orginPercentage:d,percentage:o,quadrant:v,labelDirection:1==v||4==v?1:0,iNode:u}),e[u].labelText=i._getLabelText(e[u]),i.currentAngle+=f,i.currentAngle>a&&(i.currentAngle=a)}}return{list:e,total:t}}},{key:"_getColor",value:function(e,t){var i=t.iNode,a=e;return _mmvis._.isArray(e)&&(a=e[i]),_mmvis._.isFunction(e)&&(a=s.apply(this,[t])),a=a||this.app.getTheme(i)}},{key:"_getLabelText",value:function(e){var t;if(this.label.enabled)if(this.label.format)_mmvis._.isFunction(this.label.format)&&(t=this.label.format(e.label,e));else{var i=this.label.field||this.groupField;t=i?e.rowData[i]+"："+e.percentage+"%":e.percentage+"%"}return t}},{key:"getList",value:function(){return this.data}},{key:"getLegendData",value:function(){var t=[];return _mmvis._.each(this.data,function(e){t.push({name:e.label,color:e.fillStyle,enabled:e.enabled})}),t}},{key:"tipsPointerOf",value:function(){}},{key:"tipsPointerHideOf",value:function(){}},{key:"focusAt",value:function(e){var t=this._pie.data.list[e];this.node.focus.enabled&&this._pie.focusOf(t)}},{key:"unfocusAt",value:function(e){var t=this._pie.data.list[e];t.node.focus.enabled&&this._pie.unfocusOf(t)}},{key:"selectAt",value:function(e){var t=this._pie.data.list[e];this.node.select.enabled&&this._pie.selectOf(t)}},{key:"unselectAt",value:function(e){var t=this._pie.data.list[e];this.node.select.enabled&&this._pie.unselectOf(t)}}]),a}(_index.default);_mmvis.global.registerComponent(PieGraphs,"graphs","pie");var _default=PieGraphs;exports.default=_default;