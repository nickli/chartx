"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_canvax=_interopRequireDefault(require("canvax")),_index=_interopRequireDefault(require("../index")),_mmvis=require("mmvis"),Progress=function(e){function i(e,t){var l;return(0,_classCallCheck2.default)(this,i),(l=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(i).call(this,e,t))).type="progress",_mmvis._.extend(!0,(0,_assertThisInitialized2.default)(l),(0,_mmvis.getDefaultProps)(i.defaultProps()),e),l.bgNodeData=null,l.init(),l}return(0,_inherits2.default)(i,e),(0,_createClass2.default)(i,null,[{key:"defaultProps",value:function(){return{node:{detail:"进度条设置",propertys:{width:{detail:"进度条的宽度",default:20},radius:{detail:"进度条两端的圆角半径",default:10},fillStyle:{detail:"进度条的填充色",documentation:"可以是单个颜色，也可以是数组，也可以是一个函数,也可以是个lineargradient",default:null}}},label:{detail:"进度值文本",propertys:{enabled:{detail:"是否启用label",default:"true"},unit:{detail:"单位值，默认%",default:"%"},unitColor:{detail:"单位值的颜色",default:null},unitFontSize:{detail:"单位值的大小",default:14},fontColor:{detail:"label颜色",default:null},fontSize:{detail:"label文本大小",default:26},fixNum:{detail:"toFixed的位数",default:2},format:{detail:"label格式化处理函数",default:function(e){return e.toFixed(this.label.fixNum)}},lineWidth:{detail:"label文本描边线宽",default:null},strokeStyle:{detail:"label描边颜色",default:null},rotation:{detail:"label旋转角度",default:0},textAlign:{detail:"label textAlign",default:"center",values:["left","center","right"]},verticalAlign:{detail:"label verticalAlign",default:"middle",values:["top","middle","bottom"]},position:{detail:"label位置",default:"origin"},offsetX:{detail:"label在x方向的偏移量",default:0},offsetY:{detail:"label在y方向的偏移量",default:0}}},bgEnabled:{detail:"是否开启背景",default:!0},bgColor:{detail:"进度条背景颜色",default:"#f7f7f7"},radius:{detail:"半径",default:null},allAngle:{detail:"总角度",documentation:"默认为null，则和坐标系同步",default:null},startAngle:{detail:"其实角度",documentation:"默认为null，则和坐标系同步",default:null}}}}]),(0,_createClass2.default)(i,[{key:"init",value:function(){}},{key:"draw",value:function(e){e=e||{};var t=this;_mmvis._.extend(!0,this,e),t.grow(function(e){t.data=t._trimGraphs(e),t._widget()}),this.sprite.context.x=this.origin.x,this.sprite.context.y=this.origin.y}},{key:"_trimGraphs",value:function(o){var s=this;null==o&&(o=1);var e=this.app.getComponent({name:"coord"});this.enabledField=e.filterEnabledFields(this.field);var u=s.startAngle||e.startAngle,f=s.allAngle||e.allAngle;startAngle,allAngle;this.bgNodeData=this._getNodeData(u,f),this.bgNodeData.fillStyle=this._getStyle(this.bgNodeData,this.bgColor);var t={};return _mmvis._.each(this.enabledField,function(r){var e=s.dataFrame.getFieldData(r),d=[];_mmvis._.each(e,function(e,t){e*=o;var l=d.slice(-1)[0],i=l?l.endAngle:u,a=f*(e/100),n=s._getNodeData(i,a,r,e,t);n.fillStyle=s._getStyle(n,s.node.fillStyle),d.push(n)}),t[r]=d}),t}},{key:"_getNodeData",value:function(e,t,l,i,a){var n=this,r=this.app.getComponent({name:"coord"}),d=e+t/2,o=e+t,s=Math.PI*e/180,u=Math.PI*d/180,f=Math.PI*o/180,_=n.radius||r.radius,g=_-n.node.width,h={field:l,value:i,text:i,iNode:a,allAngle:t,startAngle:e,middleAngle:d,endAngle:o,startRadian:s,middleRadian:u,endRadian:f,outRadius:_,innerRadius:g,startOutPoint:r.getPointInRadianOfR(s,_),middleOutPoint:r.getPointInRadianOfR(u,_),endOutPoint:r.getPointInRadianOfR(f,_),startInnerPoint:r.getPointInRadianOfR(s,g),middleInnerPoint:r.getPointInRadianOfR(u,g),endInnerPoint:r.getPointInRadianOfR(f,g),rowData:n.dataFrame.getRowDataAt(a),fillStyle:null};return l&&n.label.format&&_mmvis._.isFunction(n.label.format)&&(h.text=n.label.format.apply(this,[i,h])),h}},{key:"_widget",value:function(){var h=this;if(h.bgEnabled){var e=h._getPathStr(this.bgNodeData);h._bgPathElement?h._bgPathElement.context.path=e:(h._bgPathElement=new _canvax.default.Shapes.Path({context:{path:e}}),h.sprite.addChild(h._bgPathElement)),h._bgPathElement.context.fillStyle=this.bgNodeData.fillStyle}_mmvis._.each(this.data,function(e){_mmvis._.each(e,function(e,t){var l=h._getPathStr(e),i="progress_bar_"+e.field+"_"+t,a=h.sprite.getChildById(i);if(a?a.context.path=l:(a=new _canvax.default.Shapes.Path({id:i,context:{path:l}}),h.sprite.addChild(a)),a.context.fillStyle=e.fillStyle,h.label.enabled){var n="progress_label_"+e.field+"_sprite_"+t,r=h.sprite.getChildById(n);r||(r=new _canvax.default.Display.Sprite({id:n}),h.sprite.addChild(r)),r.context.x=h.label.offsetX-6,r.context.y=h.label.offsetY;var d={fillStyle:h.label.fontColor||e.fillStyle,fontSize:h.label.fontSize,lineWidth:h.label.lineWidth,strokeStyle:h.label.strokeStyle,textAlign:h.label.textAlign,textBaseline:h.label.verticalAlign,rotation:h.label.rotation},o="progress_label_"+e.field+"_"+t;if(s=r.getChildById(o))s.resetText(e.text),_mmvis._.extend(s.context,d);else{var s=new _canvax.default.Display.Text(e.text,{id:o,context:d});r.addChild(s)}var u="progress_label_"+e.field+"_symbol_"+t,f=r.getChildById(u),_={x:s.getTextWidth()/2+2,y:3,fillStyle:h.label.unitColor||h.label.fontColor||e.fillStyle,fontSize:h.label.unitFontSize,textAlign:"left",textBaseline:h.label.verticalAlign};if(f)_mmvis._.extend(f.context,_);else{var g=h.label.unit;f=new _canvax.default.Display.Text(g,{id:u,context:_});r.addChild(f)}}})})}},{key:"_getPathStr",value:function(e){var t="M"+e.startOutPoint.x+" "+e.startOutPoint.y;t+="A"+e.outRadius+" "+e.outRadius+" 0 0 1 "+e.middleOutPoint.x+" "+e.middleOutPoint.y,t+="A"+e.outRadius+" "+e.outRadius+" 0 0 1 "+e.endOutPoint.x+" "+e.endOutPoint.y;return e.allAngle,t+="L"+e.endInnerPoint.x+" "+e.endInnerPoint.y,t+="A"+e.innerRadius+" "+e.innerRadius+" 0 0 0 "+e.middleInnerPoint.x+" "+e.middleInnerPoint.y,t+="A"+e.innerRadius+" "+e.innerRadius+" 0 0 0 "+e.startInnerPoint.x+" "+e.startInnerPoint.y,t+="Z"}},{key:"_getStyle",value:function(e,t,l){var i=this.app.getComponent({name:"coord"}).getFieldMapOf(e.field);if(l=l||(i?i.color:"#171717"),t&&(_mmvis._.isString(t)&&(a=t),_mmvis._.isArray(t)&&(a=t[e.iNode]),_mmvis._.isFunction(t)&&(a=t.apply(this,arguments)),t&&t.lineargradient)){var a=this.ctx.createLinearGradient(e.startOutPoint.x,e.startOutPoint.y,e.endOutPoint.x,e.endOutPoint.y);_mmvis._.each(t.lineargradient,function(e,t){a.addColorStop(e.position,e.color)})}return a=a||l}}]),i}(_index.default);_mmvis.global.registerComponent(Progress,"graphs","progress");var _default2=Progress;exports.default=_default2;