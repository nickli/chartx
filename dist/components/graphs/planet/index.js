"use strict";!function(e,t){if("function"==typeof define&&define.amd)define(["exports","canvax","../index","./group","mmvis"],t);else if("undefined"!=typeof exports)t(exports,require("canvax"),require("../index"),require("./group"),require("mmvis"));else{var n={};t(n,e.canvax,e.index,e.group,e.mmvis),e.undefined=n}}(void 0,function(e,t,n,i,s){Object.defineProperty(e,"__esModule",{value:!0});var d=r(t),a=r(n),c=r(i);function r(e){return e&&e.__esModule?e:{default:e}}function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function f(e,t,n){return t&&p(e.prototype,t),n&&p(e,n),e}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var g=d.default.Display.Text,_=d.default.Shapes.Circle,y=d.default.Shapes.Line,x=d.default.Shapes.Rect,v=d.default.Shapes.Sector,S=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}(m,a.default),f(m,null,[{key:"defaultProps",value:function(){return{field:{detail:"字段设置",default:null},center:{detail:"中心点设置",propertys:{enabled:{detail:"是否显示中心",default:!0},text:{detail:"中心区域文本",default:"center"},radius:{detail:"中心圆半径",default:30},fillStyle:{detail:"中心背景色",default:"#70629e"},fontSize:{detail:"中心字体大小",default:15},fontColor:{detail:"中心字体颜色",default:"#ffffff"},margin:{detail:"中区区域和外围可绘图区域距离",default:20},cursor:{detail:"中心节点的鼠标手势",default:"default"}}},selectInds:{detail:"选中的数据索引",default:[]},grid:{detail:"星系图自己的grid",propertys:{rings:{detail:"环配置",propertys:{fillStyle:{detail:"背景色",default:null},strokeStyle:{detail:"环线色",default:null},lineWidth:{detail:"环线宽",default:1},count:{detail:"分几环",default:3}}},rays:{detail:"射线配置",propertys:{count:{detail:"射线数量",default:0},globalAlpha:{detail:"线透明度",default:.4},strokeStyle:{detail:"线色",default:"#10519D"},lineWidth:{detail:"线宽",default:1}}}}},bewrite:{detail:"planet的趋势描述",propertys:{enabled:{detail:"是否开启趋势描述",default:!1},text:{detail:"描述文本",default:null},fontColor:{detail:"fontColor",default:"#999"},fontSize:{detail:"fontSize",default:12}}},scan:{detail:"扫描效果",propertys:{enabled:{detail:"是否开启扫描效果",default:!1},fillStyle:{detail:"扫描效果颜色",default:null},alpha:{detail:"起始透明度",default:.6},angle:{detail:"扫描效果的覆盖角度",default:90},r:{detail:"扫描效果覆盖的半径",default:null},repeat:{detail:"扫描次数",default:3}}},_props:[c.default]}}}]),f(m,[{key:"init",value:function(){this.gridSp=new d.default.Display.Sprite({id:"gridSp"}),this.groupSp=new d.default.Display.Sprite({id:"groupSp"}),this.scanSp=new d.default.Display.Sprite({id:"scanSp"}),this.centerSp=new d.default.Display.Sprite({id:"centerSp"}),this.sprite.addChild(this.gridSp),this.sprite.addChild(this.groupSp),this.sprite.addChild(this.scanSp),this.sprite.addChild(this.centerSp)}},{key:"draw",value:function(e){e=e||{},s._.extend(!0,this,e),this._dataGroupHandle(),this._drawGroups(),this._drawBack(),this._drawBewrite(),this._drawCenter(),this._drawScan(),this.fire("complete")}},{key:"_getMaxR",value:function(){var e;try{e=this.graphs.group.circle.maxRadius}catch(e){}return null==e&&(e=30),e}},{key:"_drawGroups",value:function(){var a=this,r=this.center.radius+this.center.margin,o=a.app.getComponent({name:"coord"}).getMaxDisToViewOfOrigin()-a.center.radius-a.center.margin,l=this._getMaxR();s._.each(this.groupDataFrames,function(e,t){var n=r+o*(e.length/a.dataFrame.length),i=new c.default(s._.extend(!0,{iGroup:t,groupLen:a.groupDataFrames.length,rRange:{start:r,to:n},width:a.width-2*l,height:a.height-2*l,selectInds:a.selectInds},a._opt),e,a);r=i.rRange.to,a._ringGroups.push(i),a.grid.rings._section.push({radius:i.rRange.to})}),s._.each(a._ringGroups,function(e){a.sprite.addChild(e.sprite)})}},{key:"_drawCenter",value:function(){var t=this;this.center.enabled&&(this._center=new _({hoverClone:!1,context:{x:this.origin.x,y:this.origin.y,fillStyle:this.center.fillStyle,r:this.center.radius,cursor:this.center.cursor}}),this._centerTxt=new g(this.center.text,{context:{x:this.origin.x,y:this.origin.y,fontSize:this.center.fontSize,textAlign:"center",textBaseline:"middle",fillStyle:this.center.fontColor}}),this._center.on(s.event.types.get(),function(e){e.eventInfo={title:t.center.text,trigger:t.center,nodes:[t.center]},t.center.onclick&&("mousedown"==e.type&&(t._center.context.r+=2),"mouseup"==e.type&&(t._center.context.r-=2)),t.app.fire(e.type,e)}),this.centerSp.addChild(this._center),this.centerSp.addChild(this._centerTxt))}},{key:"_drawBack",value:function(){var e=this,t=this.app.getComponent({name:"coord"});if(1==e.grid.rings._section.length){var n=(e.grid.rings._section[0].radius-e.center.radius)/e.grid.rings.count;e.grid.rings._section=[];for(var i=0;i<e.grid.rings.count;i++)e.grid.rings._section.push({radius:e.center.radius+n*(i+1)})}else e.grid.rings.count=e.grid.rings._section.length;for(i=e.grid.rings._section.length-1;0<=i;i--){var a=e.grid.rings._section[i];e.gridSp.addChild(new _({context:{x:t.origin.x,y:t.origin.y,r:a.radius,lineWidth:e._getBackProp(e.grid.rings.lineWidth,i),strokeStyle:e._getBackProp(e.grid.rings.strokeStyle,i),fillStyle:e._getBackProp(e.grid.rings.fillStyle,i)}}))}if(1<e.grid.rays.count){var r=t.origin.x,o=t.origin.y,l=360/e.grid.rays.count,s=t.getMaxDisToViewOfOrigin();e.grid.rings._section.length&&(s=e.grid.rings._section.slice(-1)[0].radius),i=0;for(var d=e.grid.rays.count;i<d;i++){var c=l*i/180*Math.PI,u=r+s*Math.cos(c),p=o+s*Math.sin(c);e.gridSp.addChild(new y({context:{start:{x:r,y:o},end:{x:u,y:p},lineWidth:e._getBackProp(e.grid.rays.lineWidth,i),strokeStyle:e._getBackProp(e.grid.rays.strokeStyle,i),globalAlpha:e.grid.rays.globalAlpha}}))}}var f=new x({name:"clipRect",context:{x:t.origin.x-e.app.width/2,y:t.origin.y-e.height/2,width:e.app.width,height:e.height}});e.gridSp.clipTo(f),e.sprite.addChild(f)}},{key:"_getBackProp",value:function(e,t){var n=null;return s._.isFunction(e)&&(n=e.apply(this,[{scaleInd:t,count:this.grid.rings._section.length,groups:this._ringGroups,graphs:this}])),(s._.isString(e)||s._.isNumber(e))&&(n=e),s._.isArray(e)&&(n=e[t]),n}},{key:"_drawBewrite",value:function(){var a=this;if(a.bewrite.enabled){var e,r,t,n,i=function(e,t,n,i){n.context.x=e*a.center.radius+20*e,o.addChild(n),o.addChild(new y({context:{lineType:"dashed",start:{x:n.context.x,y:0},end:{x:e*(t?l/2-r/2:l),y:0},lineWidth:1,strokeStyle:"#ccc"}})),t&&(t.context.x=e*(l/2),o.addChild(t),o.addChild(new y({context:{lineType:"dashed",start:{x:e*(l/2+r/2),y:0},end:{x:e*l,y:0},lineWidth:1,strokeStyle:"#ccc"}}))),i.context.x=e*l,o.addChild(i)};a.bewrite.text&&(e=new d.default.Display.Text(a.bewrite.text,{context:{fillStyle:a.bewrite.fontColor,fontSize:a.bewrite.fontSize,textBaseline:"middle",textAlign:"center"}}),r=e.getTextWidth()),t=new d.default.Display.Text("强",{context:{fillStyle:a.bewrite.fontColor,fontSize:a.bewrite.fontSize,textBaseline:"middle",textAlign:"center"}}),n=new d.default.Display.Text("弱",{context:{fillStyle:a.bewrite.fontColor,fontSize:a.bewrite.fontSize,textBaseline:"middle",textAlign:"center"}});var o=new d.default.Display.Sprite({context:{x:this.origin.x,y:this.origin.y}});a.sprite.addChild(o);var l=a.width/2;i(1,e.clone(),t.clone(),n.clone()),i(-1,e.clone(),t.clone(),n.clone())}}},{key:"scan",value:function(){var t=this;this._scanAnim&&this._scanAnim.stop();var e=t._getScanSp();360==t.__scanIngCurOration&&(e.context.rotation=0),t._scanAnim=e.animate({rotation:360,globalAlpha:1},{duration:(360-t.__scanIngCurOration)/360*1e3,onUpdate:function(e){t.__scanIngCurOration=e.rotation},onComplete:function(){e.context.rotation=0,t._scanAnim=e.animate({rotation:360},{duration:1e3,repeat:1e3,onUpdate:function(e){t.__scanIngCurOration=e.rotation}})}})}},{key:"_drawScan",value:function(e){var t=this;if(t.scan.enabled){var n=t._getScanSp();360==t.__scanIngCurOration&&(n.context.rotation=0),t._scanAnim&&t._scanAnim.stop(),t._scanAnim=n.animate({rotation:360,globalAlpha:1},{duration:(360-t.__scanIngCurOration)/360*1e3,onUpdate:function(e){t.__scanIngCurOration=e.rotation},onComplete:function(){n.context.rotation=0,t._scanAnim=n.animate({rotation:360},{duration:1e3,repeat:t.scan.repeat-2,onUpdate:function(e){t.__scanIngCurOration=e.rotation},onComplete:function(){n.context.rotation=0,t._scanAnim=n.animate({rotation:360,globalAlpha:0},{duration:1e3,onUpdate:function(e){t.__scanIngCurOration=e.rotation},onComplete:function(){n.destroy(),t.__scanSp=null,delete t.__scanSp,t.__scanIngCurOration=0,e&&e()}})}})}})}}},{key:"_getScanSp",value:function(){var e=this,t=e.__scanSp;if(!t){t=new d.default.Display.Sprite({context:{x:this.origin.x,y:this.origin.y,globalAlpha:0,rotation:e.__scanIngCurOration}}),e.scanSp.addChild(t),e.__scanSp=t;for(var n=e.scan.r||e.height/2-10,i=e.scan.fillStyle||e.center.fillStyle,a=e.scan.angle,r=0,o=a;r<o;r++){var l=new v({context:{r:n,fillStyle:i,clockwise:!0,startAngle:360-r,endAngle:359-r,globalAlpha:e.scan.alpha-e.scan.alpha/a*r}});t.addChild(l)}var s=new y({context:{end:{x:n,y:0},lineWidth:1,strokeStyle:i}});t.addChild(s)}return t}},{key:"_dataGroupHandle",value:function(){var n=s._.indexOf(this.dataFrame.fields,this.groupField);if(0<=n){var i=this.dataFrame.org[0],a={};for(var e in s._.each(this.dataFrame.org,function(e,t){t&&(a[e[n]]||(a[e[n]]=[s._.clone(i)]),a[e[n]].push(e))}),a)this.groupDataFrames.push((0,s.dataFrame)(a[e]))}else this.groupDataFrames.push(this.dataFrame)}},{key:"show",value:function(e,t){this.getAgreeNodeData(t,function(e){e.nodeElement&&(e.nodeElement.context.visible=!0),e.labelElement&&(e.labelElement.context.visible=!0)})}},{key:"hide",value:function(e,t){this.getAgreeNodeData(t,function(e){e.nodeElement&&(e.nodeElement.context.visible=!1),e.labelElement&&(e.labelElement.context.visible=!1)})}},{key:"getAgreeNodeData",value:function(i,a){s._.each(this._ringGroups,function(e){s._.each(e._rings,function(e,t){s._.each(e.planets,function(e,t){var n=e.rowData;i.params.name==n[i.params.field]&&a&&a(e)})})})}},{key:"getLayoutNodes",value:function(){var t=[];return s._.each(this._ringGroups,function(e){s._.each(e.planets,function(e){e.pit&&t.push(e)})}),t}},{key:"getInvalidNodes",value:function(){var t=[];return s._.each(this._ringGroups,function(e){s._.each(e.planets,function(e){e.pit||t.push(e)})}),t}},{key:"selectAt",value:function(t){s._.each(this._ringGroups,function(e){e.selectAt(t)})}},{key:"selectAll",value:function(){var t=this;s._.each(t.dataFrame.getFieldData("__index__"),function(e){t.selectAt(e)})}},{key:"unselectAt",value:function(t){s._.each(this._ringGroups,function(e){e.unselectAt(t)})}},{key:"unselectAll",value:function(){var t=this;s._.each(t.dataFrame.getFieldData("__index__"),function(e){t.unselectAt(e)})}},{key:"getSelectedNodes",value:function(){var t=[];return s._.each(this._ringGroups,function(e){t=t.concat(e.getSelectedNodes())}),t}},{key:"getSelectedRowList",value:function(){var n=[];return s._.each(this._ringGroups,function(e){var t=[];s._.each(e.getSelectedNodes(),function(e){t.push(e.rowData)}),n=n.concat(t)}),n}},{key:"getNodesAt",value:function(){}},{key:"resetData",value:function(e){this.clean(),this.dataFrame=e,this._dataGroupHandle(),this._drawGroups(),this._drawScan()}},{key:"clean",value:function(){this.groupDataFrames=[],s._.each(this._ringGroups,function(e){e.sprite.destroy()}),this._ringGroups=[]}}]),m);function m(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,m),(n=function(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?u(e):t}(this,l(m).call(this,e,t))).type="planet",n.groupDataFrames=[],n.groupField=null,n._ringGroups=[],n.grid={rings:{_section:[]}},s._.extend(!0,u(n),(0,s.getDefaultProps)(m.defaultProps()),e),0!=n.center.radius&&n.center.enabled||(n.center.radius=0,n.center.margin=0,n.center.enabled=!1),n.__scanIngCurOration=0,n.init(),n}s.global.registerComponent(S,"graphs","planet"),e.default=S});