"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_canvax=_interopRequireDefault(require("canvax")),_index=_interopRequireDefault(require("../index")),_group=_interopRequireDefault(require("./group")),_mmvis=require("mmvis"),Text=_canvax.default.Display.Text,Circle=_canvax.default.Shapes.Circle,Line=_canvax.default.Shapes.Line,Rect=_canvax.default.Shapes.Rect,Sector=_canvax.default.Shapes.Sector,PlanetGraphs=function(e){function n(e,t){var i;return(0,_classCallCheck2.default)(this,n),(i=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(n).call(this,e,t))).type="planet",i.groupDataFrames=[],i.groupField=null,i._ringGroups=[],i.grid={rings:{_section:[]}},_mmvis._.extend(!0,(0,_assertThisInitialized2.default)(i),(0,_mmvis.getDefaultProps)(n.defaultProps()),e),0!=i.center.radius&&i.center.enabled||(i.center.radius=0,i.center.margin=0,i.center.enabled=!1),i.__scanIngCurOration=0,i.init(),i}return(0,_inherits2.default)(n,e),(0,_createClass2.default)(n,null,[{key:"defaultProps",value:function(){return{field:{detail:"字段设置",default:null},center:{detail:"中心点设置",propertys:{enabled:{detail:"是否显示中心",default:!0},text:{detail:"中心区域文本",default:"center"},radius:{detail:"中心圆半径",default:30},fillStyle:{detail:"中心背景色",default:"#70629e"},fontSize:{detail:"中心字体大小",default:15},fontColor:{detail:"中心字体颜色",default:"#ffffff"},margin:{detail:"中区区域和外围可绘图区域距离",default:20},cursor:{detail:"中心节点的鼠标手势",default:"default"}}},selectInds:{detail:"选中的数据索引",default:[]},grid:{detail:"星系图自己的grid",propertys:{rings:{detail:"环配置",propertys:{fillStyle:{detail:"背景色",default:null},strokeStyle:{detail:"环线色",default:null},lineWidth:{detail:"环线宽",default:1},count:{detail:"分几环",default:3}}},rays:{detail:"射线配置",propertys:{count:{detail:"射线数量",default:0},globalAlpha:{detail:"线透明度",default:.4},strokeStyle:{detail:"线色",default:"#10519D"},lineWidth:{detail:"线宽",default:1}}}}},bewrite:{detail:"planet的趋势描述",propertys:{enabled:{detail:"是否开启趋势描述",default:!1},text:{detail:"描述文本",default:null},fontColor:{detail:"fontColor",default:"#999"},fontSize:{detail:"fontSize",default:12}}},scan:{detail:"扫描效果",propertys:{enabled:{detail:"是否开启扫描效果",default:!1},fillStyle:{detail:"扫描效果颜色",default:null},alpha:{detail:"起始透明度",default:.6},angle:{detail:"扫描效果的覆盖角度",default:90},r:{detail:"扫描效果覆盖的半径",default:null},repeat:{detail:"扫描次数",default:3}}},_props:[_group.default]}}}]),(0,_createClass2.default)(n,[{key:"init",value:function(){this.gridSp=new _canvax.default.Display.Sprite({id:"gridSp"}),this.groupSp=new _canvax.default.Display.Sprite({id:"groupSp"}),this.scanSp=new _canvax.default.Display.Sprite({id:"scanSp"}),this.centerSp=new _canvax.default.Display.Sprite({id:"centerSp"}),this.sprite.addChild(this.gridSp),this.sprite.addChild(this.groupSp),this.sprite.addChild(this.scanSp),this.sprite.addChild(this.centerSp)}},{key:"draw",value:function(e){e=e||{},_mmvis._.extend(!0,this,e),this._dataGroupHandle(),this._drawGroups(),this._drawBack(),this._drawBewrite(),this._drawCenter(),this._drawScan(),this.fire("complete")}},{key:"_getMaxR",value:function(){var e;try{e=this.graphs.group.circle.maxRadius}catch(e){}return null==e&&(e=30),e}},{key:"_drawGroups",value:function(){var a=this,r=this.center.radius+this.center.margin,l=a.app.getComponent({name:"coord"}).getMaxDisToViewOfOrigin()-a.center.radius-a.center.margin,s=this._getMaxR();_mmvis._.each(this.groupDataFrames,function(e,t){var i=r+l*(e.length/a.dataFrame.length),n=new _group.default(_mmvis._.extend(!0,{iGroup:t,groupLen:a.groupDataFrames.length,rRange:{start:r,to:i},width:a.width-2*s,height:a.height-2*s,selectInds:a.selectInds},a._opt),e,a);r=n.rRange.to,a._ringGroups.push(n),a.grid.rings._section.push({radius:n.rRange.to})}),_mmvis._.each(a._ringGroups,function(e){a.sprite.addChild(e.sprite)})}},{key:"_drawCenter",value:function(){var t=this;this.center.enabled&&(this._center=new Circle({hoverClone:!1,context:{x:this.origin.x,y:this.origin.y,fillStyle:this.center.fillStyle,r:this.center.radius,cursor:this.center.cursor}}),this._centerTxt=new Text(this.center.text,{context:{x:this.origin.x,y:this.origin.y,fontSize:this.center.fontSize,textAlign:"center",textBaseline:"middle",fillStyle:this.center.fontColor}}),this._center.on(_mmvis.event.types.get(),function(e){e.eventInfo={title:t.center.text,trigger:t.center,nodes:[t.center]},t.center.onclick&&("mousedown"==e.type&&(t._center.context.r+=2),"mouseup"==e.type&&(t._center.context.r-=2)),t.app.fire(e.type,e)}),this.centerSp.addChild(this._center),this.centerSp.addChild(this._centerTxt))}},{key:"_drawBack",value:function(){var e=this,t=this.app.getComponent({name:"coord"});if(1==e.grid.rings._section.length){var i=(e.grid.rings._section[0].radius-e.center.radius)/e.grid.rings.count;e.grid.rings._section=[];for(var n=0;n<e.grid.rings.count;n++)e.grid.rings._section.push({radius:e.center.radius+i*(n+1)})}else e.grid.rings.count=e.grid.rings._section.length;for(n=e.grid.rings._section.length-1;0<=n;n--){var a=e.grid.rings._section[n];e.gridSp.addChild(new Circle({context:{x:t.origin.x,y:t.origin.y,r:a.radius,lineWidth:e._getBackProp(e.grid.rings.lineWidth,n),strokeStyle:e._getBackProp(e.grid.rings.strokeStyle,n),fillStyle:e._getBackProp(e.grid.rings.fillStyle,n)}}))}if(1<e.grid.rays.count){var r=t.origin.x,l=t.origin.y,s=360/e.grid.rays.count,o=t.getMaxDisToViewOfOrigin();e.grid.rings._section.length&&(o=e.grid.rings._section.slice(-1)[0].radius);n=0;for(var d=e.grid.rays.count;n<d;n++){var c=s*n/180*Math.PI,u=r+o*Math.cos(c),p=l+o*Math.sin(c);e.gridSp.addChild(new Line({context:{start:{x:r,y:l},end:{x:u,y:p},lineWidth:e._getBackProp(e.grid.rays.lineWidth,n),strokeStyle:e._getBackProp(e.grid.rays.strokeStyle,n),globalAlpha:e.grid.rays.globalAlpha}}))}}var h=new Rect({name:"clipRect",context:{x:t.origin.x-e.app.width/2,y:t.origin.y-e.height/2,width:e.app.width,height:e.height}});e.gridSp.clipTo(h),e.sprite.addChild(h)}},{key:"_getBackProp",value:function(e,t){var i=null;return _mmvis._.isFunction(e)&&(i=e.apply(this,[{scaleInd:t,count:this.grid.rings._section.length,groups:this._ringGroups,graphs:this}])),(_mmvis._.isString(e)||_mmvis._.isNumber(e))&&(i=e),_mmvis._.isArray(e)&&(i=e[t]),i}},{key:"_drawBewrite",value:function(){var a=this;if(a.bewrite.enabled){var e,r,t,i,n=function(e,t,i,n){i.context.x=e*a.center.radius+20*e,l.addChild(i),l.addChild(new Line({context:{lineType:"dashed",start:{x:i.context.x,y:0},end:{x:e*(t?s/2-r/2:s),y:0},lineWidth:1,strokeStyle:"#ccc"}})),t&&(t.context.x=e*(s/2),l.addChild(t),l.addChild(new Line({context:{lineType:"dashed",start:{x:e*(s/2+r/2),y:0},end:{x:e*s,y:0},lineWidth:1,strokeStyle:"#ccc"}}))),n.context.x=e*s,l.addChild(n)};a.bewrite.text&&(e=new _canvax.default.Display.Text(a.bewrite.text,{context:{fillStyle:a.bewrite.fontColor,fontSize:a.bewrite.fontSize,textBaseline:"middle",textAlign:"center"}}),r=e.getTextWidth()),t=new _canvax.default.Display.Text("强",{context:{fillStyle:a.bewrite.fontColor,fontSize:a.bewrite.fontSize,textBaseline:"middle",textAlign:"center"}}),i=new _canvax.default.Display.Text("弱",{context:{fillStyle:a.bewrite.fontColor,fontSize:a.bewrite.fontSize,textBaseline:"middle",textAlign:"center"}});var l=new _canvax.default.Display.Sprite({context:{x:this.origin.x,y:this.origin.y}});a.sprite.addChild(l);var s=a.width/2;n(1,e.clone(),t.clone(),i.clone()),n(-1,e.clone(),t.clone(),i.clone())}}},{key:"scan",value:function(){var t=this;this._scanAnim&&this._scanAnim.stop();var e=t._getScanSp();360==t.__scanIngCurOration&&(e.context.rotation=0),t._scanAnim=e.animate({rotation:360,globalAlpha:1},{duration:(360-t.__scanIngCurOration)/360*1e3,onUpdate:function(e){t.__scanIngCurOration=e.rotation},onComplete:function(){e.context.rotation=0,t._scanAnim=e.animate({rotation:360},{duration:1e3,repeat:1e3,onUpdate:function(e){t.__scanIngCurOration=e.rotation}})}})}},{key:"_drawScan",value:function(e){var t=this;if(t.scan.enabled){var i=t._getScanSp();360==t.__scanIngCurOration&&(i.context.rotation=0),t._scanAnim&&t._scanAnim.stop(),t._scanAnim=i.animate({rotation:360,globalAlpha:1},{duration:(360-t.__scanIngCurOration)/360*1e3,onUpdate:function(e){t.__scanIngCurOration=e.rotation},onComplete:function(){i.context.rotation=0,t._scanAnim=i.animate({rotation:360},{duration:1e3,repeat:t.scan.repeat-2,onUpdate:function(e){t.__scanIngCurOration=e.rotation},onComplete:function(){i.context.rotation=0,t._scanAnim=i.animate({rotation:360,globalAlpha:0},{duration:1e3,onUpdate:function(e){t.__scanIngCurOration=e.rotation},onComplete:function(){i.destroy(),t.__scanSp=null,delete t.__scanSp,t.__scanIngCurOration=0,e&&e()}})}})}})}}},{key:"_getScanSp",value:function(){var e=this,t=e.__scanSp;if(!t){t=new _canvax.default.Display.Sprite({context:{x:this.origin.x,y:this.origin.y,globalAlpha:0,rotation:e.__scanIngCurOration}}),e.scanSp.addChild(t),e.__scanSp=t;for(var i=e.scan.r||e.height/2-10,n=e.scan.fillStyle||e.center.fillStyle,a=e.scan.angle,r=0,l=a;r<l;r++){var s=new Sector({context:{r:i,fillStyle:n,clockwise:!0,startAngle:360-r,endAngle:359-r,globalAlpha:e.scan.alpha-e.scan.alpha/a*r}});t.addChild(s)}var o=new Line({context:{end:{x:i,y:0},lineWidth:1,strokeStyle:n}});t.addChild(o)}return t}},{key:"_dataGroupHandle",value:function(){var i=_mmvis._.indexOf(this.dataFrame.fields,this.groupField);if(0<=i){var n=this.dataFrame.org[0],a={};for(var e in _mmvis._.each(this.dataFrame.org,function(e,t){t&&(a[e[i]]||(a[e[i]]=[_mmvis._.clone(n)]),a[e[i]].push(e))}),a)this.groupDataFrames.push((0,_mmvis.dataFrame)(a[e]))}else this.groupDataFrames.push(this.dataFrame)}},{key:"show",value:function(e,t){this.getAgreeNodeData(t,function(e){e.nodeElement&&(e.nodeElement.context.visible=!0),e.labelElement&&(e.labelElement.context.visible=!0)})}},{key:"hide",value:function(e,t){this.getAgreeNodeData(t,function(e){e.nodeElement&&(e.nodeElement.context.visible=!1),e.labelElement&&(e.labelElement.context.visible=!1)})}},{key:"getAgreeNodeData",value:function(n,a){_mmvis._.each(this._ringGroups,function(e){_mmvis._.each(e._rings,function(e,t){_mmvis._.each(e.planets,function(e,t){var i=e.rowData;n.params.name==i[n.params.field]&&a&&a(e)})})})}},{key:"getLayoutNodes",value:function(){var t=[];return _mmvis._.each(this._ringGroups,function(e){_mmvis._.each(e.planets,function(e){e.pit&&t.push(e)})}),t}},{key:"getInvalidNodes",value:function(){var t=[];return _mmvis._.each(this._ringGroups,function(e){_mmvis._.each(e.planets,function(e){e.pit||t.push(e)})}),t}},{key:"selectAt",value:function(t){_mmvis._.each(this._ringGroups,function(e){e.selectAt(t)})}},{key:"selectAll",value:function(){var t=this;_mmvis._.each(t.dataFrame.getFieldData("__index__"),function(e){t.selectAt(e)})}},{key:"unselectAt",value:function(t){_mmvis._.each(this._ringGroups,function(e){e.unselectAt(t)})}},{key:"unselectAll",value:function(){var t=this;_mmvis._.each(t.dataFrame.getFieldData("__index__"),function(e){t.unselectAt(e)})}},{key:"getSelectedNodes",value:function(){var t=[];return _mmvis._.each(this._ringGroups,function(e){t=t.concat(e.getSelectedNodes())}),t}},{key:"getSelectedRowList",value:function(){var i=[];return _mmvis._.each(this._ringGroups,function(e){var t=[];_mmvis._.each(e.getSelectedNodes(),function(e){t.push(e.rowData)}),i=i.concat(t)}),i}},{key:"getNodesAt",value:function(){}},{key:"resetData",value:function(e){this.clean(),this.dataFrame=e,this._dataGroupHandle(),this._drawGroups(),this._drawScan()}},{key:"clean",value:function(){this.groupDataFrames=[],_mmvis._.each(this._ringGroups,function(e){e.sprite.destroy()}),this._ringGroups=[]}}]),n}(_index.default);_mmvis.global.registerComponent(PlanetGraphs,"graphs","planet");var _default=PlanetGraphs;exports.default=_default;