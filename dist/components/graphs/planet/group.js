"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_canvax=_interopRequireDefault(require("canvax")),_mmvis=require("mmvis"),Circle=_canvax.default.Shapes.Circle,PlanetGroup=function(){function a(t,e,i){(0,_classCallCheck2.default)(this,a),this._opt=t,this.dataFrame=e,this._graphs=i,this.app=i.app,this.field=null,this.iGroup=0,this.groupLen=1,this.rRange={start:0,to:0},this.width=0,this.height=0,this.selectInds=[],this.layoutType="radian",this.pit={radius:30},this.planets=[],this.maxRingNum=0,this.ringNum=0,_mmvis._.extend(!0,this,(0,_mmvis.getDefaultProps)(a.defaultProps()),t),this.node.maxRadius>this.pit.radius&&(this.pit.radius=this.node.maxRadius),this.init()}return(0,_createClass2.default)(a,null,[{key:"defaultProps",value:function(){return{sort:{detail:"排序",default:"desc"},sortField:{detail:"用来排序的字段",default:"null"},node:{detail:"单个数据节点图形配置",propertys:{maxRadius:{detail:"最大半径",default:30},minRadius:{detail:"最小半径",default:5},radius:{detail:"半径",default:15,documentation:'也可以是个function,也可以配置{field:"pv"}来设置字段， 自动计算r'},lineWidth:{detail:"描边线宽",default:1},strokeStyle:{detail:"描边颜色",default:"#ffffff"},fillStyle:{detail:"图形填充色",default:"#f2fbfb"},strokeAlpha:{detail:"边框透明度",default:.6},focus:{detail:"hover态设置",propertys:{enabled:{detail:"是否开启",default:!0},strokeAlpha:{detail:"hover时候边框透明度",default:.7},lineWidth:{detail:"hover时候边框大小",default:2},strokeStyle:{detail:"hover时候边框颜色",default:"#fff"}}},select:{detail:"选中态设置",propertys:{enabled:{detail:"是否开启",default:!1},strokeAlpha:{detail:"选中时候边框透明度",default:1},lineWidth:{detail:"选中时候边框大小",default:2},strokeStyle:{detail:"选中时候边框颜色",default:"#fff"},triggerEventType:{detail:"触发事件",default:"click"}}}}},label:{detail:"文本设置",propertys:{enabled:{detail:"是否开启",default:!0},fontColor:{detail:"文本颜色",default:"#666666"},fontSize:{detail:"文本字体大小",default:13},textAlign:{detail:"水平对齐方式",default:"center"},verticalAlign:{detail:"基线对齐方式",default:"middle"},position:{detail:"文本布局位置",default:"center"},offsetX:{detail:"x方向偏移量",default:0},offsetY:{detail:"y方向偏移量",default:0}}}}}}]),(0,_createClass2.default)(a,[{key:"init",value:function(){var t=this.app.getComponent({name:"coord"});this.sprite=new _canvax.default.Display.Sprite({id:"group_"+this.iGroup,context:{x:t.origin.x,y:t.origin.y}}),this._trimGraphs(),this.draw()}},{key:"_trimGraphs",value:function(){var a=this,t=this.app.getComponent({name:"coord"}).getMaxDisToViewOfOrigin();(t-this.rRange.to)/(2*this.pit.radius)<this.groupLen-1-this.iGroup&&(this.rRange.to=t-(this.groupLen-1-this.iGroup)*this.pit.radius*2),this.rRange.to-this.rRange.start<2*this.pit.radius&&(this.rRange.to=this.rRange.start+2*this.pit.radius),this.maxRingNum||(this.maxRingNum=parseInt((this.rRange.to-this.rRange.start)/(2*this.pit.radius),10),this.ringNum=this.maxRingNum),this.rRange.to=this.rRange.start+this.ringNum*this.pit.radius*2;for(var e=[],i=this.dataFrame.length,n=0;n<i;n++){var l=this.dataFrame.getRowDataAt(n),s={type:"planet",groupLen:this.groupLen,iGroup:a.iGroup,iNode:n,nodeElement:null,labelElement:null,rowData:l,iRing:null,iPlanet:null,fillStyle:null,color:null,strokeStyle:null,pit:null,ringInd:-1,field:a.field,label:l[a.field],focused:!1,selected:!!~_mmvis._.indexOf(this.selectInds,l.__index__)};e.push(s)}a.sortField&&(e=e.sort(function(t,e){var i=a.sortField;return"desc"==a.sort?e.rowData[i]-t.rowData[i]:t.rowData[i]-e.rowData[i]}),_mmvis._.each(e,function(t,e){t.iNode=e})),this._rings=this["_setRings_"+this.layoutType+"Range"](e),this.planets=e}},{key:"_setRings_radianRange",value:function(i){for(var o=this,a=[],t=this.app.getComponent({name:"coord"}),e=0,n=this.ringNum;e<n;e++){var l=e*this.pit.radius*2+this.pit.radius+this.rRange.start;o._graphs.center.enabled||(l=e*this.pit.radius*2+this.rRange.start);var s=t.getRadiansAtR(l,o.width,o.height);Math.atan(this.pit.radius/l);a.push({arcs:s,pits:[],planets:[],radius:l,max:0})}var d=0;_mmvis._.each(a,function(l,t){var s=2*Math.asin(o.pit.radius/l.radius);0==l.radius&&(s=2*Math.PI);var r=0;_mmvis._.each(l.arcs,function(t){var e=o._getDiffRadian(t[0].radian,t[1].radian);if(s<=e){var i=parseInt(e/s,10);r+=i;for(var a=0;a<i;a++){var n={hasRadish:!1,start:(t[0].radian+s*a+2*Math.PI)%(2*Math.PI)};n.middle=(n.start+s/2+2*Math.PI)%(2*Math.PI),n.to=(n.start+s+2*Math.PI)%(2*Math.PI),l.pits.push(n)}}}),l.max=r,d+=r,l.pits=_mmvis._.shuffle(l.pits)});var r=0;return _mmvis._.each(a,function(n,t){if(r>=i.length)return!1;var e=Math.ceil(n.max/d*i.length);e=Math.min(n.max,e),n.planets=i.slice(r,r+e),t==a.length-1&&(n.planets=i.slice(r)),r+=e,_mmvis._.each(n.planets,function(t,e){if(!(e>=n.pits.length)){var i=_mmvis._.filter(n.pits,function(t){return!t.hasRadish}),a=i[parseInt(Math.random()*i.length)];a.hasRadish=!0,t.pit=a}})}),a}},{key:"_getDiffRadian",value:function(t,e){var i=e-t;return e<t&&(i=(e+2*Math.PI-t)%(2*Math.PI)),i}},{key:"_setRings_indexRange",value:function(){}},{key:"_setRings_valRange",value:function(){}},{key:"draw",value:function(){var M=this,D=this.app.getComponent({name:"coord"});_mmvis._.each(this._rings,function(b,k){var P={rotation:0};1==b.arcs.length&&0==b.arcs[0][0].radian&&b.arcs[0][1].radian==2*Math.PI&&(P.rotation=parseInt(360*Math.random()));var A=new _canvax.default.Display.Sprite({context:P});_mmvis._.each(b.planets,function(t,e){if(t.pit){var i=D.getPointInRadianOfR(t.pit.middle,b.radius),a=M._getRProp(M.node.radius,k,e,t),n=M.node.maxRadius-a,l=parseInt(Math.random()*n),s=parseInt(360*Math.random())*Math.PI/180;0!=l&&(i.x+=Math.sin(s)*l,i.y+=Math.cos(s)*l);var r=M.node;t.selected&&(r=M.node.select);var o=M._getProp(M.node.fillStyle,t),d=M._getProp(r.strokeStyle,t),h=M._getProp(r.strokeAlpha,t),u=M._getProp(r.lineWidth,t),p={x:i.x,y:i.y,r:a,fillStyle:o,lineWidth:u,strokeStyle:d,strokeAlpha:h,cursor:"pointer"};t.color=t.fillStyle=o,t.strokeStyle=d,t.iRing=k,t.iPlanet=e;var f=new Circle({hoverClone:!1,context:p});if(f.on(_mmvis.event.types.get(),function(t){t.eventInfo={title:null,trigger:M.node,nodes:[this.nodeData]},this.nodeData.label&&(t.eventInfo.title=this.nodeData.label),M.node.focus.enabled&&("mouseover"==t.type&&M.focusAt(this.nodeData),"mouseout"==t.type&&M.unfocusAt(this.nodeData)),M.node.select.enabled&&t.type==M.node.select.triggerEventType&&(this.nodeData.selected?M.unselectAt(this.nodeData):M.selectAt(this.nodeData)),M.app.fire(t.type,t)}),((f.nodeData=t).nodeElement=f).ringInd=k,f.planetIndInRing=e,A.addChild(f),M._graphs.animation){var c=f.context.r,m=f.context.globalAlpha;f.context.r=1,f.context.globalAlpha=.1,f.animate({r:c,globalAlpha:m},{delay:Math.round(1500*Math.random()),onComplete:function(){f.labelElement&&(f.labelElement.context.visible=!0);var t=f.clone();A.addChildAt(t,0),t.animate({r:c+10,globalAlpha:0},{onComplete:function(){t.destroy()}})}})}var _={x:i.x,y:i.y,fontSize:M.label.fontSize,textAlign:M.label.textAlign,textBaseline:M.label.verticalAlign,fillStyle:M.label.fontColor,rotation:-P.rotation,rotateOrigin:{x:0,y:0}},g=new _canvax.default.Display.Text(t.label,{context:_}),v=g.getTextWidth(),x=g.getTextHeight();if(2*a<v&&(_.fontSize=M.label.fontSize-3),_mmvis._.isFunction(M.label.position)){var y=M.label.position({node:f,circleR:a,circleCenter:{x:i.x,y:i.y},textWidth:v,textHeight:x});_.rotation=-P.rotation,_.rotateOrigin={x:-(y.x-_.x),y:-(y.y-_.y)},_.x=y.x,_.y=y.y}"auto"==M.label.position&&2*a<v&&R(),"bottom"==M.label.position&&R(),_.x+=M.label.offsetX,_.y+=M.label.offsetY,g=new _canvax.default.Display.Text(t.label,{context:_}),((f.labelElement=g).nodeData=t).labelElement=g,M._graphs.animation&&(g.context.visible=!1),A.addChild(g)}function R(){_.y=i.y+a+3,_.rotation=-P.rotation,_.rotateOrigin={x:0,y:-(a+.7*x)}}}),M.sprite.addChild(A)})}},{key:"_getRProp",value:function(e,t,i,a){var n=this;if(_mmvis._.isString(e)&&-1<_mmvis._.indexOf(n.dataFrame.fields,e)){null==this.__rValMax&&null==this.__rValMax&&(this.__rValMax=0,this.__rValMin=0,_mmvis._.each(n.planets,function(t){n.__rValMax=Math.max(n.__rValMax,t.rowData[e]),n.__rValMin=Math.min(n.__rValMin,t.rowData[e])}));var l=a.rowData[e];return n.node.minRadius+(l-this.__rValMin)/(this.__rValMax-this.__rValMin)*(n.node.maxRadius-n.node.minRadius)}return n._getProp(e,a)}},{key:"_getProp",value:function(t,e){var i=this.iGroup;return _mmvis._.isFunction(t)?t.apply(this,[e,i]):t}},{key:"getPlanetAt",value:function(e){var i=e;return _mmvis._.isNumber(e)&&_mmvis._.each(this.planets,function(t){if(t.rowData.__index__==e)return i=t,!1}),i}},{key:"selectAt",value:function(t){if(this.node.select.enabled){var e=this.getPlanetAt(t);e.selected=!0,e.nodeElement&&(e.nodeElement.context.lineWidth=this._getProp(this.node.select.lineWidth,e),e.nodeElement.context.strokeStyle=this._getProp(this.node.select.strokeStyle,e),e.nodeElement.context.strokeAlpha=this._getProp(this.node.select.strokeAlpha,e));for(var i=0;i<this.selectInds.length;i++)if(t===this.selectInds[i]){this.selectInds.splice(i--,1);break}}}},{key:"unselectAt",value:function(t){if(this.node.select.enabled){var e=this.getPlanetAt(t);e.selected=!1,e.nodeElement&&(e.nodeElement.context.lineWidth=this._getProp(this.node.lineWidth,e),e.nodeElement.context.strokeAlpha=this._getProp(this.node.strokeAlpha,e)),this.selectInds.push(t)}}},{key:"getSelectedNodes",value:function(){return _mmvis._.filter(this.planets,function(t){return t.selected})}},{key:"focusAt",value:function(t){if(this.node.focus.enabled){var e=this.getPlanetAt(t);e.selected||(e.focused=!0,e.nodeElement&&(e.nodeElement.context.lineWidth=this._getProp(this.node.focus.lineWidth,e),e.nodeElement.context.strokeStyle=this._getProp(this.node.focus.strokeStyle,e),e.nodeElement.context.strokeAlpha=this._getProp(this.node.focus.strokeAlpha,e)))}}},{key:"unfocusAt",value:function(t){if(this.node.focus.enabled){var e=this.getPlanetAt(t);e.selected||(e.focused=!1,e.nodeElement&&(e.nodeElement.context.lineWidth=this._getProp(this.node.lineWidth,e),e.nodeElement.context.strokeAlpha=this._getProp(this.node.strokeAlpha,e)))}}}]),a}();exports.default=PlanetGroup;