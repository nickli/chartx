"use strict";!function(t,e){if("function"==typeof define&&define.amd)define(["exports","canvax","mmvis"],e);else if("undefined"!=typeof exports)e(exports,require("canvax"),require("mmvis"));else{var i={};e(i,t.canvax,t.mmvis),t.undefined=i}}(void 0,function(t,e,D){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i,S=(i=e)&&i.__esModule?i:{default:i};function a(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function n(t,e,i){return e&&a(t.prototype,e),i&&a(t,i),t}var E=S.default.Shapes.Circle,l=(n(s,null,[{key:"defaultProps",value:function(){return{sort:{detail:"排序",default:"desc"},sortField:{detail:"用来排序的字段",default:"null"},node:{detail:"单个数据节点图形配置",propertys:{maxRadius:{detail:"最大半径",default:30},minRadius:{detail:"最小半径",default:5},radius:{detail:"半径",default:15,documentation:'也可以是个function,也可以配置{field:"pv"}来设置字段， 自动计算r'},lineWidth:{detail:"描边线宽",default:1},strokeStyle:{detail:"描边颜色",default:"#ffffff"},fillStyle:{detail:"图形填充色",default:"#f2fbfb"},strokeAlpha:{detail:"边框透明度",default:.6},focus:{detail:"hover态设置",propertys:{enabled:{detail:"是否开启",default:!0},strokeAlpha:{detail:"hover时候边框透明度",default:.7},lineWidth:{detail:"hover时候边框大小",default:2},strokeStyle:{detail:"hover时候边框颜色",default:"#fff"}}},select:{detail:"选中态设置",propertys:{enabled:{detail:"是否开启",default:!1},strokeAlpha:{detail:"选中时候边框透明度",default:1},lineWidth:{detail:"选中时候边框大小",default:2},strokeStyle:{detail:"选中时候边框颜色",default:"#fff"},triggerEventType:{detail:"触发事件",default:"click"}}}}},label:{detail:"文本设置",propertys:{enabled:{detail:"是否开启",default:!0},fontColor:{detail:"文本颜色",default:"#666666"},fontSize:{detail:"文本字体大小",default:13},textAlign:{detail:"水平对齐方式",default:"center"},verticalAlign:{detail:"基线对齐方式",default:"middle"},position:{detail:"文本布局位置",default:"center"},offsetX:{detail:"x方向偏移量",default:0},offsetY:{detail:"y方向偏移量",default:0}}}}}}]),n(s,[{key:"init",value:function(){var t=this.app.getComponent({name:"coord"});this.sprite=new S.default.Display.Sprite({id:"group_"+this.iGroup,context:{x:t.origin.x,y:t.origin.y}}),this._trimGraphs(),this.draw()}},{key:"_trimGraphs",value:function(){var a=this,t=this.app.getComponent({name:"coord"}).getMaxDisToViewOfOrigin();(t-this.rRange.to)/(2*this.pit.radius)<this.groupLen-1-this.iGroup&&(this.rRange.to=t-(this.groupLen-1-this.iGroup)*this.pit.radius*2),this.rRange.to-this.rRange.start<2*this.pit.radius&&(this.rRange.to=this.rRange.start+2*this.pit.radius),this.maxRingNum||(this.maxRingNum=parseInt((this.rRange.to-this.rRange.start)/(2*this.pit.radius),10),this.ringNum=this.maxRingNum),this.rRange.to=this.rRange.start+this.ringNum*this.pit.radius*2;for(var e=[],i=this.dataFrame.length,n=0;n<i;n++){var l=this.dataFrame.getRowDataAt(n),s={type:"planet",groupLen:this.groupLen,iGroup:a.iGroup,iNode:n,nodeElement:null,labelElement:null,rowData:l,iRing:null,iPlanet:null,fillStyle:null,color:null,strokeStyle:null,pit:null,ringInd:-1,field:a.field,label:l[a.field],focused:!1,selected:!!~D._.indexOf(this.selectInds,l.__index__)};e.push(s)}a.sortField&&(e=e.sort(function(t,e){var i=a.sortField;return"desc"==a.sort?e.rowData[i]-t.rowData[i]:t.rowData[i]-e.rowData[i]}),D._.each(e,function(t,e){t.iNode=e})),this._rings=this["_setRings_"+this.layoutType+"Range"](e),this.planets=e}},{key:"_setRings_radianRange",value:function(i){for(var r=this,a=[],t=this.app.getComponent({name:"coord"}),e=0,n=this.ringNum;e<n;e++){var l=e*this.pit.radius*2+this.pit.radius+this.rRange.start;r._graphs.center.enabled||(l=e*this.pit.radius*2+this.rRange.start);var s=t.getRadiansAtR(l,r.width,r.height);Math.atan(this.pit.radius/l),a.push({arcs:s,pits:[],planets:[],radius:l,max:0})}var d=0;D._.each(a,function(l,t){var s=2*Math.asin(r.pit.radius/l.radius);0==l.radius&&(s=2*Math.PI);var o=0;D._.each(l.arcs,function(t){var e=r._getDiffRadian(t[0].radian,t[1].radian);if(s<=e){var i=parseInt(e/s,10);o+=i;for(var a=0;a<i;a++){var n={hasRadish:!1,start:(t[0].radian+s*a+2*Math.PI)%(2*Math.PI)};n.middle=(n.start+s/2+2*Math.PI)%(2*Math.PI),n.to=(n.start+s+2*Math.PI)%(2*Math.PI),l.pits.push(n)}}}),l.max=o,d+=o,l.pits=D._.shuffle(l.pits)});var o=0;return D._.each(a,function(n,t){if(o>=i.length)return!1;var e=Math.ceil(n.max/d*i.length);e=Math.min(n.max,e),n.planets=i.slice(o,o+e),t==a.length-1&&(n.planets=i.slice(o)),o+=e,D._.each(n.planets,function(t,e){if(!(e>=n.pits.length)){var i=D._.filter(n.pits,function(t){return!t.hasRadish}),a=i[parseInt(Math.random()*i.length)];a.hasRadish=!0,t.pit=a}})}),a}},{key:"_getDiffRadian",value:function(t,e){var i=e-t;return e<t&&(i=(e+2*Math.PI-t)%(2*Math.PI)),i}},{key:"_setRings_indexRange",value:function(){}},{key:"_setRings_valRange",value:function(){}},{key:"draw",value:function(){var A=this,I=this.app.getComponent({name:"coord"});D._.each(this._rings,function(R,k){var P={rotation:0};1==R.arcs.length&&0==R.arcs[0][0].radian&&R.arcs[0][1].radian==2*Math.PI&&(P.rotation=parseInt(360*Math.random()));var M=new S.default.Display.Sprite({context:P});D._.each(R.planets,function(t,e){if(t.pit){var i=I.getPointInRadianOfR(t.pit.middle,R.radius),a=A._getRProp(A.node.radius,k,e,t),n=A.node.maxRadius-a,l=parseInt(Math.random()*n),s=parseInt(360*Math.random())*Math.PI/180;0!=l&&(i.x+=Math.sin(s)*l,i.y+=Math.cos(s)*l);var o=A.node;t.selected&&(o=A.node.select);var r=A._getProp(A.node.fillStyle,t),d=A._getProp(o.strokeStyle,t),h=A._getProp(o.strokeAlpha,t),u=A._getProp(o.lineWidth,t),f={x:i.x,y:i.y,r:a,fillStyle:r,lineWidth:u,strokeStyle:d,strokeAlpha:h,cursor:"pointer"};t.color=t.fillStyle=r,t.strokeStyle=d,t.iRing=k,t.iPlanet=e;var p=new E({hoverClone:!1,context:f});if(p.on(D.event.types.get(),function(t){t.eventInfo={title:null,trigger:A.node,nodes:[this.nodeData]},this.nodeData.label&&(t.eventInfo.title=this.nodeData.label),A.node.focus.enabled&&("mouseover"==t.type&&A.focusAt(this.nodeData),"mouseout"==t.type&&A.unfocusAt(this.nodeData)),A.node.select.enabled&&t.type==A.node.select.triggerEventType&&(this.nodeData.selected?A.unselectAt(this.nodeData):A.selectAt(this.nodeData)),A.app.fire(t.type,t)}),((p.nodeData=t).nodeElement=p).ringInd=k,p.planetIndInRing=e,M.addChild(p),A._graphs.animation){var c=p.context.r,g=p.context.globalAlpha;p.context.r=1,p.context.globalAlpha=.1,p.animate({r:c,globalAlpha:g},{delay:Math.round(1500*Math.random()),onComplete:function(){p.labelElement&&(p.labelElement.context.visible=!0);var t=p.clone();M.addChildAt(t,0),t.animate({r:c+10,globalAlpha:0},{onComplete:function(){t.destroy()}})}})}var _={x:i.x,y:i.y,fontSize:A.label.fontSize,textAlign:A.label.textAlign,textBaseline:A.label.verticalAlign,fillStyle:A.label.fontColor,rotation:-P.rotation,rotateOrigin:{x:0,y:0}},m=new S.default.Display.Text(t.label,{context:_}),v=m.getTextWidth(),y=m.getTextHeight();if(2*a<v&&(_.fontSize=A.label.fontSize-3),D._.isFunction(A.label.position)){var x=A.label.position({node:p,circleR:a,circleCenter:{x:i.x,y:i.y},textWidth:v,textHeight:y});_.rotation=-P.rotation,_.rotateOrigin={x:-(x.x-_.x),y:-(x.y-_.y)},_.x=x.x,_.y=x.y}"auto"==A.label.position&&2*a<v&&b(),"bottom"==A.label.position&&b(),_.x+=A.label.offsetX,_.y+=A.label.offsetY,m=new S.default.Display.Text(t.label,{context:_}),((p.labelElement=m).nodeData=t).labelElement=m,A._graphs.animation&&(m.context.visible=!1),M.addChild(m)}function b(){_.y=i.y+a+3,_.rotation=-P.rotation,_.rotateOrigin={x:0,y:-(a+.7*y)}}}),A.sprite.addChild(M)})}},{key:"_getRProp",value:function(e,t,i,a){var n=this;if(D._.isString(e)&&-1<D._.indexOf(n.dataFrame.fields,e)){null==this.__rValMax&&null==this.__rValMax&&(this.__rValMax=0,this.__rValMin=0,D._.each(n.planets,function(t){n.__rValMax=Math.max(n.__rValMax,t.rowData[e]),n.__rValMin=Math.min(n.__rValMin,t.rowData[e])}));var l=a.rowData[e];return n.node.minRadius+(l-this.__rValMin)/(this.__rValMax-this.__rValMin)*(n.node.maxRadius-n.node.minRadius)}return n._getProp(e,a)}},{key:"_getProp",value:function(t,e){var i=this.iGroup;return D._.isFunction(t)?t.apply(this,[e,i]):t}},{key:"getPlanetAt",value:function(e){var i=e;return D._.isNumber(e)&&D._.each(this.planets,function(t){if(t.rowData.__index__==e)return i=t,!1}),i}},{key:"selectAt",value:function(t){if(this.node.select.enabled){var e=this.getPlanetAt(t);e.selected=!0,e.nodeElement&&(e.nodeElement.context.lineWidth=this._getProp(this.node.select.lineWidth,e),e.nodeElement.context.strokeStyle=this._getProp(this.node.select.strokeStyle,e),e.nodeElement.context.strokeAlpha=this._getProp(this.node.select.strokeAlpha,e));for(var i=0;i<this.selectInds.length;i++)if(t===this.selectInds[i]){this.selectInds.splice(i--,1);break}}}},{key:"unselectAt",value:function(t){if(this.node.select.enabled){var e=this.getPlanetAt(t);e.selected=!1,e.nodeElement&&(e.nodeElement.context.lineWidth=this._getProp(this.node.lineWidth,e),e.nodeElement.context.strokeAlpha=this._getProp(this.node.strokeAlpha,e)),this.selectInds.push(t)}}},{key:"getSelectedNodes",value:function(){return D._.filter(this.planets,function(t){return t.selected})}},{key:"focusAt",value:function(t){if(this.node.focus.enabled){var e=this.getPlanetAt(t);e.selected||(e.focused=!0,e.nodeElement&&(e.nodeElement.context.lineWidth=this._getProp(this.node.focus.lineWidth,e),e.nodeElement.context.strokeStyle=this._getProp(this.node.focus.strokeStyle,e),e.nodeElement.context.strokeAlpha=this._getProp(this.node.focus.strokeAlpha,e)))}}},{key:"unfocusAt",value:function(t){if(this.node.focus.enabled){var e=this.getPlanetAt(t);e.selected||(e.focused=!1,e.nodeElement&&(e.nodeElement.context.lineWidth=this._getProp(this.node.lineWidth,e),e.nodeElement.context.strokeAlpha=this._getProp(this.node.strokeAlpha,e)))}}}]),s);function s(t,e,i){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,s),this._opt=t,this.dataFrame=e,this._graphs=i,this.app=i.app,this.field=null,this.iGroup=0,this.groupLen=1,this.rRange={start:0,to:0},this.width=0,this.height=0,this.selectInds=[],this.layoutType="radian",this.pit={radius:30},this.planets=[],this.maxRingNum=0,this.ringNum=0,D._.extend(!0,this,(0,D.getDefaultProps)(s.defaultProps()),t),this.node.maxRadius>this.pit.radius&&(this.pit.radius=this.node.maxRadius),this.init()}t.default=l});