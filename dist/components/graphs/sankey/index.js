"use strict";!function(e,t){if("function"==typeof define&&define.amd)define(["exports","canvax","../index","../../../layout/sankey/index","mmvis"],t);else if("undefined"!=typeof exports)t(exports,require("canvax"),require("../index"),require("../../../layout/sankey/index"),require("mmvis"));else{var n={};t(n,e.canvax,e.index,e.index,e.mmvis),e.undefined=n}}(void 0,function(e,t,n,i,s){Object.defineProperty(e,"__esModule",{value:!0});var r=l(t),a=l(n),u=l(i);function l(e){return e&&e.__esModule?e:{default:e}}function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function d(e){return(d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function h(e,t,n){return t&&p(e.prototype,t),n&&p(e,n),e}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var y=r.default.Shapes.Path,v=r.default.Shapes.Rect,_=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(g,a.default),h(g,null,[{key:"defaultProps",value:function(){return{keyField:{detail:"key字段",default:null},valueField:{detail:"value字段",default:"value"},parentField:{detail:"parent字段",default:null},node:{detail:"node",propertys:{width:{detail:"节点宽",default:18},padding:{detail:"节点间距",default:10},sort:{detail:"节点排序字段",default:function(e,t){return e.y-t.y}},fillStyle:{detail:"节点背景色",default:null}}},line:{detail:"线设置",propertys:{strokeStyle:{detail:"线颜色",default:"blue"},alpha:{detail:"线透明度",default:.3},focus:{detail:"图形的hover设置",propertys:{enabled:{detail:"是否开启",default:!0}}}}},label:{detail:"文本设置",propertys:{fontColor:{detail:"文本颜色",default:"#666666"},fontSize:{detail:"文本字体大小",default:12},textAlign:{detail:"水平对齐方式",default:"left"},verticalAlign:{detail:"垂直对齐方式",default:"middle"},format:{detail:"文本格式函数",default:null}}}}}}]),h(g,[{key:"init",value:function(){this._links=new r.default.Display.Sprite,this._nodes=new r.default.Display.Sprite,this._labels=new r.default.Display.Sprite,this.sprite.addChild(this._links),this.sprite.addChild(this._nodes),this.sprite.addChild(this._labels)}},{key:"draw",value:function(e){e=e||{},s._.extend(!0,this,e),this.data=this._trimGraphs(),this._widget(),this.sprite.context.x=this.origin.x,this.sprite.context.y=this.origin.y,this.fire("complete")}},{key:"_trimGraphs",value:function(){var i=this,a=[],l=[],e=i.dataFrame.getFieldData(i.keyField),o=i.dataFrame.getFieldData(i.valueField),r=i.dataFrame.getFieldData(i.parentField),d={};return s._.each(e,function(e,t){var n=[];i.parentField&&n.push(r[t]),n=n.concat(e.split(/[|]/)),s._.each(n,function(e){void 0===d[e]&&(d[e]=a.length,a.push({name:e}))})}),s._.each(e,function(e,t){var n=[];i.parentField&&n.push(r[t]),2==(n=n.concat(e.split(/[|]/))).length&&l.push({source:d[n[0]],target:d[n[1]],value:o[t]})}),(0,u.default)().nodeWidth(this.node.width).nodePadding(this.node.padding).nodeSort(this.node.sort).size([this.width,this.height]).nodes(a).links(l).layout(16)}},{key:"_widget",value:function(){this._drawNodes(),this._drawLinks(),this._drawLabels()}},{key:"_getColor",value:function(e,t,n){var i=e;return s._.isArray(i)&&(i=i[n]),s._.isFunction(i)&&(i=i(t)),i=i||this.app.getTheme(n)}},{key:"_drawNodes",value:function(){var e=this.data.nodes(),a=this;s._.each(e,function(e,t){var n=a._getColor(a.node.fillStyle,e,t),i=new v({xyToInt:!1,context:{x:e.x,y:e.y,width:a.data.nodeWidth(),height:Math.max(e.dy,1),fillStyle:n}});i.data=e,a._nodes.addChild(i)})}},{key:"_drawLinks",value:function(){var e=this.data.links(),l=this;s._.each(e,function(e,t){var n=l._getColor(l.line.strokeStyle,e,t),i=l.data.link()(e),a=new y({xyToInt:!1,context:{path:i,fillStyle:n,globalAlpha:l.line.alpha,cursor:"pointer"}});a.__glpha=l.line.alpha,a.link=e,a.on(s.event.types.get(),function(e){l.line.focus.enabled&&("mouseover"==e.type&&(this.__glpha+=.1),"mouseout"==e.type&&(this.__glpha-=.1));var t=this.link;t.type="sankey",e.eventInfo={trigger:l.node,title:t.source.name+" --<span style='position:relative;top:-0.5px;font-size:16px;left:-3px;'>></span> "+t.target.name,nodes:[t]},l.app.fire(e.type,e)}),l._links.addChild(a)})}},{key:"_drawLabels",value:function(){var e=this.data.nodes(),o=this;s._.each(e,function(e){var t=o.label.textAlign,n=e.x+o.data.nodeWidth()+4,i=e.y+Math.max(e.dy/2,1),a=o.label.format?o.label.format(e.name,e):e.name,l=new r.default.Display.Text(a,{context:{x:n,y:i,fillStyle:o.label.fontColor,fontSize:o.label.fontSize,textAlign:t,textBaseline:o.label.verticalAlign}});o._labels.addChild(l),l.getTextWidth()+n>o.width&&(l.context.x=e.x-4,l.context.textAlign="right")})}}]),g);function g(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,g),(n=function(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?f(e):t}(this,d(g).call(this,e,t))).type="sankey",s._.extend(!0,f(n),(0,s.getDefaultProps)(g.defaultProps()),e),n.init(),n}s.global.registerComponent(_,"graphs","sankey"),e.default=_});