"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_canvax=_interopRequireDefault(require("canvax")),_index=_interopRequireDefault(require("../index")),_index2=_interopRequireDefault(require("../../../layout/sankey/index")),_mmvis=require("mmvis"),Path=_canvax.default.Shapes.Path,Rect=_canvax.default.Shapes.Rect,sankeyGraphs=function(e){function i(e,t){var a;return(0,_classCallCheck2.default)(this,i),(a=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(i).call(this,e,t))).type="sankey",_mmvis._.extend(!0,(0,_assertThisInitialized2.default)(a),(0,_mmvis.getDefaultProps)(i.defaultProps()),e),a.init(),a}return(0,_inherits2.default)(i,e),(0,_createClass2.default)(i,null,[{key:"defaultProps",value:function(){return{keyField:{detail:"key字段",default:null},valueField:{detail:"value字段",default:"value"},parentField:{detail:"parent字段",default:null},node:{detail:"node",propertys:{width:{detail:"节点宽",default:18},padding:{detail:"节点间距",default:10},sort:{detail:"节点排序字段",default:function(e,t){return e.y-t.y}},fillStyle:{detail:"节点背景色",default:null}}},line:{detail:"线设置",propertys:{strokeStyle:{detail:"线颜色",default:"blue"},alpha:{detail:"线透明度",default:.3},focus:{detail:"图形的hover设置",propertys:{enabled:{detail:"是否开启",default:!0}}}}},label:{detail:"文本设置",propertys:{fontColor:{detail:"文本颜色",default:"#666666"},fontSize:{detail:"文本字体大小",default:12},textAlign:{detail:"水平对齐方式",default:"left"},verticalAlign:{detail:"垂直对齐方式",default:"middle"},format:{detail:"文本格式函数",default:null}}}}}}]),(0,_createClass2.default)(i,[{key:"init",value:function(){this._links=new _canvax.default.Display.Sprite,this._nodes=new _canvax.default.Display.Sprite,this._labels=new _canvax.default.Display.Sprite,this.sprite.addChild(this._links),this.sprite.addChild(this._nodes),this.sprite.addChild(this._labels)}},{key:"draw",value:function(e){e=e||{},_mmvis._.extend(!0,this,e),this.data=this._trimGraphs(),this._widget(),this.sprite.context.x=this.origin.x,this.sprite.context.y=this.origin.y,this.fire("complete")}},{key:"_trimGraphs",value:function(){var i=this,l=[],n=[],e=i.dataFrame.getFieldData(i.keyField),r=i.dataFrame.getFieldData(i.valueField),s=i.dataFrame.getFieldData(i.parentField),d={};return _mmvis._.each(e,function(e,t){var a=[];i.parentField&&a.push(s[t]),a=a.concat(e.split(/[|]/)),_mmvis._.each(a,function(e){void 0===d[e]&&(d[e]=l.length,l.push({name:e}))})}),_mmvis._.each(e,function(e,t){var a=[];i.parentField&&a.push(s[t]),2==(a=a.concat(e.split(/[|]/))).length&&n.push({source:d[a[0]],target:d[a[1]],value:r[t]})}),(0,_index2.default)().nodeWidth(this.node.width).nodePadding(this.node.padding).nodeSort(this.node.sort).size([this.width,this.height]).nodes(l).links(n).layout(16)}},{key:"_widget",value:function(){this._drawNodes(),this._drawLinks(),this._drawLabels()}},{key:"_getColor",value:function(e,t,a){var i=e;return _mmvis._.isArray(i)&&(i=i[a]),_mmvis._.isFunction(i)&&(i=i(t)),i=i||this.app.getTheme(a)}},{key:"_drawNodes",value:function(){var e=this.data.nodes(),l=this;_mmvis._.each(e,function(e,t){var a=l._getColor(l.node.fillStyle,e,t),i=new Rect({xyToInt:!1,context:{x:e.x,y:e.y,width:l.data.nodeWidth(),height:Math.max(e.dy,1),fillStyle:a}});i.data=e,l._nodes.addChild(i)})}},{key:"_drawLinks",value:function(){var e=this.data.links(),n=this;_mmvis._.each(e,function(e,t){var a=n._getColor(n.line.strokeStyle,e,t),i=n.data.link()(e),l=new Path({xyToInt:!1,context:{path:i,fillStyle:a,globalAlpha:n.line.alpha,cursor:"pointer"}});l.__glpha=n.line.alpha,l.link=e,l.on(_mmvis.event.types.get(),function(e){n.line.focus.enabled&&("mouseover"==e.type&&(this.__glpha+=.1),"mouseout"==e.type&&(this.__glpha-=.1));var t=this.link;t.type="sankey",e.eventInfo={trigger:n.node,title:t.source.name+" --<span style='position:relative;top:-0.5px;font-size:16px;left:-3px;'>></span> "+t.target.name,nodes:[t]},n.app.fire(e.type,e)}),n._links.addChild(l)})}},{key:"_drawLabels",value:function(){var e=this.data.nodes(),r=this;_mmvis._.each(e,function(e){var t=r.label.textAlign,a=e.x+r.data.nodeWidth()+4,i=e.y+Math.max(e.dy/2,1),l=r.label.format?r.label.format(e.name,e):e.name,n=new _canvax.default.Display.Text(l,{context:{x:a,y:i,fillStyle:r.label.fontColor,fontSize:r.label.fontSize,textAlign:t,textBaseline:r.label.verticalAlign}});r._labels.addChild(n),n.getTextWidth()+a>r.width&&(n.context.x=e.x-4,n.context.textAlign="right")})}}]),i}(_index.default);_mmvis.global.registerComponent(sankeyGraphs,"graphs","sankey");var _default2=sankeyGraphs;exports.default=_default2;