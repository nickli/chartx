"use strict";!function(t,e){if("function"==typeof define&&define.amd)define(["exports","canvax","../index","../../../utils/tools","mmvis"],e);else if("undefined"!=typeof exports)e(exports,require("canvax"),require("../index"),require("../../../utils/tools"),require("mmvis"));else{var i={};e(i,t.canvax,t.index,t.tools,t.mmvis),t.undefined=i}}(void 0,function(t,e,i,n,l){Object.defineProperty(t,"__esModule",{value:!0});var o=r(e),a=r(i);function r(t){return t&&t.__esModule?t:{default:t}}function d(t){return(d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function u(t){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function s(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function f(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function h(t,e,i){return e&&f(t.prototype,e),i&&f(t,i),t}function c(t,e){return(c=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var p=o.default.Display.Text,m=o.default.Shapes.Polygon,y=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&c(t,e)}(g,a.default),h(g,null,[{key:"defaultProps",value:function(){return{field:{detail:"字段配置",default:null},sort:{detail:"排序规则",default:null},maxNodeWidth:{detail:"最大的元素宽",default:null},minNodeWidth:{detail:"最小的元素宽",default:0},minVal:{detail:"漏斗的塔尖",default:0},node:{detail:"单个元素图形配置",propertys:{height:{detail:"高",default:0,documentation:"漏斗单元高，如果options没有设定， 就会被自动计算为 this.height/dataOrg.length"}}},label:{detail:"文本配置",propertys:{enabled:{detail:"是否开启文本",default:!0},textAlign:{detail:"文本布局位置(left,center,right)",default:"center"},textBaseline:{detail:"文本基线对齐方式",default:"middle"},format:{detail:"文本格式化处理函数",default:function(t){return(0,n.numAddSymbol)(t)}},fontSize:{detail:"文本字体大小",default:13},fontColor:{detail:"文本颜色",default:"#ffffff",documentation:"align为center的时候的颜色，align为其他属性时候取node的颜色"}}}}}}]),h(g,[{key:"init",value:function(){}},{key:"_computerAttr",value:function(){this.field&&(this.dataOrg=this.dataFrame.getFieldData(this.field)),this._maxVal=l._.max(this.dataOrg),this._minVal=l._.min(this.dataOrg),this.maxNodeWidth||(this.maxNodeWidth=.7*this.width),this.node.height||(this.node.height=this.height/this.dataOrg.length)}},{key:"draw",value:function(t){t=t||{},l._.extend(!0,this,t),this.animation&&t.resize,this._computerAttr(),this.data=this._trimGraphs(),this._drawGraphs(),this.sprite.context.x=this.origin.x+this.width/2,this.sprite.context.y=this.origin.y}},{key:"_trimGraphs",value:function(){if(this.field){var n=this,o=[];return l._.each(this.dataOrg,function(t,e){var i={type:"funnel",field:n.field,rowData:n.dataFrame.getRowDataAt(e),value:t,width:n._getNodeWidth(t),color:n.app.getTheme(e),cursor:"pointer",label:"",middlePoint:null,iNode:-1,points:[]};o.push(i)}),this.sort&&(o=o.sort(function(t,e){return"desc"==n.sort?e.value-t.value:t.value-e.value})),l._.each(o,function(t,e){t.iNode=e,t.label=n.label.format(t.value,t)}),l._.each(o,function(t,e){t.points=n._getPoints(t,o[e+1],o[e-1]),t.middlePoint={x:0,y:(t.iNode+.5)*n.node.height}}),o}}},{key:"_getNodeWidth",value:function(t){var e=this.minNodeWidth+(this.maxNodeWidth-this.minNodeWidth)/(this._maxVal-this.minVal)*(t-this.minVal);return parseInt(e)}},{key:"_getPoints",value:function(t,e,i){var n=[],o=t.iNode*this.node.height,a=o+this.node.height;if("asc"!==this.sort){n.push([-t.width/2,o]),n.push([t.width/2,o]);var l=this.minNodeWidth;e&&(l=e.width),n.push([l/2,a]),n.push([-l/2,a])}else{var r=this.minNodeWidth;i&&(r=i.width),n.push([-r/2,o]),n.push([r/2,o]),n.push([t.width/2,a]),n.push([-t.width/2,a])}return n}},{key:"_drawGraphs",value:function(){var a=this;l._.each(this.data,function(t){var e=new m({context:{pointList:t.points,fillStyle:t.color,cursor:t.cursor}});a.sprite.addChild(e),e.nodeData=t,e.on(l.event.types.get(),function(t){t.eventInfo={trigger:a.node,title:a.field,nodes:[this.nodeData]},a.app.fire(t.type,t)});var i="center",n={x:t.middlePoint.x,y:t.middlePoint.y};"left"==a.label.textAlign&&(n.x=t.points[0][0]-(t.points[0][0]-t.points[3][0])/2,n.x-=15,i="right"),"right"==a.label.textAlign&&(n.x=t.points[1][0]-(t.points[1][0]-t.points[2][0])/2,n.x+=15,i="left");var o=new p(t.label,{context:{x:n.x,y:n.y,fontSize:a.label.fontSize,fillStyle:"center"==a.label.textAlign?a.label.fontColor:t.color,textAlign:i,textBaseline:a.label.textBaseline}});a.sprite.addChild(o)})}}]),g);function g(t,e){var i;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,g),(i=function(t,e){return!e||"object"!==d(e)&&"function"!=typeof e?s(t):e}(this,u(g).call(this,t,e))).type="funnel",i.dataOrg=[],i.data=[],i._maxVal=null,i._minVal=null,l._.extend(!0,s(i),(0,l.getDefaultProps)(g.defaultProps()),t),i.init(),i}l.global.registerComponent(y,"graphs","funnel"),t.default=y});