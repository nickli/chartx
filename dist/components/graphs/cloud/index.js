"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_canvax=_interopRequireDefault(require("canvax")),_index=_interopRequireDefault(require("../index")),_cloud=_interopRequireDefault(require("../../../layout/cloud")),_mmvis=require("mmvis"),Text=_canvax.default.Display.Text,CloudGraphs=function(e){function o(e,t){var i;(0,_classCallCheck2.default)(this,o),(i=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(o).call(this,e,t))).type="cloud";var n=(0,_assertThisInitialized2.default)(i);return i.node={_maxFontSizeVal:0,_minFontSizeVal:null},_mmvis._.extend(!0,(0,_assertThisInitialized2.default)(i),(0,_mmvis.getDefaultProps)(o.defaultProps()),e),i.node.fontColor=function(e){return n.app.getTheme(e.iNode)},i.init(),i}return(0,_inherits2.default)(o,e),(0,_createClass2.default)(o,null,[{key:"defaultProps",value:function(){return{field:{detail:"字段配置",default:null},node:{detail:"节点文字配置",propertys:{fontFamily:{detail:"字体设置",default:"Impact"},fontColor:{detail:"文字颜色",default:"#999"},fontSize:{detail:"文本字体大小",default:function(){return this.minFontSize+Math.random()*this.maxFontSize}},maxFontSize:{detail:"文本最大字体大小",default:30},minFontSize:{detail:"文本最小字体大小",default:16},fontWeight:{detail:"fontWeight",default:"normal"},format:{detail:"文本格式化处理函数",default:null},padding:{detail:"文本间距",default:10},rotation:{detail:"文本旋转角度",default:function(){return 30*(~~(6*Math.random())-3)}},strokeStyle:{detail:"文本描边颜色",default:null},select:{detail:"文本选中效果",propertys:{enabled:{detail:"是否开启选中",default:!0},lineWidth:{detail:"选中后的文本描边宽",default:2},strokeStyle:{detail:"选中后的文本描边色",default:"#666"}}},focus:{detail:"文本hover效果",propertys:{enabled:{detail:"是否开启hover效果",default:!0}}}}}}}}]),(0,_createClass2.default)(o,[{key:"init",value:function(){}},{key:"draw",value:function(e){e=e||{},_mmvis._.extend(!0,this,e),this._drawGraphs(),this.sprite.context.x=this.width/2,this.sprite.context.y=this.height/2,this.fire("complete")}},{key:"getDaraFrameIndOfVal",value:function(e){var t=this,i=this.dataFrame,n=_mmvis._.find(i.data,function(e){return e.field==t.field});return _mmvis._.indexOf(n.data,e)}},{key:"_getFontSize",value:function(e,t){var i=this.node.minFontSize;if(_mmvis._.isFunction(this.node.fontSize)&&(i=this.node.fontSize(e)),_mmvis._.isString(this.node.fontSize)&&this.node.fontSize in e){t=Number(e[this.node.fontSize]);isNaN(t)||(i=this.node.minFontSize+(this.node.maxFontSize-this.node.minFontSize)/(this.node._maxFontSizeVal-this.node._minFontSizeVal)*(t-this.node._minFontSizeVal))}return _mmvis._.isNumber(this.node.fontSize)&&(i=this.node.fontSize),i}},{key:"_getRotate",value:function(e,t){var i=this.node.rotation;return _mmvis._.isFunction(this.node.rotation)&&(i=this.node.rotation(e,t)||0),i}},{key:"_getFontColor",value:function(e){var t;return _mmvis._.isString(this.node.fontColor)&&(t=this.node.fontColor),_mmvis._.isFunction(this.node.fontColor)&&(t=this.node.fontColor(e)),null==t&&(t="#ccc"),t}},{key:"_drawGraphs",value:function(){var a=this;_mmvis._.isString(this.node.fontSize)&&_mmvis._.each(a.dataFrame.getFieldData(this.node.fontSize),function(e){a.node._maxFontSizeVal=Math.max(a.node._maxFontSizeVal,e),a.node._minFontSizeVal=Math.min(a.node._minFontSizeVal,e)}),(0,_cloud.default)().size([a.width,a.height]).words(a.dataFrame.getFieldData(a.field).map(function(e,t){var i=a.app.dataFrame.getRowDataAt(a.getDaraFrameIndOfVal(e)),n={type:"cloud",rowData:i,field:a.field,value:e,text:null,size:a._getFontSize(i,e),iNode:t,color:null};n.fontColor=a._getFontColor(n);var o=e;return a.node.format&&(o=a.node.format(e,n)),n.text=o||e,n})).padding(a.node.padding).rotate(function(e,t){return a._getRotate(e,t)}).font(a.node.fontFamily).fontSize(function(e){return e.size}).on("end",function(n,e){a.data=n,a.sprite.removeAllChildren(),_mmvis._.each(n,function(e,t){e.iNode=t,e.dataLen=n.length,e.focused=!1,e.selected=!1;var i=new Text(e.text,{context:{x:e.x,y:e.y,fontSize:e.size,fontFamily:e.font,rotation:e.rotate,textBaseline:"middle",textAlign:"center",cursor:"pointer",fontWeight:a.node.fontWeight,fillStyle:e.fontColor}});a.sprite.addChild(i),a.node.focus.enabled&&i.hover(function(e){a.focusAt(this.nodeData.iNode)},function(e){this.nodeData.selected||a.unfocusAt(this.nodeData.iNode)}),((i.nodeData=e)._node=i).on(_mmvis.event.types.get(),function(e){e.eventInfo={trigger:a.node,title:null,nodes:[this.nodeData]},this.nodeData.text&&(e.eventInfo.title=this.nodeData.text),a.app.fire(e.type,e)})})}).start()}},{key:"focusAt",value:function(e){var t=this.data[e];this.node.focus.enabled&&!t.focused&&(t._node.context.fontSize+=3,t.focused=!0)}},{key:"unfocusAt",value:function(e){var t=this.data[e];this.node.focus.enabled&&t.focused&&(t._node.context.fontSize-=3,t.focused=!1)}},{key:"selectAt",value:function(e){var t=this.data[e];if(this.node.select.enabled&&!t.selected){var i=t._node.context;i.lineWidth=this.node.select.lineWidth,i.strokeAlpha=this.node.select.strokeAlpha,i.strokeStyle=this.node.select.strokeStyle,t.selected=!0}}},{key:"unselectAt",value:function(e){var t=this.data[e];this.node.select.enabled&&t.selected&&(t._node.context.strokeStyle=this.node.strokeStyle,t.selected=!1)}}]),o}(_index.default);_mmvis.global.registerComponent(CloudGraphs,"graphs","cloud");var _default2=CloudGraphs;exports.default=_default2;