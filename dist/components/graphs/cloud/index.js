"use strict";!function(e,t){if("function"==typeof define&&define.amd)define(["exports","canvax","../index","../../../layout/cloud","mmvis"],t);else if("undefined"!=typeof exports)t(exports,require("canvax"),require("../index"),require("../../../layout/cloud"),require("mmvis"));else{var n={};t(n,e.canvax,e.index,e.cloud,e.mmvis),e.undefined=n}}(void 0,function(e,t,n,o,i){Object.defineProperty(e,"__esModule",{value:!0});var a=l(t),r=l(n),d=l(o);function l(e){return e&&e.__esModule?e:{default:e}}function u(e){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function h(e,t,n){return t&&c(e.prototype,t),n&&c(e,n),e}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var y=a.default.Display.Text,m=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(v,r.default),h(v,null,[{key:"defaultProps",value:function(){return{field:{detail:"字段配置",default:null},node:{detail:"节点文字配置",propertys:{fontFamily:{detail:"字体设置",default:"Impact"},fontColor:{detail:"文字颜色",default:"#999"},fontSize:{detail:"文本字体大小",default:function(){return this.minFontSize+Math.random()*this.maxFontSize}},maxFontSize:{detail:"文本最大字体大小",default:30},minFontSize:{detail:"文本最小字体大小",default:16},fontWeight:{detail:"fontWeight",default:"normal"},format:{detail:"文本格式化处理函数",default:null},padding:{detail:"文本间距",default:10},rotation:{detail:"文本旋转角度",default:function(){return 30*(~~(6*Math.random())-3)}},strokeStyle:{detail:"文本描边颜色",default:null},select:{detail:"文本选中效果",propertys:{enabled:{detail:"是否开启选中",default:!0},lineWidth:{detail:"选中后的文本描边宽",default:2},strokeStyle:{detail:"选中后的文本描边色",default:"#666"}}},focus:{detail:"文本hover效果",propertys:{enabled:{detail:"是否开启hover效果",default:!0}}}}}}}}]),h(v,[{key:"init",value:function(){}},{key:"draw",value:function(e){e=e||{},i._.extend(!0,this,e),this._drawGraphs(),this.sprite.context.x=this.width/2,this.sprite.context.y=this.height/2,this.fire("complete")}},{key:"getDaraFrameIndOfVal",value:function(e){var t=this,n=this.dataFrame,o=i._.find(n.data,function(e){return e.field==t.field});return i._.indexOf(o.data,e)}},{key:"_getFontSize",value:function(e,t){var n=this.node.minFontSize;return i._.isFunction(this.node.fontSize)&&(n=this.node.fontSize(e)),i._.isString(this.node.fontSize)&&this.node.fontSize in e&&(t=Number(e[this.node.fontSize]),isNaN(t)||(n=this.node.minFontSize+(this.node.maxFontSize-this.node.minFontSize)/(this.node._maxFontSizeVal-this.node._minFontSizeVal)*(t-this.node._minFontSizeVal))),i._.isNumber(this.node.fontSize)&&(n=this.node.fontSize),n}},{key:"_getRotate",value:function(e,t){var n=this.node.rotation;return i._.isFunction(this.node.rotation)&&(n=this.node.rotation(e,t)||0),n}},{key:"_getFontColor",value:function(e){var t;return i._.isString(this.node.fontColor)&&(t=this.node.fontColor),i._.isFunction(this.node.fontColor)&&(t=this.node.fontColor(e)),null==t&&(t="#ccc"),t}},{key:"_drawGraphs",value:function(){var a=this;i._.isString(this.node.fontSize)&&i._.each(a.dataFrame.getFieldData(this.node.fontSize),function(e){a.node._maxFontSizeVal=Math.max(a.node._maxFontSizeVal,e),a.node._minFontSizeVal=Math.min(a.node._minFontSizeVal,e)}),(0,d.default)().size([a.width,a.height]).words(a.dataFrame.getFieldData(a.field).map(function(e,t){var n=a.app.dataFrame.getRowDataAt(a.getDaraFrameIndOfVal(e)),o={type:"cloud",rowData:n,field:a.field,value:e,text:null,size:a._getFontSize(n,e),iNode:t,color:null};o.fontColor=a._getFontColor(o);var i=e;return a.node.format&&(i=a.node.format(e,o)),o.text=i||e,o})).padding(a.node.padding).rotate(function(e,t){return a._getRotate(e,t)}).font(a.node.fontFamily).fontSize(function(e){return e.size}).on("end",function(o,e){a.data=o,a.sprite.removeAllChildren(),i._.each(o,function(e,t){e.iNode=t,e.dataLen=o.length,e.focused=!1,e.selected=!1;var n=new y(e.text,{context:{x:e.x,y:e.y,fontSize:e.size,fontFamily:e.font,rotation:e.rotate,textBaseline:"middle",textAlign:"center",cursor:"pointer",fontWeight:a.node.fontWeight,fillStyle:e.fontColor}});a.sprite.addChild(n),a.node.focus.enabled&&n.hover(function(e){a.focusAt(this.nodeData.iNode)},function(e){this.nodeData.selected||a.unfocusAt(this.nodeData.iNode)}),((n.nodeData=e)._node=n).on(i.event.types.get(),function(e){e.eventInfo={trigger:a.node,title:null,nodes:[this.nodeData]},this.nodeData.text&&(e.eventInfo.title=this.nodeData.text),a.app.fire(e.type,e)})})}).start()}},{key:"focusAt",value:function(e){var t=this.data[e];this.node.focus.enabled&&!t.focused&&(t._node.context.fontSize+=3,t.focused=!0)}},{key:"unfocusAt",value:function(e){var t=this.data[e];this.node.focus.enabled&&t.focused&&(t._node.context.fontSize-=3,t.focused=!1)}},{key:"selectAt",value:function(e){var t=this.data[e];if(this.node.select.enabled&&!t.selected){var n=t._node.context;n.lineWidth=this.node.select.lineWidth,n.strokeAlpha=this.node.select.strokeAlpha,n.strokeStyle=this.node.select.strokeStyle,t.selected=!0}}},{key:"unselectAt",value:function(e){var t=this.data[e];this.node.select.enabled&&t.selected&&(t._node.context.strokeStyle=this.node.strokeStyle,t.selected=!1)}}]),v);function v(e,t){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,v),(n=function(e,t){return!t||"object"!==u(t)&&"function"!=typeof t?s(e):t}(this,f(v).call(this,e,t))).type="cloud";var o=s(n);return n.node={_maxFontSizeVal:0,_minFontSizeVal:null},i._.extend(!0,s(n),(0,i.getDefaultProps)(v.defaultProps()),e),n.node.fontColor=function(e){return o.app.getTheme(e.iNode)},n.init(),n}i.global.registerComponent(m,"graphs","cloud"),e.default=m});