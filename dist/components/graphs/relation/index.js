"use strict";!function(t,e){if("function"==typeof define&&define.amd)define(["exports","canvax","../index","mmvis","./data"],e);else if("undefined"!=typeof exports)e(exports,require("canvax"),require("../index"),require("mmvis"),require("./data"));else{var i={};e(i,t.canvax,t.index,t.mmvis,t.data),t.undefined=i}}(void 0,function(t,e,i,c,l){Object.defineProperty(t,"__esModule",{value:!0});var s=a(e),n=a(i);function a(t){return t&&t.__esModule?t:{default:t}}function r(t){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function o(t){return function(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function d(t){return(d=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function h(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function u(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function p(t,e,i){return e&&u(t.prototype,e),i&&u(t,i),t}function y(t,e){return(y=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var f=s.default.Shapes.Rect,g=s.default.Shapes.Path,x=s.default.Shapes.Arrow,m=(s.default.Shapes.Circle,function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&y(t,e)}(v,n.default),p(v,null,[{key:"defaultProps",value:function(){return{field:{detail:"key字段设置",documentation:"",default:null},childrenField:{detail:"树结构数据的关联字段",documentation:"如果是树结构的关联数据，不是行列式，那么就通过这个字段来建立父子关系",default:"children"},rankdir:{detail:"布局方向",default:null},node:{detail:"单个节点的配置",propertys:{shapeType:{detail:"节点图形，目前只支持rect",default:"rect"},maxWidth:{detail:"节点最大的width",default:200},width:{detail:"内容的width",default:null},height:{detail:"内容的height",default:null},radius:{detail:"圆角角度",default:6},fillStyle:{detail:"节点背景色",default:"#ffffff"},strokeStyle:{detail:"描边颜色",default:"#e5e5e5"},padding:{detail:"node节点容器到内容的边距",default:10},content:{detail:"节点内容配置",propertys:{field:{detail:"内容字段",documentation:"默认content字段",default:"content"},fontColor:{detail:"内容文本颜色",default:"#666"},format:{detail:"内容格式化处理函数",default:null},textAlign:{detail:"textAlign",default:"center"},textBaseline:{detail:"textBaseline",default:"middle"}}}}},line:{detail:"两个节点连线配置",propertys:{isTree:{detail:"是否树结构的连线",documentation:"非树结构启用该配置可能会有意想不到的惊喜，慎用",default:!1},inflectionRadius:{detail:"树状连线的拐点圆角半径",default:0},shapeType:{detail:"连线的图形样式 brokenLine or bezier",default:"bezier"},lineWidth:{detail:"线宽",default:1},strokeStyle:{detail:"连线的颜色",default:"#e5e5e5"},lineType:{detail:"连线样式（虚线等）",default:"solid"},arrow:{detail:"是否有箭头",default:!0}}},layout:{detail:"采用的布局引擎,比如dagre",default:"dagre"},layoutOpts:{detail:"布局引擎对应的配置,dagre详见dagre的官方wiki",propertys:{}},status:{detail:"一些开关配置",propertys:{transform:{detail:"是否启动拖拽缩放整个画布",propertys:{fitView:{detail:"自动缩放",default:""},enabled:{detail:"是否开启",default:!0},scale:{detail:"缩放值",default:1},scaleOrigin:{detail:"缩放原点",default:{x:0,y:0}}}}}}}}}]),p(v,[{key:"init",value:function(){this.initInduce(),this.nodesSp=new s.default.Display.Sprite({id:"nodesSp"}),this.edgesSp=new s.default.Display.Sprite({id:"edgesSp"}),this.graphsSp=new s.default.Display.Sprite({id:"graphsSp"}),this.graphsSp.addChild(this.edgesSp),this.graphsSp.addChild(this.nodesSp),this._grahsSpClone=new s.default.Display.Sprite({id:"graphsSp_clone"}),this.sprite.addChild(this.graphsSp),this.sprite.addChild(this._grahsSpClone),window.gsp=this.graphsSp}},{key:"initInduce",value:function(){var a=this;this.induce=new f({id:"induce",context:{width:0,height:0,fillStyle:"#000000",globalAlpha:0}}),this.sprite.addChild(this.induce);var t=!1,e=null,i=a.app.canvax.domView.style.cursor,r=null,o=0;this.induce.on(c.event.types.get(),function(n){a.status.transform.enabled&&("mousedown"==n.type&&(a.induce.toFront(),t=!0,e=n.point,a.app.canvax.domView.style.cursor="move"),"mouseup"!=n.type&&"mouseout"!=n.type||(a.induce.toBack(),t=!1,e=null,a.app.canvax.domView.style.cursor=i),"mousemove"==n.type&&t&&(a.graphsSp.context.x+=n.point.x-e.x,a.graphsSp.context.y+=n.point.y-e.y,e=n.point),"wheel"==n.type&&(Math.abs(n.deltaY)>Math.abs(o)&&(o=n.deltaY),r=r||setTimeout(function(){var t=n.deltaY/30*.02;Math.abs(t)<.04&&(t=.04*Math.sign(t)),.08<Math.abs(t)&&(t=.08*Math.sign(t));var e=a.status.transform.scale+t;e<=.1&&(e=.1),1<=e&&(e=1);var i=n.target.localToGlobal(n.point);a.scale(e,i),r=null,o=0},32),n.preventDefault()))})}},{key:"scale",value:function(){}},{key:"draw",value:function(t){t=t||{},c._.extend(!0,this,t),this.data=t.data||this._initData(),"dagre"==this.layout?this.dagreLayout(this.data):"tree"==this.layout?this.treeLayout(this.data):c._.isFunction(this.layout)&&this.layout(this.data),this.widget(),this.sprite.context.x=this.origin.x,this.sprite.context.y=this.origin.y,"autoZoom"==this.status.transform.fitView&&(this.sprite.context.scaleX=this.width/this.data.size.width,this.sprite.context.scaleY=this.height/this.data.size.height);var e=(this.width-this.data.size.width)/2;e<0&&(e=0),this.graphsSp.context.x=e,this._grahsSpClone.context.x=e}},{key:"_initData",value:function(){var t={nodes:[],edges:[],size:{width:0,height:0}},e=this.app._data;(0,l.checkDataIsJson)(e,this.field,this.childrenField)?(this.jsonData=(0,l.jsonToArrayForRelation)(e,this,this.childrenField),this.dataFrame=this.app.dataFrame=(0,c.dataFrame)(this.jsonData)):"tree"==this.layout&&(this.jsonData=(0,l.arrayToTreeJsonForRelation)(this.app.dataFrame.jsonOrg,this));for(var i={},n=0;n<this.dataFrame.length;n++){var a=this.dataFrame.getRowDataAt(n),r=c._.flatten([(a[this.field]+"").split(",")]),o=this._getContent(a),s={type:"relation",iNode:n,rowData:a,key:1==r.length?r[0]:r,content:o,ctype:this._checkHtml(o)?"html":"canvas",element:null,width:null,height:null,x:null,y:null,shapeType:null,source:null,target:null};c._.extend(s,this._getElementAndSize(s)),1==r.length?(s.shapeType=this.getProp(this.node.shapeType,s),t.nodes.push(s),i[s.key]=s):(s.shapeType=this.getProp(this.line.shapeType,s),t.edges.push(s))}return c._.each(t.edges,function(t){var e=t.key;t.source=i[e[0]],t.target=i[e[1]]}),t}},{key:"dagreLayout",value:function(t){var e=c.global.layout.dagre,i=new e.graphlib.Graph;return i.setGraph(this.layoutOpts.graph),i.setDefaultEdgeLabel(function(){return{}}),c._.each(t.nodes,function(t){i.setNode(t.key,t)}),c._.each(t.edges,function(t){i.setEdge.apply(i,o(t.key).concat([t]))}),e.layout(i),t.size.width=i.graph().width,t.size.height=i.graph().height,t}},{key:"treeLayout",value:function(){var t=c.global.layout.tree().separation(function(t,e){return(t.width+e.width)/2+10}),e=t.nodes(this.jsonData[0]).reverse();t.links(e)}},{key:"widget",value:function(){var o=this;c._.each(this.data.edges,function(t){o.line.isTree&&o._setTreePoints(t);var e=o.getProp(o.line.lineWidth,t),i=o.getProp(o.line.strokeStyle,t),n=new g({context:{path:o._getPathStr(t,o.line.inflectionRadius),lineWidth:e,strokeStyle:i}}),a=t.points.slice(-2,-1)[0];if("bezier"==o.line.shapeType&&("TB"!=o.rankdir&&"BT"!=o.rankdir||(a.x+=(t.source.x-t.target.x)/20),"LR"!=o.rankdir&&"RL"!=o.rankdir||(a.y+=(t.source.y-t.target.y)/20)),o.edgesSp.addChild(n),o.line.arrow){var r=new x({context:{control:a,point:t.points.slice(-1)[0],strokeStyle:i}});o.edgesSp.addChild(r)}}),c._.each(this.data.nodes,function(e){var i=new f({context:{x:e.x-e.width/2,y:e.y-e.height/2,width:e.width,height:e.height,lineWidth:1,fillStyle:o.getProp(o.node.fillStyle,e),strokeStyle:o.getProp(o.node.strokeStyle,e),radius:c._.flatten([o.getProp(o.node.radius,e)])}});i.nodeData=e,o.nodesSp.addChild(i),i.on(c.event.types.get(),function(t){t.eventInfo={trigger:o.node,nodes:[this.nodeData]},o.app.fire(t.type,t)}),"canvas"==e.ctype&&(e.element.context.x=e.x-e.width/2,e.element.context.y=e.y-e.height/2,o.nodesSp.addChild(e.element)),"html"==e.ctype&&i.on("transform",function(){var t="undefined"!=typeof window?window.devicePixelRatio:1;e.element.style.transform="matrix("+i.worldTransform.clone().scale(1/t,1/t).toArray().join()+")",e.element.style.transformOrigin="left top",e.element.style.marginLeft=o.getProp(o.node.padding,e)*o.status.transform.scale+"px",e.element.style.marginTop=o.getProp(o.node.padding,e)*o.status.transform.scale+"px",e.element.style.visibility="visible"})}),this.induce.context.width=this.width,this.induce.context.height=this.height}},{key:"_setTreePoints",value:function(t){var e=t.points;"TB"!=this.rankdir&&"BT"!=this.rankdir||(e[0]={x:t.source.x,y:t.source.y+("BT"==this.rankdir?-1:1)*t.source.height/2},e.splice(1,0,{x:t.source.x,y:e.slice(-2,-1)[0].y})),"LR"!=this.rankdir&&"RL"!=this.rankdir||(e[0]={x:t.source.x+("RL"==this.rankdir?-1:1)*t.source.width/2,y:t.source.y},e.splice(1,0,{x:e.slice(-2,-1)[0].x,y:t.source.y})),t.points=e}},{key:"_getPathStr",value:function(t,h){var u=t.points,e=u[0],i=u.slice(-1)[0],p="M"+e.x+" "+e.y;return"bezier"==t.shapeType&&(3==u.length&&(p+=",Q"+u[1].x+" "+u[1].y+" "+i.x+" "+i.y),4==u.length&&(p+=",C"+u[1].x+" "+u[1].y+" "+u[2].x+" "+u[2].y+" "+i.x+" "+i.y)),"brokenLine"==t.shapeType&&c._.each(u,function(i,t){if(t)if(h&&t<u.length-1){var e=u[t-1],n=u[t+1],a=h,r=Math.max(Math.abs(e.x-i.x)/2,Math.abs(e.y-i.y)/2),o=Math.max(Math.abs(n.x-i.x)/2,Math.abs(n.y-i.y)/2);if(a=c._.min([a,r,o]),i.x==e.x&&i.y==e.y||i.x==n.x&&i.y==n.y||Math.atan2(i.y-e.y,i.x-e.x)==Math.atan2(n.y-i.y,n.x-i.x))return;var s=function(t){var e=Math.atan2(t.y-i.y,t.x-i.x);return{x:i.x+a*Math.cos(e),y:i.y+a*Math.sin(e)}},l=s(e),d=s(n);p+=",L"+l.x+" "+l.y+",Q"+i.x+" "+i.y+" "+d.x+" "+d.y}else p+=",L"+i.x+" "+i.y}),p}},{key:"_checkHtml",value:function(t){return/<[^>]+>/g.test(t)}},{key:"_getContent",value:function(t){var e;return this._isField(this.node.content.field)&&(e=t[this.node.content.field]),this.node.content.format&&c._.isFunction(this.node.content.format)&&(e=this.node.content.format.apply(this,[e,t])),e}},{key:"_isField",value:function(t){return~this.dataFrame.fields.indexOf(t)}},{key:"_getElementAndSize",value:function(t){var e=t.ctype;return this._isField(e)&&(e=t.rowData[e]),"canvas"==(e=e||"canvas")?this._getEleAndsetCanvasSize(t):"html"==e?this._getEleAndsetHtmlSize(t):void 0}},{key:"_getEleAndsetCanvasSize",value:function(t){var e=this,i=t.content,n=t.rowData.width,a=t.rowData.height,r=new s.default.Display.Sprite({}),o=new s.default.Display.Text(i,{context:{fillStyle:e.getProp(e.node.content.fontColor,t),textAlign:e.getProp(e.node.content.textAlign,t),textBaseline:e.getProp(e.node.content.textBaseline,t)}});return n=n||o.getTextWidth()+e.getProp(e.node.padding,t)*e.status.transform.scale*2,a=a||o.getTextHeight()+e.getProp(e.node.padding,t)*e.status.transform.scale*2,r.addChild(o),r.context.width=parseInt(n),r.context.height=parseInt(a),o.context.x=parseInt(n/2),o.context.y=parseInt(a/2),{element:r,width:n,height:a}}},{key:"_getEleAndsetHtmlSize",value:function(t){var e=this,i=t.content,n=t.rowData.width,a=t.rowData.height,r=document.createElement("div");return r.className="chartx_relation_node",r.style.cssText+="; position:absolute;visibility:hidden;",r.style.cssText+="; color:"+e.getProp(e.node.content.fontColor,t)+";",r.style.cssText+="; text-align:"+e.getProp(e.node.content.textAlign,t)+";",r.style.cssText+="; vertical-align:"+e.getProp(e.node.content.textBaseline,t)+";",r.innerHTML=i,this.domContainer.appendChild(r),{element:r,width:n=n||r.offsetWidth+e.getProp(e.node.padding,t)*e.status.transform.scale*2,height:a=a||r.offsetHeight+e.getProp(e.node.padding,t)*e.status.transform.scale*2}}},{key:"getNodesAt",value:function(){}},{key:"getProp",value:function(t,e){var i=t;return this._isField(t)?i=e.rowData[t]:(c._.isArray(t)&&(i=t[e.iNode]),c._.isFunction(t)&&(i=t.apply(this,[e]))),i}}]),v);function v(t,e){var i;if(!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,v),(i=function(t,e){return!e||"object"!==r(e)&&"function"!=typeof e?h(t):e}(this,d(v).call(this,t,e))).type="relation",c._.extend(!0,h(i),(0,c.getDefaultProps)(v.defaultProps()),t),"dagre"===i.layout){var n={graph:{rankdir:"TB",nodesep:10,ranksep:10,edgesep:10,acyclicer:"greedy"},node:{},edge:{}};c._.extend(!0,n,i.layoutOpts),c._.extend(!0,i.layoutOpts,n),i.rankdir?i.layoutOpts.graph.rankdir=i.rankdir:i.rankdir=i.layoutOpts.graph.rankdir}return i.domContainer=e.canvax.domView,i.induce=null,i.init(),i}c.global.registerComponent(m,"graphs","relation"),t.default=m});