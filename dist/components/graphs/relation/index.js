"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_canvax=_interopRequireDefault(require("canvax")),_index=_interopRequireDefault(require("../index")),_mmvis=require("mmvis"),_data=require("./data"),Rect=_canvax.default.Shapes.Rect,Path=_canvax.default.Shapes.Path,Arrow=_canvax.default.Shapes.Arrow,Circle=_canvax.default.Shapes.Circle,Relation=function(e){function n(e,t){var a;if((0,_classCallCheck2.default)(this,n),(a=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(n).call(this,e,t))).type="relation",_mmvis._.extend(!0,(0,_assertThisInitialized2.default)(a),(0,_mmvis.getDefaultProps)(n.defaultProps()),e),"dagre"===a.layout){var i={graph:{rankdir:"TB",nodesep:10,ranksep:10,edgesep:10,acyclicer:"greedy"},node:{},edge:{}};_mmvis._.extend(!0,i,a.layoutOpts),_mmvis._.extend(!0,a.layoutOpts,i),a.rankdir?a.layoutOpts.graph.rankdir=a.rankdir:a.rankdir=a.layoutOpts.graph.rankdir}return a.domContainer=t.canvax.domView,a.induce=null,a.init(),a}return(0,_inherits2.default)(n,e),(0,_createClass2.default)(n,null,[{key:"defaultProps",value:function(){return{field:{detail:"key字段设置",documentation:"",default:null},childrenField:{detail:"树结构数据的关联字段",documentation:"如果是树结构的关联数据，不是行列式，那么就通过这个字段来建立父子关系",default:"children"},rankdir:{detail:"布局方向",default:null},node:{detail:"单个节点的配置",propertys:{shapeType:{detail:"节点图形，目前只支持rect",default:"rect"},maxWidth:{detail:"节点最大的width",default:200},width:{detail:"内容的width",default:null},height:{detail:"内容的height",default:null},radius:{detail:"圆角角度",default:6},fillStyle:{detail:"节点背景色",default:"#ffffff"},strokeStyle:{detail:"描边颜色",default:"#e5e5e5"},padding:{detail:"node节点容器到内容的边距",default:10},content:{detail:"节点内容配置",propertys:{field:{detail:"内容字段",documentation:"默认content字段",default:"content"},fontColor:{detail:"内容文本颜色",default:"#666"},format:{detail:"内容格式化处理函数",default:null},textAlign:{detail:"textAlign",default:"center"},textBaseline:{detail:"textBaseline",default:"middle"}}}}},line:{detail:"两个节点连线配置",propertys:{isTree:{detail:"是否树结构的连线",documentation:"非树结构启用该配置可能会有意想不到的惊喜，慎用",default:!1},inflectionRadius:{detail:"树状连线的拐点圆角半径",default:0},shapeType:{detail:"连线的图形样式 brokenLine or bezier",default:"bezier"},lineWidth:{detail:"线宽",default:1},strokeStyle:{detail:"连线的颜色",default:"#e5e5e5"},lineType:{detail:"连线样式（虚线等）",default:"solid"},arrow:{detail:"是否有箭头",default:!0}}},layout:{detail:"采用的布局引擎,比如dagre",default:"dagre"},layoutOpts:{detail:"布局引擎对应的配置,dagre详见dagre的官方wiki",propertys:{}},status:{detail:"一些开关配置",propertys:{transform:{detail:"是否启动拖拽缩放整个画布",propertys:{fitView:{detail:"自动缩放",default:""},enabled:{detail:"是否开启",default:!0},scale:{detail:"缩放值",default:1},scaleOrigin:{detail:"缩放原点",default:{x:0,y:0}}}}}}}}}]),(0,_createClass2.default)(n,[{key:"init",value:function(){this.initInduce(),this.nodesSp=new _canvax.default.Display.Sprite({id:"nodesSp"}),this.edgesSp=new _canvax.default.Display.Sprite({id:"edgesSp"}),this.graphsSp=new _canvax.default.Display.Sprite({id:"graphsSp"}),this.graphsSp.addChild(this.edgesSp),this.graphsSp.addChild(this.nodesSp),this._grahsSpClone=new _canvax.default.Display.Sprite({id:"graphsSp_clone"}),this.sprite.addChild(this.graphsSp),this.sprite.addChild(this._grahsSpClone),window.gsp=this.graphsSp}},{key:"initInduce",value:function(){var n=this;this.induce=new Rect({id:"induce",context:{width:0,height:0,fillStyle:"#000000",globalAlpha:0}}),this.sprite.addChild(this.induce);var e=!1,t=null,a=n.app.canvax.domView.style.cursor,s=null,r=0;this.induce.on(_mmvis.event.types.get(),function(i){n.status.transform.enabled&&("mousedown"==i.type&&(n.induce.toFront(),e=!0,t=i.point,n.app.canvax.domView.style.cursor="move"),"mouseup"!=i.type&&"mouseout"!=i.type||(n.induce.toBack(),e=!1,t=null,n.app.canvax.domView.style.cursor=a),"mousemove"==i.type&&e&&(n.graphsSp.context.x+=i.point.x-t.x,n.graphsSp.context.y+=i.point.y-t.y,t=i.point),"wheel"==i.type&&(Math.abs(i.deltaY)>Math.abs(r)&&(r=i.deltaY),s=s||setTimeout(function(){var e=i.deltaY/30*.02;Math.abs(e)<.04&&(e=.04*Math.sign(e)),.08<Math.abs(e)&&(e=.08*Math.sign(e));var t=n.status.transform.scale+e;t<=.1&&(t=.1),1<=t&&(t=1);var a=i.target.localToGlobal(i.point);n.scale(t,a),s=null,r=0},32),i.preventDefault()))})}},{key:"scale",value:function(){}},{key:"draw",value:function(e){e=e||{},_mmvis._.extend(!0,this,e),this.data=e.data||this._initData(),"dagre"==this.layout?this.dagreLayout(this.data):"tree"==this.layout?this.treeLayout(this.data):_mmvis._.isFunction(this.layout)&&this.layout(this.data),this.widget(),this.sprite.context.x=this.origin.x,this.sprite.context.y=this.origin.y,"autoZoom"==this.status.transform.fitView&&(this.sprite.context.scaleX=this.width/this.data.size.width,this.sprite.context.scaleY=this.height/this.data.size.height);var t=(this.width-this.data.size.width)/2;t<0&&(t=0),this.graphsSp.context.x=t,this._grahsSpClone.context.x=t}},{key:"_initData",value:function(){var e={nodes:[],edges:[],size:{width:0,height:0}},t=this.app._data;(0,_data.checkDataIsJson)(t,this.field,this.childrenField)?(this.jsonData=(0,_data.jsonToArrayForRelation)(t,this,this.childrenField),this.dataFrame=this.app.dataFrame=(0,_mmvis.dataFrame)(this.jsonData)):"tree"==this.layout&&(this.jsonData=(0,_data.arrayToTreeJsonForRelation)(this.app.dataFrame.jsonOrg,this));for(var a={},i=0;i<this.dataFrame.length;i++){var n=this.dataFrame.getRowDataAt(i),s=_mmvis._.flatten([(n[this.field]+"").split(",")]),r=this._getContent(n),l={type:"relation",iNode:i,rowData:n,key:1==s.length?s[0]:s,content:r,ctype:this._checkHtml(r)?"html":"canvas",element:null,width:null,height:null,x:null,y:null,shapeType:null,source:null,target:null};_mmvis._.extend(l,this._getElementAndSize(l)),1==s.length?(l.shapeType=this.getProp(this.node.shapeType,l),e.nodes.push(l),a[l.key]=l):(l.shapeType=this.getProp(this.line.shapeType,l),e.edges.push(l))}return _mmvis._.each(e.edges,function(e){var t=e.key;e.source=a[t[0]],e.target=a[t[1]]}),e}},{key:"dagreLayout",value:function(e){var t=_mmvis.global.layout.dagre,a=new t.graphlib.Graph;return a.setGraph(this.layoutOpts.graph),a.setDefaultEdgeLabel(function(){return{}}),_mmvis._.each(e.nodes,function(e){a.setNode(e.key,e)}),_mmvis._.each(e.edges,function(e){a.setEdge.apply(a,(0,_toConsumableArray2.default)(e.key).concat([e]))}),t.layout(a),e.size.width=a.graph().width,e.size.height=a.graph().height,e}},{key:"treeLayout",value:function(){var e=_mmvis.global.layout.tree().separation(function(e,t){return(e.width+t.width)/2+10}),t=e.nodes(this.jsonData[0]).reverse();e.links(t)}},{key:"widget",value:function(){var r=this;_mmvis._.each(this.data.edges,function(e){r.line.isTree&&r._setTreePoints(e);var t=r.getProp(r.line.lineWidth,e),a=r.getProp(r.line.strokeStyle,e),i=new Path({context:{path:r._getPathStr(e,r.line.inflectionRadius),lineWidth:t,strokeStyle:a}}),n=e.points.slice(-2,-1)[0];if("bezier"==r.line.shapeType&&("TB"!=r.rankdir&&"BT"!=r.rankdir||(n.x+=(e.source.x-e.target.x)/20),"LR"!=r.rankdir&&"RL"!=r.rankdir||(n.y+=(e.source.y-e.target.y)/20)),r.edgesSp.addChild(i),r.line.arrow){var s=new Arrow({context:{control:n,point:e.points.slice(-1)[0],strokeStyle:a}});r.edgesSp.addChild(s)}}),_mmvis._.each(this.data.nodes,function(t){var a=new Rect({context:{x:t.x-t.width/2,y:t.y-t.height/2,width:t.width,height:t.height,lineWidth:1,fillStyle:r.getProp(r.node.fillStyle,t),strokeStyle:r.getProp(r.node.strokeStyle,t),radius:_mmvis._.flatten([r.getProp(r.node.radius,t)])}});a.nodeData=t,r.nodesSp.addChild(a),a.on(_mmvis.event.types.get(),function(e){e.eventInfo={trigger:r.node,nodes:[this.nodeData]},r.app.fire(e.type,e)}),"canvas"==t.ctype&&(t.element.context.x=t.x-t.width/2,t.element.context.y=t.y-t.height/2,r.nodesSp.addChild(t.element)),"html"==t.ctype&&a.on("transform",function(){var e="undefined"!=typeof window?window.devicePixelRatio:1;t.element.style.transform="matrix("+a.worldTransform.clone().scale(1/e,1/e).toArray().join()+")",t.element.style.transformOrigin="left top",t.element.style.marginLeft=r.getProp(r.node.padding,t)*r.status.transform.scale+"px",t.element.style.marginTop=r.getProp(r.node.padding,t)*r.status.transform.scale+"px",t.element.style.visibility="visible"})}),this.induce.context.width=this.width,this.induce.context.height=this.height}},{key:"_setTreePoints",value:function(e){var t=e.points;"TB"!=this.rankdir&&"BT"!=this.rankdir||(t[0]={x:e.source.x,y:e.source.y+("BT"==this.rankdir?-1:1)*e.source.height/2},t.splice(1,0,{x:e.source.x,y:t.slice(-2,-1)[0].y})),"LR"!=this.rankdir&&"RL"!=this.rankdir||(t[0]={x:e.source.x+("RL"==this.rankdir?-1:1)*e.source.width/2,y:e.source.y},t.splice(1,0,{x:t.slice(-2,-1)[0].x,y:e.source.y})),e.points=t}},{key:"_getPathStr",value:function(e,h){var u=e.points,t=u[0],a=u.slice(-1)[0],p="M"+t.x+" "+t.y;return"bezier"==e.shapeType&&(3==u.length&&(p+=",Q"+u[1].x+" "+u[1].y+" "+a.x+" "+a.y),4==u.length&&(p+=",C"+u[1].x+" "+u[1].y+" "+u[2].x+" "+u[2].y+" "+a.x+" "+a.y)),"brokenLine"==e.shapeType&&_mmvis._.each(u,function(a,e){if(e)if(h&&e<u.length-1){var t=u[e-1],i=u[e+1],n=h,s=Math.max(Math.abs(t.x-a.x)/2,Math.abs(t.y-a.y)/2),r=Math.max(Math.abs(i.x-a.x)/2,Math.abs(i.y-a.y)/2);if(n=_mmvis._.min([n,s,r]),a.x==t.x&&a.y==t.y||a.x==i.x&&a.y==i.y||Math.atan2(a.y-t.y,a.x-t.x)==Math.atan2(i.y-a.y,i.x-a.x))return;var l=function(e){var t=Math.atan2(e.y-a.y,e.x-a.x);return{x:a.x+n*Math.cos(t),y:a.y+n*Math.sin(t)}},o=l(t),d=l(i);p+=",L"+o.x+" "+o.y+",Q"+a.x+" "+a.y+" "+d.x+" "+d.y}else p+=",L"+a.x+" "+a.y}),p}},{key:"_checkHtml",value:function(e){return/<[^>]+>/g.test(e)}},{key:"_getContent",value:function(e){var t;return this._isField(this.node.content.field)&&(t=e[this.node.content.field]),this.node.content.format&&_mmvis._.isFunction(this.node.content.format)&&(t=this.node.content.format.apply(this,[t,e])),t}},{key:"_isField",value:function(e){return~this.dataFrame.fields.indexOf(e)}},{key:"_getElementAndSize",value:function(e){var t=e.ctype;return this._isField(t)&&(t=e.rowData[t]),"canvas"==(t=t||"canvas")?this._getEleAndsetCanvasSize(e):"html"==t?this._getEleAndsetHtmlSize(e):void 0}},{key:"_getEleAndsetCanvasSize",value:function(e){var t=this,a=e.content,i=e.rowData.width,n=e.rowData.height,s=new _canvax.default.Display.Sprite({}),r=new _canvax.default.Display.Text(a,{context:{fillStyle:t.getProp(t.node.content.fontColor,e),textAlign:t.getProp(t.node.content.textAlign,e),textBaseline:t.getProp(t.node.content.textBaseline,e)}});return i=i||r.getTextWidth()+t.getProp(t.node.padding,e)*t.status.transform.scale*2,n=n||r.getTextHeight()+t.getProp(t.node.padding,e)*t.status.transform.scale*2,s.addChild(r),s.context.width=parseInt(i),s.context.height=parseInt(n),r.context.x=parseInt(i/2),r.context.y=parseInt(n/2),{element:s,width:i,height:n}}},{key:"_getEleAndsetHtmlSize",value:function(e){var t=this,a=e.content,i=e.rowData.width,n=e.rowData.height,s=document.createElement("div");return s.className="chartx_relation_node",s.style.cssText+="; position:absolute;visibility:hidden;",s.style.cssText+="; color:"+t.getProp(t.node.content.fontColor,e)+";",s.style.cssText+="; text-align:"+t.getProp(t.node.content.textAlign,e)+";",s.style.cssText+="; vertical-align:"+t.getProp(t.node.content.textBaseline,e)+";",s.innerHTML=a,this.domContainer.appendChild(s),{element:s,width:i=i||s.offsetWidth+t.getProp(t.node.padding,e)*t.status.transform.scale*2,height:n=n||s.offsetHeight+t.getProp(t.node.padding,e)*t.status.transform.scale*2}}},{key:"getNodesAt",value:function(){}},{key:"getProp",value:function(e,t){var a=e;return this._isField(e)?a=t.rowData[e]:(_mmvis._.isArray(e)&&(a=e[t.iNode]),_mmvis._.isFunction(e)&&(a=e.apply(this,[t]))),a}}]),n}(_index.default);_mmvis.global.registerComponent(Relation,"graphs","relation");var _default=Relation;exports.default=_default;