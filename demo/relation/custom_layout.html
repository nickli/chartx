<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport"
        content="user-scalable=no, width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1, maximum-scale=1" />
    <title>xChart demo -- bar</title>

    <script type="text/javascript" src="../../lib/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="../../dist/chartx.js"></script>
    <!-- codemirror -->
    <script type="text/javascript" src="../../lib/codemirror/codemirror.js"></script>
    <script type="text/javascript" src="../../lib/codemirror/active-line.js"></script>
    <script type="text/javascript" src="../../lib/codemirror/javascript.js"></script>
    <script type="text/javascript" src="../../lib/codemirror/matchbrackets.js"></script>
    <link rel="stylesheet" href="../../lib/codemirror/codemirror.css">
    <link rel="stylesheet" href="../../lib/codemirror/zenburn.css">
    <link rel="stylesheet" href="../../lib/codemirror/docs.css">
    <!-- codemirror end -->
    <!--bootstrap-->
    <script type="text/javascript" src="../../lib/bootstrap/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="../../lib/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="../../lib/bootstrap/css/docs.min.css">
    <link rel="stylesheet" href="../../lib/bootstrap/css/bootstrap.min.css">
    <!--bootstrap end-->
    <script type="text/javascript" src="../../lib/demo.js"></script>
    <link rel="stylesheet" href="../../lib/demo.css">
</head>

<body>

    <table>
        <tr>
            <td id="td-vl">
                <form><textarea id="code" name="code">

//chart的数据格式，xChart中所有的图表数据格式都是这样的二维数组，
//第一行是表头。

var data = [
    { key: 1       , label: '首页',  nodeType:'page'    },
    { key: 2       , label: '计划管理页面', nodeType:'page'    },
    { key: 3       , label: '新建计划' , nodeType:'page'    },
    { key: 4       , label: '新建'  , nodeType:'action' },
    { key: 5       , label: '编辑草稿'  , nodeType:'action'   },
    { key: 6       , label: '点击菜单'   , nodeType:'action'  },
    { key: 7       , label: '修改计划'    , nodeType:'action' },
    { key: 8       , label: '下一步'    , nodeType:'action' },
    { key: 9       , label: '查看计划列表'   , nodeType:'action'  },
    { key: 10      , label: '<div style="width:50px;height:50px;background:red;">切换横向列表</div>'  , nodeType:'action'},
    { key: 11      , label: '保存'   , nodeType:'action'  },

    { key: 12       , label: '账户',  nodeType:'page'    },
    { key: 13       , label: '报表', nodeType:'page'    },
    { key: 14       , label: '创意' , nodeType:'page'    },
    
    { key: [13,14]  },
    
    { key: [1,2]  },
    
    { key: [1,6]  },
    { key: [2,9]    },
    { key: [9,10]    },
    { key: [3,4]    },
    { key: [4,5]    },
    { key: [5,7]  },
    { key: [7,8]    },
    { key: [8,11]   },
    { key: [3,12]  },
    { key: [12,13]  },
    { key: [2,3]  },
   
];

var options = {
    graphs : {
        type     : "relation",
        field    : "key",
        node : {
            content : {
                field : "label",
                type : "ctype"
            }
        },
    
        layout      : function(data) {
            var layoutOpts = this.layoutOpts && this.layoutOpts || {};
    layoutOpts.nodesep = layoutOpts.nodesep || 50;
    layoutOpts.ranksep = layoutOpts.ranksep || 50;

    var customOps = this.layoutOpts && this.layoutOpts.customOps || {
        nodeTypeField: 'nodeType',
        nodeType: {
            pageKey: 'page',    //页面节点
            actionKey: 'action'  //行为节点 
        }
    }
    var pageKey = customOps.nodeType.pageKey,
        actionKey = customOps.nodeType.actionKey,
        nodeTypeField = customOps.nodeTypeField;
    var pages = [], actions = [], nodeMap = {};
    var pagesChains = [], pagesChainsMap = {}, tempPages = [];
    var actionChains = [], actionChainsMap = {};
    var Chains = function (nodeStart, nodeEnd, edge, weight) {
        this.from = nodeStart;
        this.to = nodeEnd;
        this.edge = edge;
        this.weight = weight;
        this.actions = [];
        this.addAction = function (action) {
            this.actions.push(action)
        }
        this.getActions = function () {
            return this.actions
        }
        this.getIndex = function (index) {
            return this.actions[index];
        }
        this.isExsit = function (action) {
            var result = false;
            for (var t = 0, len = this.actions.length; t < len; t++) {
                if (this.actions[t] === action) {
                    result = true;
                    break;
                }
            }
            return result;
        }

    };

    if (layoutOpts.customOps) {
        if (layoutOpts.customOps.nodeType) {
            pageKey = layoutOpts.customOps.nodeType.pageKey || 'page';
            actionKey = layoutOpts.customOps.nodeType.actionKey || 'action';
        }
        nodeTypeField = layoutOpts.customOps.nodeTypeField || 'nodeType'
    }

    for (var i = 0, len = data.nodes.length; i < len; i++) {
        var node = data.nodes[i];
        if (node[nodeTypeField] === pageKey) {
            pages.push(node);
        }
        if (node[nodeTypeField] === actionKey) {
            actions.push(node);
        }
        nodeMap[node.key] = node;
    }
    //按照页面的连线顺序整理页面NODE
    for (var t = 0; t < 2; t++) {
        for (var i = 0, len = data.edges.length; i < len; i++) {
            var edge = data.edges[i];
            var nodeStart = nodeMap[edge.key[0]];
            var nodeEnd = nodeMap[edge.key[1]];
            if (nodeStart && nodeEnd) {
                if (nodeStart[nodeTypeField] === pageKey && nodeEnd[nodeTypeField] === pageKey) {
                    if (!pagesChainsMap[nodeStart.key] && !pagesChainsMap[nodeEnd.key]) {
                        pagesChainsMap[nodeStart.key] = new Chains(nodeStart, nodeEnd, edge, 0);
                        pagesChainsMap[nodeEnd.key] = new Chains(nodeStart, nodeEnd, edge, 1);
                    } else if (pagesChainsMap[nodeStart.key]) {
                        pagesChainsMap[nodeEnd.key] = new Chains(nodeStart, nodeEnd, edge, pagesChainsMap[nodeStart.key].weight + 1);

                    } else if (pagesChainsMap[nodeEnd.key]) {
                        pagesChainsMap[nodeStart.key] = new Chains(nodeStart, nodeEnd, edge, pagesChainsMap[nodeStart.key].weight - 1);
                    }
                }

            }
        }
    }

    for (var key in pagesChainsMap) {
        var node = pagesChainsMap[key];
        tempPages.push(node);
    }

    tempPages.sort(function (a, b) {
        return a.weight < b.weight;
    });

    for (var i = 0, len = tempPages.length; i < len; i++) {
        var nodes = tempPages[i];

        if (i === 0) {
            pagesChains.push(nodes.from, nodes.to);
        } else {
            if (pagesChains.indexOf(nodes.to) == -1) {
                pagesChains.push(nodes.to);
            }
        }
    }

    //整理每个页面对应的行为链
    for (var i = 0, len = data.edges.length; i < len; i++) {
        var edge = data.edges[i];
        var nodeStart = nodeMap[edge.key[0]];
        var nodeEnd = nodeMap[edge.key[1]];
        if (nodeStart && nodeEnd) {
            if (nodeStart[nodeTypeField] === pageKey && nodeEnd[nodeTypeField] === actionKey) {
                if (!actionChainsMap[nodeStart.key]) {
                    actionChainsMap[nodeStart.key] = new Chains(nodeStart, nodeEnd, edge, 0);
                    actionChainsMap[nodeStart.key].addAction(
                        nodeEnd
                    );
                }
            }
        }
    }
    for (var key in actionChainsMap) {
        var chains = actionChainsMap[key];
        var isFind = true;
        var key = chains.to.key;
        while (isFind) {
            var results = [];
            for (var i = 0, len = data.edges.length; i < len; i++) {
                var edge = data.edges[i];
                var nodeStart = nodeMap[edge.key[0]];
                var nodeEnd = nodeMap[edge.key[1]];
                if (key === nodeStart.key && !chains.isExsit(nodeEnd)) {
                    chains.addAction(nodeEnd)
                    key = nodeEnd.key;
                } else {
                    results.push(false);
                }
            }
            if (results.length === len) {
                isFind = false;
            }
        }
    }
    //开始计算位置
    var maxHeight = 0;
    //第一行页面
    for (var i = 0, len = pagesChains.length; i < len; i++) {
        var node = pagesChains[i];
        maxHeight = Math.max(maxHeight, (node.height || 0));
    }
    for (var i = 0, len = pagesChains.length; i < len; i++) {
        var node = pagesChains[i];
        node.y = (maxHeight - (node.height || 0)) * 0.5
    }
    data.size.height += maxHeight;
    //每一列的宽带
    var maxWidth = [];
    for (var i = 0, len = pagesChains.length; i < len; i++) {
        var node = pagesChains[i];
        var actionMap = actionChainsMap[node.key];
        var list = actionMap ? actionChainsMap[node.key].getActions() : [];
        list.unshift(node);

        for (var m = 0, ml = list.length; m < ml; m++) {
            var node = list[m];
            maxWidth[i] = Math.max((maxWidth[i] || 0), (node.width || 0));
        }
        var distance = 0;
        for (var b = 0; b < maxWidth.length - 1; b++) {
            distance += maxWidth[b];
        }
        debugger
        for (var m = 0, ml = list.length; m < ml; m++) {
            var node = list[m];
            node.x = distance + (maxWidth[i] - (node.width || 0)) * 0.5 + i * layoutOpts.nodesep
        }
        data.size.width += maxWidth[i] + layoutOpts.nodesep;
    }
    //每一行出第一行
    var actionChainsMax = 0;
    var maxHeight = [data.size.height];
    for (var key in actionChainsMap) {
        var actionChain = actionChainsMap[key];
        actionChainsMax = Math.max(actionChain.getActions().length);
    }
    for (var i = 1, ilen = actionChainsMax; i < ilen; i++) {
        var list = [];
        for (var j = 0, len = pagesChains.length; j < len; j++) {
            var node = pagesChains[j];
            var actionMap = actionChainsMap[node.key];
            var actionNode = actionMap ? actionMap.getIndex(i) : null
            if (actionNode) {
                list.push(actionNode)
            }
        }

        for (var a = 0, alen = list.length; a < alen; a++) {
            var node = list[a];
            maxHeight[i] = Math.max((maxHeight[i] || 0), (node.height || 0));
        }

        var distance = 0;
        for (var b = 0; b < maxHeight.length - 1; b++) {
            distance += maxHeight[b];
        }

        for (var a = 0, len = list.length; a < len; a++) {
            var node = list[a];
            node.y = distance + (maxHeight[i] - (node.height || 0)) * 0.5 + i * layoutOpts.ranksep
        }
        if (list.length > 0) {
            data.size.height += maxHeight[i] + layoutOpts.ranksep;
        }

    }

    //edge points 位置
    for (var i = 0, len = data.edges.length; i < len; i++) {
        var edge = data.edges[i];
        var nodeStart = nodeMap[edge.key[0]];
        var nodeEnd = nodeMap[edge.key[1]];
        var start, control, end;
        edge.points = [];
        if (nodeStart[nodeTypeField] === pageKey && nodeEnd[nodeTypeField] === pageKey) {
            //画横向箭头
            start = {
                x: nodeStart.x + nodeStart.width,
                y: nodeStart.y + nodeStart.height * 0.5
            };
            end = {
                x: nodeEnd.x,
                y: nodeEnd.y + nodeEnd.height * 0.5
            };
            control = {
                x: (start.x + end.x) * 0.5,
                y: (start.y + end.y) * 0.5,
            }
        } else {
            //画纵向箭头
            start = {
                x: nodeStart.x + nodeStart.width * 0.5,
                y: nodeStart.y + nodeStart.height
            };
            end = {
                x: nodeEnd.x + nodeEnd.width * 0.5,
                y: nodeEnd.y
            };
            control = {
                x: (start.x + end.x) * 0.5,
                y: (start.y + end.y) * 0.5,
            }
        }
        edge.points.push(
            start,
            control,
            end
        )

    }
            console.log(data);
            return data;
        },
        layoutOpts  : {
           
            nodesep: 50,//同级node之间的距离
            ranksep: 50, //排与排之间的距离
            customOps:{
                nodeTypeField:'nodeType',
                nodeType:{
                    pageKey:'page',    //页面节点
                    actionKey:'action'  //行为节点 
                }  
            }
           
        }
        //如果完全可视化编辑器编辑出来的布局，就不需要layout算法，编辑器会保存一份layout数据
        //layoutData : null 
    },
    miniMap : {},
    tips    : {}
};

window.bar = Chartx.create("canvasTest" , data , options)

            </textarea></form>
            </td>
            <td style="padding:0 10px;" id="td-vr">
                <div id="chartdemo-r">
                    <div class="bs-callout bs-callout-warning" style="margin-top:10px;"
                        id="callout-navs-anchor-disabled">
                        <span id="run" class="glyphicon glyphicon-play-circle" title="run"></span>

                        <h4>柱状图（bar chart）</h4>
                        <p>
                            联系人：@释剑
                        </p>
                    </div>
                    <div class="test-c">
                        <div id="canvasTest" style='width:800px;height:800px;position:relative;'></div>
                    </div>

                </div>
            </td>
        </tr>
    </table>


</body>

</html>