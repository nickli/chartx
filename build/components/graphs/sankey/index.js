define("components/graphs/sankey/index",["canvax","../index","../../../layout/sankey/index"],function(t,e,i){"use strict";var n,a=this&&this.__extends||(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});e.__esModule=!0;var o=t("canvax"),l=t("../index"),s=t("../../../layout/sankey/index"),d=o.default._,r=o.default.Shapes.Path,h=o.default.Shapes.Rect,p=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.type="sankey",n.keyField=null,n.valueField="value",n.parentField=null,n.node={width:18,padding:10,fillStyle:null,fillAlpha:1,blurAlpha:.4,focus:{enabled:!0,lineAlpha:1}},n.line={strokeStyle:"blue",lineWidth:1,lineAlpha:1,blurAlpha:.4,focus:{enabled:!0,lineAlpha:1}},n.label={fontColor:"#666",fontSize:12,align:"left",verticalAlign:"middle",position:"right",offsetX:0,offsetY:0},d.extend(!0,n,e),n.init(),n}return a(e,t),e.prototype.init=function(){this.sprite=new o.default.Display.Sprite,this._links=new o.default.Display.Sprite,this._nodes=new o.default.Display.Sprite,this._labels=new o.default.Display.Sprite,this.sprite.addChild(this._links),this.sprite.addChild(this._nodes),this.sprite.addChild(this._labels)},e.prototype.draw=function(t){!t&&(t={}),d.extend(!0,this,t),this.data=this._trimGraphs(),this._widget(),this.sprite.context.x=this.origin.x,this.sprite.context.y=this.origin.y,this.fire("complete")},e.prototype._trimGraphs=function(){var t=this,e=[],i=[],n=t.dataFrame.getFieldData(t.keyField),a=t.dataFrame.getFieldData(t.valueField),o=t.dataFrame.getFieldData(t.parentField),l={};return d.each(n,function(i,n){var a=[];t.parentField&&a.push(o[n]),a=a.concat(i.split(/[,|]/)),d.each(a,function(t){void 0===l[t]&&(l[t]=e.length,e.push({name:t}))})}),d.each(n,function(e,n){var s=[];t.parentField&&s.push(o[n]),2==(s=s.concat(e.split(/[,|]/))).length&&i.push({source:l[s[0]],target:l[s[1]],value:a[n]})}),s.default().nodeWidth(this.node.width).nodePadding(this.node.padding).size([this.width,this.height]).nodes(e).links(i).layout(16)},e.prototype._widget=function(){this._drawNodes(),this._drawLinks(),this._drawLabels()},e.prototype._getColor=function(t,e,i){var n=t;return d.isArray(n)&&(n=n[i]),d.isFunction(n)&&(n=n(e)),n||(n=this.root.getTheme(i)),n},e.prototype._drawNodes=function(){var t=this.data.nodes(),e=this;d.each(t,function(t,i){var n=e._getColor(e.node.fillStyle,t,i),a=new h({xyToInt:!1,context:{x:t.x,y:t.y,width:e.data.nodeWidth(),height:Math.max(t.dy,1),fillStyle:n}});a.data=t,e._nodes.addChild(a)})},e.prototype._drawLinks=function(){var t=this.data.links(),e=this;d.each(t,function(t,i){var n=e._getColor(e.line.strokeStyle,t,i),a=e.data.link()(t),o=new r({xyToInt:!1,context:{path:a,fillStyle:n,globalAlpha:.3,cursor:"pointer"}});o.link=t,o.on("mousedown mouseup panstart mouseover panmove mousemove panend mouseout tap click dblclick",function(t){"mouseover"==t.type&&(this.context.globalAlpha+=.2),"mouseout"==t.type&&(this.context.globalAlpha-=.2);var i=this.link;t.eventInfo={title:i.source.name+" --<span style='position:relative;top:-0.5px;font-size:16px;left:-3px;'>></span> "+i.target.name,nodes:[i]},e.root.fire(t.type,t),e.triggerEvent(e.node,t)}),e._links.addChild(o)})},e.prototype._drawLabels=function(){var t=this.data.nodes(),e=this;d.each(t,function(t){var i=e.label.align,n=t.x+e.data.nodeWidth()+4,a=t.y+Math.max(t.dy/2,1),l=new o.default.Display.Text(t.name,{context:{x:n,y:a,fillStyle:e.label.fontColor,fontSize:e.label.fontSize,textAlign:i,textBaseline:e.label.verticalAlign}});e._labels.addChild(l),l.getTextWidth()+n>e.width&&(l.context.x=t.x-4,l.context.textAlign="right")})},e}(l.default);e.default=p});