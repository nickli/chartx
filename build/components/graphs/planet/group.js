define("components/graphs/planet/group",["canvax"],function(t,e,i){"use strict";e.__esModule=!0;var n=t("canvax"),a=n.default._,o=(n.default.Display.Text,n.default.Shapes.Circle),s=function(){function t(t,e,i){this._opt=t,this.dataFrame=e,this._graphs=i,this.root=i.root,this._coord=this.root._coord,this.field=null,this.iGroup=0,this.groupLen=1,this.rRange={start:0,to:0},this.width=0,this.height=0,this.node={shapeType:"circle",maxR:30,minR:5,lineWidth:1,strokeStyle:"#fff",fillStyle:"#f2fbfb",lineAlpha:.6,radius:15,focus:{enabled:!0,lineAlpha:.7,lineWidth:2,strokeStyle:"#fff"},select:{enabled:!1,lineAlpha:1,lineWidth:2,strokeStyle:"#fff",triggerEventType:"click"}},this.label={enabled:!0,fontColor:"#666",fontSize:13,align:"center",verticalAlign:"middle",position:"center",offsetX:0,offsetY:0},this.sort="desc",this.sortField=null,this.layoutType="radian",this.pit={radius:30},this.planets=[],this.maxRingNum=0,this.ringNum=0,a.extend(!0,this,t),this.node.maxR>this.pit.radius&&(this.pit.radius=this.node.maxR),this.init()}return t.prototype.init=function(){this.sprite=new n.default.Display.Sprite({id:"group_"+this.iGroup,context:{x:this._coord.origin.x,y:this._coord.origin.y}}),this._trimGraphs(),this.draw()},t.prototype._trimGraphs=function(){var t=this;(this._coord.maxR-this.rRange.to)/(2*this.pit.radius)<this.groupLen-1-this.iGroup&&(this.rRange.to=this._coord.maxR-(this.groupLen-1-this.iGroup)*this.pit.radius*2),this.rRange.to-this.rRange.start<2*this.pit.radius&&(this.rRange.to=this.rRange.start+2*this.pit.radius),this.maxRingNum||(this.maxRingNum=parseInt((this.rRange.to-this.rRange.start)/(2*this.pit.radius),10),this.ringNum=this.maxRingNum),this.rRange.to=this.rRange.start+this.ringNum*this.pit.radius*2;for(var e=[],i=this.dataFrame.length,n=0;n<i;n++){var o=this.dataFrame.getRowData(n),s={groupLen:this.groupLen,iGroup:t.iGroup,iNode:n,node:null,rowData:o,iRing:null,iPlanet:null,fillStyle:null,color:null,strokeStyle:null,pit:null,ringInd:-1,field:t.field,label:o[t.field],focused:!1,selected:!!~a.indexOf(this.selectInds,o.__index__)};e.push(s)}t.sortField&&(e=e.sort(function(e,i){var n=t.sortField;return"desc"==t.sort?i.rowData[n]-e.rowData[n]:e.rowData[n]-i.rowData[n]}),a.each(e,function(t,e){t.iNode=e})),this._rings=this["_setRings_"+this.layoutType+"Range"](e),this.planets=e},t.prototype._setRings_radianRange=function(t){for(var e=this,i=[],n=0,o=this.ringNum;n<o;n++){var s=n*this.pit.radius*2+this.pit.radius+this.rRange.start;e._graphs.center.enabled||(s=n*this.pit.radius*2+this.rRange.start);var r=this._coord.getRadiansAtR(s,e.width,e.height);Math.atan(this.pit.radius/s);i.push({arcs:r,pits:[],planets:[],radius:s,max:0})}var l=0;a.each(i,function(t,i){var n=2*Math.asin(e.pit.radius/t.radius);0==t.radius&&(n=2*Math.PI);var o=0;a.each(t.arcs,function(i){var a=e._getDiffRadian(i[0].radian,i[1].radian);if(a>=n){var s=parseInt(a/n,10);o+=s;for(var r=0;r<s;r++){var l={hasRadish:!1,start:(i[0].radian+n*r+2*Math.PI)%(2*Math.PI)};l.middle=(l.start+n/2+2*Math.PI)%(2*Math.PI),l.to=(l.start+n+2*Math.PI)%(2*Math.PI),t.pits.push(l)}}}),t.max=o,l+=o,t.pits=a.shuffle(t.pits)});var h=0;return a.each(i,function(e,n){if(h>=t.length)return!1;var o=Math.ceil(e.max/l*t.length);o=Math.min(e.max,o),e.planets=t.slice(h,h+o),n==i.length-1&&(e.planets=t.slice(h)),h+=o,a.each(e.planets,function(t,i){if(!(i>=e.pits.length)){var n=a.filter(e.pits,function(t){return!t.hasRadish}),o=n[parseInt(Math.random()*n.length)];o.hasRadish=!0,t.pit=o}})}),i},t.prototype._getDiffRadian=function(t,e){var i=e-t;return e<t&&(i=(e+2*Math.PI-t)%(2*Math.PI)),i},t.prototype._setRings_indexRange=function(t){},t.prototype._setRings_valRange=function(t){},t.prototype.draw=function(){var t=this;a.each(this._rings,function(e,i){var s={rotation:0};1==e.arcs.length&&0==e.arcs[0][0].radian&&e.arcs[0][1].radian==2*Math.PI&&(s.rotation=parseInt(360*Math.random()));var r=new n.default.Display.Sprite({context:s});a.each(e.planets,function(l,h){if(l.pit){var d=t._coord.getPointInRadianOfR(l.pit.middle,e.radius),p=t._getRProp(t.node.radius,i,h,l),u=t.node.maxR-p,c=parseInt(Math.random()*u),f=parseInt(360*Math.random())*Math.PI/180;0!=c&&(d.x+=Math.sin(f)*c,d.y+=Math.cos(f)*c);var g=t.node;l.selected&&(g=t.node.select);var _=t._getProp(t.node.fillStyle,l),m=t._getProp(g.strokeStyle,l),x=t._getProp(g.lineAlpha,l),y=t._getProp(g.lineWidth,l),v={x:d.x,y:d.y,r:p,fillStyle:_,lineWidth:y,strokeStyle:m,lineAlpha:x,cursor:"pointer"};l.color=l.fillStyle=_,l.strokeStyle=m,l.iRing=i,l.iPlanet=h;var R=new o({hoverClone:!1,context:v});R.on("mousedown mouseup panstart mouseover panmove mousemove panend mouseout tap click dblclick",function(e){e.eventInfo={title:null,nodes:[this.nodeData]},this.nodeData.label&&(e.eventInfo.title=this.nodeData.label),t.node.focus.enabled&&("mouseover"==e.type&&t.focusAt(this.nodeData),"mouseout"==e.type&&t.unfocusAt(this.nodeData)),t.root.fire(e.type,e),t.node.select.enabled&&e.type==t.node.select.triggerEventType&&(this.nodeData.selected?t.unselectAt(this.nodeData):t.selectAt(this.nodeData)),t._graphs.triggerEvent(t.node,e)}),R.nodeData=l,l.nodeElement=R,R.ringInd=i,R.planetIndInRing=h,r.addChild(R);var P={x:d.x,y:d.y,fontSize:t.label.fontSize,textAlign:t.label.align,textBaseline:t.label.verticalAlign,fillStyle:t.label.fontColor,rotation:-s.rotation,rotateOrigin:{x:0,y:0}},b=new n.default.Display.Text(l.label,{context:P}),M=b.getTextWidth(),A=b.getTextHeight();if(M>2*p&&(P.fontSize=t.label.fontSize-3),a.isFunction(t.label.position)){var I=t.label.position({node:R,circleR:p,circleCenter:{x:d.x,y:d.y},textWidth:M,textHeight:A});P.rotation=-s.rotation,P.rotateOrigin={x:-(I.x-P.x),y:-(I.y-P.y)},P.x=I.x,P.y=I.y}"auto"==t.label.position&&M>2*p&&D(),"bottom"==t.label.position&&D(),P.x+=t.label.offsetX,P.y+=t.label.offsetY,b=new n.default.Display.Text(l.label,{context:P}),R.labelElement=b,b.nodeData=l,l.labelElement=b,r.addChild(b)}function D(){P.y=d.y+p+3,P.rotation=-s.rotation,P.rotateOrigin={x:0,y:-(p+.7*A)}}}),t.sprite.addChild(r)})},t.prototype._getRProp=function(t,e,i,n){var o=this;if(a.isString(t)&&a.indexOf(o.dataFrame.fields,t)>-1){void 0==this.__rValMax&&void 0==this.__rValMax&&(this.__rValMax=0,this.__rValMin=0,a.each(o.planets,function(e){o.__rValMax=Math.max(o.__rValMax,e.rowData[t]),o.__rValMin=Math.min(o.__rValMin,e.rowData[t])}));var s=n.rowData[t];return o.node.minR+(s-this.__rValMin)/(this.__rValMax-this.__rValMin)*(o.node.maxR-o.node.minR)}return o._getProp(t,n)},t.prototype._getProp=function(t,e){var i=this.iGroup;return a.isFunction(t)?t.apply(this,[e,i]):t},t.prototype.getPlanetAt=function(t){var e=t;return a.isNumber(t)&&a.each(this.planets,function(i){if(i.rowData.__index__==t)return e=i,!1}),e},t.prototype.selectAt=function(t){if(this.node.select.enabled){var e=this.getPlanetAt(t);e.selected=!0,e.nodeElement&&(e.nodeElement.context.lineWidth=this._getProp(this.node.select.lineWidth,e),e.nodeElement.context.strokeStyle=this._getProp(this.node.select.strokeStyle,e),e.nodeElement.context.lineAlpha=this._getProp(this.node.select.lineAlpha,e));for(var i=0;i<this.selectInds.length;i++)if(t===this.selectInds[i]){this.selectInds.splice(i--,1);break}}},t.prototype.unselectAt=function(t){if(this.node.select.enabled){var e=this.getPlanetAt(t);e.selected=!1,e.nodeElement&&(e.nodeElement.context.lineWidth=this._getProp(this.node.lineWidth,e),e.nodeElement.context.lineAlpha=this._getProp(this.node.lineAlpha,e)),this.selectInds.push(t)}},t.prototype.getSelectedNodes=function(){return a.filter(this.planets,function(t){return t.selected})},t.prototype.focusAt=function(t){if(this.node.focus.enabled){var e=this.getPlanetAt(t);e.selected||(e.focused=!0,e.nodeElement&&(e.nodeElement.context.lineWidth=this._getProp(this.node.focus.lineWidth,e),e.nodeElement.context.strokeStyle=this._getProp(this.node.focus.strokeStyle,e),e.nodeElement.context.lineAlpha=this._getProp(this.node.focus.lineAlpha,e)))}},t.prototype.unfocusAt=function(t){if(this.node.focus.enabled){var e=this.getPlanetAt(t);e.selected||(e.focused=!1,e.nodeElement&&(e.nodeElement.context.lineWidth=this._getProp(this.node.lineWidth,e),e.nodeElement.context.lineAlpha=this._getProp(this.node.lineAlpha,e)))}},t}();e.default=s});