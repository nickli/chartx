define("components/graphs/bar/index",["canvax","../../../utils/tools","../index"],function(t,e,i){"use strict";var a,n=this&&this.__extends||(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},function(t,e){function i(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});e.__esModule=!0;var l=t("canvax"),o=t("../../../utils/tools"),r=t("../index"),d=l.default.AnimationFrame,s=(l.default.Shapes.BrokenLine,l.default.Shapes.Rect),f=l.default._,p=function(t){function e(e,i){var a=t.call(this,e,i)||this;return a.type="bar",a.field=null,a.enabledField=null,a.yAxisAlign="left",a._xAxis=a.root._coord._xAxis,a.absolute=!1,a.proportion=!1,a.node={shapeType:"rect",width:0,_width:0,maxWidth:50,minWidth:1,minHeight:0,radius:3,fillStyle:null,fillAlpha:.95,_count:0,xDis:null,filter:null},a.label={enabled:!1,animation:!0,fontColor:null,fontSize:12,format:null,lineWidth:0,strokeStyle:null,rotation:0,align:"center",verticalAlign:"bottom",position:"top",offsetX:0,offsetY:0},a.select={enabled:!1,alpha:.2,fillStyle:null,_fillStyle:"#092848",triggerEventType:"click",width:1,inds:[]},a._barsLen=0,a.txtsSp=null,f.extend(!0,a,e),a.init(),a}return n(e,t),e.prototype.init=function(){this.sprite=new l.default.Display.Sprite({id:"graphsEl"}),this.barsSp=new l.default.Display.Sprite({id:"barsSp"}),this.txtsSp=new l.default.Display.Sprite({id:"txtsSp",context:{}})},e.prototype.getNodesAt=function(t){var e=this.data,i=[];return f.each(this.enabledField,function(a,n){if(f.isArray(a))f.each(a,function(a,n){var l=e[a]?e[a][t]:null;l&&i.push(l)});else{var l=e[a]?e[a][t]:null;l&&i.push(l)}}),i},e.prototype._getTargetField=function(t,e,i,a){if(f.isString(a))return a;if(f.isArray(a)){var n=a[t];if(f.isString(n))return n;if(f.isArray(n))return n[e]}},e.prototype._getColor=function(t,e,i){e.value;var a,n=e.field,l=this.root._coord.getFieldMapOf(n);return f.isString(t)&&(a=t),f.isArray(t)&&(a=f.flatten(t)[f.indexOf(i,n)]),f.isFunction(t)&&(a=t.apply(this,[e])),void 0!==a&&null!==a||(a=l.color),a},e.prototype._getBarWidth=function(t,e){return this.node.width?f.isFunction(this.node.width)?this.node._width=this.node.width(t):this.node._width=this.node.width:(this.node._width=e-Math.max(1,.2*e),1==this.node._width&&t>3&&(this.node._width=t-2)),this.node._width<1&&(this.node._width=1),this.node._width=parseInt(this.node._width),this.node._width>this.node.maxWidth&&(this.node._width=this.node.maxWidth),this.node._width},e.prototype.show=function(t){this.draw()},e.prototype.hide=function(t){f.each(this.barsSp.children,function(e,i){var a=e.getChildById("bar_"+i+"_"+t);a&&a.destroy()}),f.each(this.txtsSp.children,function(e,i){var a=e.getChildById("text_"+i+"_"+t);a&&a.destroy()}),this.draw()},e.prototype.resetData=function(t,e){this.dataFrame=t,this.draw()},e.prototype.clean=function(){this.data={},this.barsSp.removeAllChildren(),this.label.enabled&&this.txtsSp.removeAllChildren()},e.prototype.draw=function(t){!t&&(t={}),f.extend(!0,this,t);var e=this,i=e.animation&&!t.resize;if(this.data=this._trimGraphs(),0==this.enabledField.length||0==this._dataLen)return e._preDataLen=0,void this.clean();var a=e._preDataLen,n=this.enabledField.length,r=0;e.node._count=0;var d=f.flatten([this.field]);f.each(this.enabledField,function(t,h){var p=(t=f.flatten([t])).length;if(0!=p){r=e.width/e._dataLen,e._barsLen=e._dataLen*n;for(var u=0;u<e._dataLen;u++){var c=null;if(0==h){var y;u<=a-1?c=e.barsSp.getChildById("barGroup_"+u):(c=new l.default.Display.Sprite({id:"barGroup_"+u}),e.barsSp.addChild(c),c.iNode=u);var g=r*e.select.width;e.select.width>1&&(g=e.select.width),u<=a-1?((y=c.getChildById("group_region_"+u)).context.width=g,y.context.x=r*u+(r-g)/2):(y=new s({id:"group_region_"+u,pointChkPriority:!1,hoverClone:!1,xyToInt:!1,context:{x:r*u+(r-g)/2,y:-e.height,width:g,height:e.height,fillStyle:e._getGroupRegionStyle(u),globalAlpha:f.indexOf(e.select.inds,e.dataFrame.range.start+u)>-1?e.select.alpha:0}}),c.addChild(y),y.iNode=u,y.on("mousedown mouseup panstart mouseover panmove mousemove panend mouseout tap click dblclick",function(t){if(t.eventInfo={iNode:this.iNode},e.root.fire(t.type,t),e.select.enabled&&t.type==e.select.triggerEventType){var i=e.dataFrame.range.start+this.iNode;f.indexOf(e.select.inds,i)>-1?e.unselectAt(i):e.selectAt(i)}e.triggerEvent(e,t)}))}else c=e.barsSp.getChildById("barGroup_"+u);var x=null;0==h?u<=a-1?x=e.txtsSp.getChildById("txtGroup_"+u):(x=new l.default.Display.Sprite({id:"txtGroup_"+u}),e.txtsSp.addChild(x),x.iGroup=h):x=e.txtsSp.getChildById("txtGroup_"+u);for(var _=0;_<p;_++){e.node._count++;var b=e.data[t[_]][u];b.iGroup=h,b.iNode=u,b.iLay=_;var v=e._getColor(e.node.fillStyle,b,d);b.color=v;var w=b.y-b.fromY;isNaN(w)?w=0:Math.abs(w)<e.node.minHeight&&(w=e.node.minHeight);var S={x:Math.round(b.x),y:b.fromY,width:e.node._width,height:w,fillStyle:v,fillAlpha:e.node.fillAlpha,scaleY:-1};b.width=S.width;var m={x:S.x,y:b.yBasePoint.y,width:S.width,height:S.height,fillStyle:S.fillStyle,fillAlpha:e.node.fillAlpha,scaleY:0};if(e.node.radius&&b.isLeaf&&!e.proportion){var A=Math.min(e.node._width/2,Math.abs(w));A=Math.min(A,e.node.radius),m.radius=[A,A,0,0]}i||(delete m.scaleY,m.y=S.y);var F=null,C="bar_"+u+"_"+b.field;if(u<=a-1&&(F=c.getChildById(C)),F?F.context.fillStyle=v:((F=new s({id:C,context:m})).field=b.field,c.addChild(F)),F.finalPos=S,F.iGroup=h,F.iNode=u,F.iLay=_,F.nodeData=b,b.nodeElement=F,e.node.filter&&e.node.filter.apply(F,[b,e]),e.label.enabled){var L=b.value;if(f.isFunction(e.label.format)){var B=e.label.format(L,b);void 0===B&&null===B||(L=B)}if(void 0===L||null===L||""===L)continue;f.isNumber(L)&&(L=o.numAddSymbol(L));var D={fillStyle:e.label.fontColor||S.fillStyle,fontSize:e.label.fontSize,lineWidth:e.label.lineWidth,strokeStyle:e.label.strokeStyle||S.fillStyle,textBaseline:e.label.verticalAlign,rotation:e.label.rotation},P=e._getTextPos(S,b);D.x=P.x,D.y=P.y,D.textAlign=e._getTextAlign(S,b);var I=null,T="text_"+u+"_"+b.field;u<=a-1&&(I=x.getChildById(T)),I?(I.resetText(L),I.context.x=D.x,I.context.y=D.y):((I=new l.default.Display.Text(L,{id:T,context:D})).field=b.field,x.addChild(I))}}}}}),this.sprite.addChild(this.barsSp),this.label.enabled&&this.sprite.addChild(this.txtsSp),this.sprite.context.x=this.origin.x,this.sprite.context.y=this.origin.y,this.grow(function(){e.fire("complete")},{delay:0,duration:300,animate:i}),e._preDataLen=e._dataLen},e.prototype.setEnabledField=function(){this.enabledField=this.root._coord.getEnabledFields(this.field)},e.prototype._getGroupRegionStyle=function(t){var e=this,i=e.select.fillStyle;return f.isArray(e.select.fillStyle)&&(i=e.select.fillStyle[h]),f.isFunction(e.select.fillStyle)&&(i=e.select.fillStyle.apply(this,[{iNode:t,rowData:e.dataFrame.getRowData(t)}])),void 0===i||null===i?e.select._fillStyle:i},e.prototype._trimGraphs=function(){var t=this,e=this._xAxis,i=this.root._coord;this.setEnabledField(),this.data={};var a=[],n=0,l=0,o=!1;this.absolute?(a=[this],n=this.enabledField.length):f.each(this.root._graphs,function(e){e.absolute||"bar"!=e.type||(e===t&&(o=!0),o?e.setEnabledField():l+=e.enabledField.length,n+=e.enabledField.length,a.push(e))});var r=e.ceilWidth,d=r/(n+1),s=this._getBarWidth(r,d),h=d-s;null!=this.node.xDis&&(h=this.node.xDis);var p=(r-s*n-h*(n-1))/2;l&&(p+=(h+s)*l);var u="left"==this.yAxisAlign?i._yAxisLeft:i._yAxisRight,c=this.dataFrame.getDataOrg(this.enabledField);return f.each(c,function(a,n){var l=[];f.each(a,function(o,d){l[d]=[],t._dataLen=o.length,f.each(o,function(o,c){var y=o;t.proportion&&(y=0,f.each(a,function(t,e){y+=t[c]}));var g=e.getPosX({ind:c,dataLen:t._dataLen,layoutType:i?i.xAxis.layoutType:t.root._xAxis.layoutType}),x=g-r/2+p+(s+h)*n,_=0;_=t.proportion?-o/y*u.height:u.getYposFromVal(o);var b=function t(e,i,a,n,l,o){var r=e[i-1];if(!r)return o.y;var d=r[a].y,s=r[a].value,h=o.value;return n>=h?s>=h?(r[a].isLeaf=!1,d):t(e,i-1,a,n,l,o):s<h?(r[a].isLeaf=!1,d):t(e,i-1,a,n,l,o)}(l,d,c,o,_,u.basePoint);_+=b-u.basePoint.y;var v={type:"bar",value:o,vInd:d,vCount:y,field:t._getTargetField(n,d,c,t.enabledField),fromX:x,fromY:b,x:x,y:_,width:s,yBasePoint:u.basePoint,isLeaf:!0,xAxis:e.getNodeInfoOfX(g),iNode:c,rowData:t.dataFrame.getRowData(c),color:null};t.data[v.field]||(t.data[v.field]=l[d]),l[d].push(v)})})}),t.data},e.prototype._getTextAlign=function(t,e){var i=this.label.align;return e.value<e.yBasePoint.value&&("left"==i?i="right":"right"==i&&(i="left")),i},e.prototype._getTextPos=function(t,e){var i={x:0,y:0},a=t.x,n=t.y;switch(this.label.position){case"top":a=t.x+t.width/2,n=t.y+t.height;break;case"topRight":a=t.x+t.width,n=t.y+t.height;break;case"right":a=t.x+t.width,n=t.y+t.height/2;break;case"rightBottom":a=t.x+t.width,n=t.y;break;case"bottom":a=t.x+t.width/2,n=t.y;break;case"bottomLeft":a=t.x,n=t.y;break;case"left":a=t.x,n=t.y+t.height/2;break;case"leftTop":a=t.x,n=t.y+t.height;break;case"center":a=t.x+t.width/2,n=t.y+t.height/2}a-=this.label.offsetX;var l=1;return e.value<e.yBasePoint.value&&(l=-1),n-=l*this.label.offsetY,i.x=a,i.y=n,i},e.prototype.grow=function(t,e){var i=this;if(i._preDataLen>i._dataLen)for(var a=i._dataLen,n=i._preDataLen;a<n;a++)i.barsSp.getChildAt(a).destroy(),i.label.enabled&&i.txtsSp.getChildAt(a).destroy(),a--,n--;if(e.animate){var l=f.extend({delay:Math.min(1e3/this._barsLen,80),easing:"Linear.None",duration:500},e),o=0;f.each(i.enabledField,function(e,a){var n=(e=f.flatten([e])).length;if(0!=n)for(var r=0;r<i._dataLen;r++)for(var s=0;s<n;s++){var h=i.data[e[s]][r],p=i.barsSp.getChildById("barGroup_"+r).getChildById("bar_"+r+"_"+h.field);0==l.duration?(p.context.scaleY=1,p.context.y=1*p.finalPos.y,p.context.x=p.finalPos.x,p.context.width=p.finalPos.width,p.context.height=p.finalPos.height):(p._tweenObj&&d.destroyTween(p._tweenObj),p._tweenObj=p.animate({scaleY:1,y:1*p.finalPos.y,x:p.finalPos.x,width:p.finalPos.width,height:p.finalPos.height},{duration:l.duration,easing:l.easing,delay:r*l.delay,onUpdate:function(t){},onComplete:function(e){e.width<3&&this.context&&(this.context.radius=0),++o===i.node._count&&t&&t(i)},id:p.id}))}})}else t&&t(i)},e.prototype.selectAt=function(t){if(!(f.indexOf(this.select.inds,t)>-1)){this.select.inds.push(t);var e=t-this.dataFrame.range.start,i=this.barsSp.getChildById("barGroup_"+e);if(i){var a=i.getChildById("group_region_"+e);a&&(a.context.globalAlpha=this.select.alpha)}}},e.prototype.unselectAt=function(t){if(-1!=f.indexOf(this.select.inds,t)){var e=f.indexOf(this.select.inds,t);this.select.inds.splice(e,1);var i=t-this.dataFrame.range.start,a=this.barsSp.getChildById("barGroup_"+i);if(a){var n=a.getChildById("group_region_"+i);n&&(n.context.globalAlpha=0)}}},e.prototype.getSelectedRowList=function(){var t=[],e=this;return f.each(e.select.inds,function(i){var a=i-e.dataFrame.range.start;t.push(e.dataFrame.getRowData(a))}),t},e}(r.default);e.default=p});