define("components/legend/index",["../component","canvax"],function(t,e,n){"use strict";var i,o=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});e.__esModule=!0;var d=t("../component"),l=t("canvax"),a=l.default.Shapes.Circle,r=l.default._,c=function(t){function e(e,n,i){var o=t.call(this)||this;return o.root=i,o.data=e||[],o.width=0,o.height=0,o.field=null,o.icon={height:26,width:"auto",shapeType:"circle",radius:5,lineWidth:1,fillStyle:"#999",onChecked:function(){},onUnChecked:function(){}},o.label={textAlign:"left",textBaseline:"middle",fillStyle:"#333",cursor:"pointer",format:function(t,e){return t}},o._labelColor="#999",o.position="top",o.hv="h",o.sprite=null,n&&(r.extend(!0,o,n),!n.hv&&n.position&&("left"==o.position||"right"==o.position?o.hv="v":o.hv="h")),o.sprite=new l.default.Display.Sprite({id:"LegendSprite"}),o._draw(),o}return o(e,t),e.register=function(t,e){var n=r.extend(!0,{icon:{onChecked:function(t){e.show(t.name,t),e.componentsReset({name:"legend"})},onUnChecked:function(t){e.hide(t.name,t),e.componentsReset({name:"legend"})}}},t),i=t.data;i?(r.each(i,function(t,e){t.enabled=!0,t.ind=e}),delete t.data):i=e.getLegendData();var o=new this(i,n,e);"h"==o.hv?e.padding[o.position]+=o.height:e.padding[o.position]+=o.width,e._coord&&"rect"==e._coord.type&&("top"!=o.position&&"bottom"!=o.position||e.components.push({type:"once",plug:{draw:function(){o.pos({x:e._coord.getSizeAndOrigin().origin.x})}}}));var d={x:e.width-e.padding.right,y:e.padding.top};"left"==o.position&&(d.x=e.padding.left-o.width),"top"==o.position&&(d.x=e.padding.left,d.y=e.padding.top-o.height),"bottom"==o.position&&(d.x=e.padding.left,d.y=e.height-e.padding.bottom+13),o.pos(d),e.components.push({type:"legend",plug:o}),e.stage.addChild(o.sprite)},e.prototype.pos=function(t){t.x&&(this.sprite.context.x=t.x+this.icon.radius),t.y&&(this.sprite.context.y=t.y)},e.prototype.draw=function(){},e.prototype._draw=function(){var t=this,e=this.root.width-this.root.padding.left-this.root.padding.right,n=this.root.height-this.root.padding.top-this.root.padding.bottom,i=0,o=0,d=0,c=0,h=0,p=1,s=!1;r.each(this.data,function(f,u){if(!s){var g=new a({id:"legend_field_icon_"+u,context:{x:0,y:t.icon.height/3,fillStyle:f.enabled?f.color||t._labelColor:"#ccc",r:t.icon.radius,cursor:"pointer"}});g.hover(function(e){e.eventInfo=t._getInfoHandler(e,f)},function(t){delete t.eventInfo}),g.on("mousemove",function(e){e.eventInfo=t._getInfoHandler(e,f)}),g.on("click",function(){});var x=new l.default.Display.Text(t.label.format(f.name,f),{id:"legend_field_txt_"+u,context:{x:t.icon.radius+3,y:t.icon.height/3,textAlign:t.label.textAlign,textBaseline:t.label.textBaseline,fillStyle:t.label.fillStyle,cursor:t.label.cursor}});x.hover(function(e){e.eventInfo=t._getInfoHandler(e,f)},function(t){delete t.eventInfo}),x.on("mousemove",function(e){e.eventInfo=t._getInfoHandler(e,f)}),x.on("click",function(){});var v=x.getTextWidth()+2*t.icon.radius+20;i=Math.max(i,v);var y={height:t.icon.height};if("v"==t.hv){if(h+t.icon.height>n){if(c>.3*e)return void(s=!0);c+=i,h=0}y.x=c,y.y=h,h+=t.icon.height,d=Math.max(d,h)}else{if(c+v>e){if(t.icon.height*(p+1)>.3*n)return void(s=!0);o=Math.max(o,c),c=0,p++}y.x=c,y.y=t.icon.height*(p-1),c+=v}var _=new l.default.Display.Sprite({id:"legend_field_"+u,context:y});_.addChild(g),_.addChild(x),_.context.width=v,t.sprite.addChild(_),_.on("click",function(e){1==r.filter(t.data,function(t){return t.enabled}).length&&f.enabled||(f.enabled=!f.enabled,g.context.fillStyle=f.enabled?f.color||t._labelColor:"#ccc",f.enabled?t.icon.onChecked(f):t.icon.onUnChecked(f))})}}),"h"==this.hv?(t.width=t.sprite.context.width=o,t.height=t.sprite.context.height=t.icon.height*p):(t.width=t.sprite.context.width=c+i,t.height=t.sprite.context.height=d)},e.prototype._getInfoHandler=function(t,e){return{type:"legend",nodes:[{name:e.name,fillStyle:e.color}]}},e}(d.default);e.default=c});