self.define=function(a,b,c){c.apply(self)},importScripts("physics/atoms.js"),importScripts("physics/barnes-hut.js"),importScripts("physics/physics.js");var _={each:function(a,b){if(_.isArray(a))for(var c=0,d=a.length;d>c;c++)b(a[c],c);else for(var e in a)b(a[e],e)},map:function(a,b){var c=[];return $.each(a,function(a,d){var e=b(d,a);void 0!==e&&c.push(e)}),c},isArray:function(a){return-1!=a.constructor.toString().indexOf("Array")},inArray:function(a,b){for(var c=0,d=b.length;d>c;c++)if(b[c]===a)return c;return-1}},PhysicsWorker=function(){var a=20,b=null,c=null,d=null,e=((new Date).valueOf(),{init:function(a){return e.timeout(a.timeout),b=Physics(a.dt,a.stiffness,a.repulsion,a.friction,e.tock),e},timeout:function(b){b!=a&&(a=b,null!==c&&(e.stop(),e.go()))},go:function(){null===c&&(d=null,c=setInterval(e.tick,a))},stop:function(){postMessage({type:"stopping"}),null!==c&&(clearInterval(c),c=null)},tick:function(){b.tick();var a=b.systemEnergy();(a.mean+a.max)/2<1?(e.stop(),null===d&&(d=(new Date).valueOf())):d=null},tock:function(a){a.type="geometry",postMessage(a)},modifyNode:function(a,c){b.modifyNode(a,c),e.go()},modifyPhysics:function(a){b.modifyPhysics(a)},update:function(a){b._update(a)}});return e},physics=PhysicsWorker();onmessage=function(a){if(!a.data.type)return void postMessage("kernel?");if("physics"==a.data.type){var b=a.data.physics;return void physics.init(a.data.physics)}switch(a.data.type){case"modify":physics.modifyNode(a.data.id,a.data.mods);break;case"changes":physics.update(a.data.changes),physics.go();break;case"start":physics.go();break;case"stop":physics.stop();break;case"sys":var b=a.data.param||{};isNaN(b.timeout)||physics.timeout(b.timeout),physics.modifyPhysics(b),physics.go()}};